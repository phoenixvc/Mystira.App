@{
    ViewData["Title"] = "Character Media Metadata Management";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2>Character Media Metadata Management</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h5>Character Overview</h5>
                            <div id="overview-status" class="alert alert-info">
                                Loading overview...
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Current Metadata Status</h5>
                            <div id="metadata-status" class="alert alert-info">
                                Loading metadata...
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Actions</h5>
                            <div class="btn-group-vertical d-grid gap-2" role="group">
                                <button type="button" class="btn btn-primary" onclick="loadAllData()">
                                    <i class="fas fa-refresh"></i> Refresh All
                                </button>
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importModal">
                                    <i class="fas fa-upload"></i> Import JSON/YAML
                                </button>
                                <button type="button" class="btn btn-info" onclick="exportMetadata('json')">
                                    <i class="fas fa-download"></i> Export JSON
                                </button>
                                <button type="button" class="btn btn-info" onclick="exportMetadata('yaml')">
                                    <i class="fas fa-download"></i> Export YAML
                                </button>
                                <button type="button" class="btn btn-warning" onclick="createMissingMetadata()">
                                    <i class="fas fa-plus"></i> Create Missing Metadata
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <ul class="nav nav-tabs" id="metadataTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-content" type="button" role="tab">
                                        All Characters
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="with-metadata-tab" data-bs-toggle="tab" data-bs-target="#with-metadata-content" type="button" role="tab">
                                        With Metadata
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="missing-metadata-tab" data-bs-toggle="tab" data-bs-target="#missing-metadata-content" type="button" role="tab">
                                        Missing Metadata
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="tab-content" id="metadataTabContent">
                                <!-- All Characters Tab -->
                                <div class="tab-pane fade show active" id="all-content" role="tabpanel">
                                    <h5>All Characters</h5>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="allCharactersSearch" placeholder="Search characters by ID, name...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="all-characters-table">
                                            <thead>
                                                <tr>
                                                    <th>Character ID</th>
                                                    <th>Name</th>
                                                    <th>Archetypes</th>
                                                    <th>Species</th>
                                                    <th>Has Metadata</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="all-characters-tbody">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- With Metadata Tab -->
                                <div class="tab-pane fade" id="with-metadata-content" role="tabpanel">
                                    <h5>Characters with Metadata</h5>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="withMetadataSearch" placeholder="Search metadata by ID, title, tags...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="with-metadata-table">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Title</th>
                                                    <th>Type</th>
                                                    <th>Age Rating</th>
                                                    <th>Tags</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="with-metadata-tbody">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Missing Metadata Tab -->
                                <div class="tab-pane fade" id="missing-metadata-content" role="tabpanel">
                                    <h5>Characters Missing Metadata</h5>
                                    <div class="mb-3 d-flex gap-2">
                                        <input type="text" class="form-control" id="missingMetadataSearch" placeholder="Search missing metadata by ID, name...">
                                        <button type="button" class="btn btn-warning" onclick="bulkCreateMissingMetadata()">
                                            <i class="fas fa-plus"></i> Create All Missing
                                        </button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="missing-metadata-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllMissing" onchange="toggleSelectAllMissing()">
                                                    </th>
                                                    <th>Character ID</th>
                                                    <th>Name</th>
                                                    <th>Archetypes</th>
                                                    <th>Species</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="missing-metadata-tbody">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Character Media Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm">
                    <div class="mb-3">
                        <label for="importFormat" class="form-label">Import Format</label>
                        <select class="form-control" id="importFormat" onchange="updateImportFormat()">
                            <option value="json">JSON</option>
                            <option value="yaml">YAML</option>
                            <option value="file">Upload File</option>
                        </select>
                    </div>
                    <div class="mb-3" id="textImportSection">
                        <label for="metadataText" class="form-label">Character Media Metadata JSON/YAML</label>
                        <textarea class="form-control" id="metadataText" rows="10" placeholder="Paste JSON or YAML data here..."></textarea>
                    </div>
                    <div class="mb-3 d-none" id="fileImportSection">
                        <label for="metadataFile" class="form-label">Upload Metadata File</label>
                        <input type="file" class="form-control" id="metadataFile" accept=".json,.yaml,.yml">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="overwriteExisting" name="overwriteExisting">
                            <label class="form-check-label" for="overwriteExisting">
                                Overwrite existing entries
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importMetadata()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Character Media Metadata Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editEntryId" />
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editFileName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="editFileName" required readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editType" class="form-label">Type</label>
                        <select class="form-control" id="editType" required>
                            <option value="image">Image</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAgeRating" class="form-label">Age Rating</label>
                        <input type="text" class="form-control" id="editAgeRating" value="E">
                    </div>
                    <div class="mb-3">
                        <label for="editTags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="editTags">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editLoopable">
                            <label class="form-check-label" for="editLoopable">
                                Loopable
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Metadata Modal -->
<div class="modal fade" id="createMetadataModal" tabindex="-1" aria-labelledby="createMetadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createMetadataModalLabel">Create Character Media Metadata Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <input type="hidden" id="createCharacterId" />
                    <div class="mb-3">
                        <label for="createTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="createTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="createFileName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="createFileName" required readonly>
                    </div>
                    <div class="mb-3">
                        <label for="createType" class="form-label">Type</label>
                        <select class="form-control" id="createType" required>
                            <option value="image">Image</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createAgeRating" class="form-label">Age Rating</label>
                        <input type="text" class="form-control" id="createAgeRating" value="E">
                    </div>
                    <div class="mb-3">
                        <label for="createTags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="createTags">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createLoopable">
                            <label class="form-check-label" for="createLoopable">
                                Loopable
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewEntry()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMetadata = null;
let allCharacters = [];
let missingMetadataCharacters = [];

// Load all data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});

async function loadAllData() {
    await Promise.all([
        loadMetadata(),
        loadCharacters()
    ]);
    updateOverviewStatus();
    renderAllTables();
}

async function loadMetadata() {
    try {
        const response = await fetch('/api/charactermediametadata');
        const data = await response.json();
        currentMetadata = data;
        
        document.getElementById('metadata-status').innerHTML = 
            `<strong>Metadata Entries:</strong> ${data.entries.length} | <strong>Version:</strong> ${data.version} | <strong>Updated:</strong> ${new Date(data.updatedAt).toLocaleString()}`;
        
    } catch (error) {
        console.error('Error loading metadata:', error);
        document.getElementById('metadata-status').innerHTML = 
            '<span class="text-danger">Error loading metadata</span>';
    }
}

async function loadCharacters() {
    try {
        const response = await fetch('/api/admin/CharacterMapsAdmin');
        const data = await response.json();
        allCharacters = data.characters || [];
        
        // Find missing metadata
        const metadataIds = new Set(currentMetadata?.entries?.map(e => e.id) || []);
        missingMetadataCharacters = allCharacters.filter(character => !metadataIds.has(character.id));
        
    } catch (error) {
        console.error('Error loading characters:', error);
        allCharacters = [];
        missingMetadataCharacters = [];
    }
}

function updateOverviewStatus() {
    const totalCharacters = allCharacters.length;
    const totalMetadata = currentMetadata?.entries?.length || 0;
    const missing = missingMetadataCharacters.length;
    const withMetadata = totalCharacters - missing;
    
    document.getElementById('overview-status').innerHTML = `
        <strong>Total Characters:</strong> ${totalCharacters}<br>
        <strong>With Metadata:</strong> ${withMetadata}<br>
        <strong>Missing Metadata:</strong> ${missing}
    `;
}

function renderAllTables() {
    renderAllCharactersTable();
    renderWithMetadataTable();
    renderMissingMetadataTable();
}

function renderAllCharactersTable() {
    const tbody = document.getElementById('all-characters-tbody');
    if (allCharacters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No characters found</td></tr>';
        return;
    }
    
    const metadataIds = new Set(currentMetadata?.entries?.map(e => e.id) || []);
    
    tbody.innerHTML = allCharacters.map(character => `
        <tr>
            <td>${character.id}</td>
            <td>${character.name}</td>
            <td>${character.metadata?.archetypes?.join(', ') || '-'}</td>
            <td>${character.metadata?.species || '-'}</td>
            <td>
                ${metadataIds.has(character.id) 
                    ? '<span class="badge bg-success">Yes</span>' 
                    : '<span class="badge bg-warning">No</span>'}
            </td>
            <td>
                ${metadataIds.has(character.id)
                    ? `<button class="btn btn-sm btn-outline-primary" onclick="editEntry('${character.id}')">
                         <i class="fas fa-edit"></i>
                       </button>`
                    : `<button class="btn btn-sm btn-outline-success" onclick="createEntry('${character.id}')">
                         <i class="fas fa-plus"></i>
                       </button>`
                }
            </td>
        </tr>
    `).join('');
}

function renderWithMetadataTable() {
    const tbody = document.getElementById('with-metadata-tbody');
    const entries = currentMetadata?.entries || [];
    
    if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No metadata entries found</td></tr>';
        return;
    }
    
    tbody.innerHTML = entries.map(entry => `
        <tr>
            <td>${entry.id}</td>
            <td>${entry.title}</td>
            <td><span class="badge bg-primary">${entry.type}</span></td>
            <td><span class="badge bg-info">${entry.ageRating}</span></td>
            <td>${entry.tags.slice(0, 3).join(', ')}${entry.tags.length > 3 ? '...' : ''}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editEntry('${entry.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry('${entry.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderMissingMetadataTable() {
    const tbody = document.getElementById('missing-metadata-tbody');
    
    if (missingMetadataCharacters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">All characters have metadata!</td></tr>';
        return;
    }
    
    tbody.innerHTML = missingMetadataCharacters.map(character => `
        <tr>
            <td>
                <input type="checkbox" class="missing-metadata-checkbox" value="${character.id}">
            </td>
            <td>${character.id}</td>
            <td>${character.name}</td>
            <td>${character.metadata?.archetypes?.join(', ') || '-'}</td>
            <td>${character.metadata?.species || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-success" onclick="createEntry('${character.id}')">
                    <i class="fas fa-plus"></i> Create
                </button>
            </td>
        </tr>
    `).join('');
}

function createEntry(characterId) {
    const character = allCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    document.getElementById('createCharacterId').value = characterId;
    document.getElementById('createTitle').value = character.name || characterId;
    document.getElementById('createFileName').value = characterId;
    document.getElementById('createType').value = 'image';
    document.getElementById('createDescription').value = `Media for ${character.name}`;
    document.getElementById('createAgeRating').value = 'E';
    document.getElementById('createTags').value = ['character', ...(character.metadata?.archetypes || [])].join(', ');
    document.getElementById('createLoopable').checked = false;
    
    new bootstrap.Modal(document.getElementById('createMetadataModal')).show();
}

async function saveNewEntry() {
    const entry = {
        id: document.getElementById('createCharacterId').value,
        title: document.getElementById('createTitle').value,
        fileName: document.getElementById('createFileName').value,
        type: document.getElementById('createType').value,
        description: document.getElementById('createDescription').value,
        ageRating: document.getElementById('createAgeRating').value,
        tags: document.getElementById('createTags').value.split(',').map(t => t.trim()).filter(t => t),
        loopable: document.getElementById('createLoopable').checked
    };
    
    try {
        const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/entries`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(entry)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createMetadataModal')).hide();
            await loadAllData();
            showAlert('Character metadata entry created successfully', 'success');
        } else {
            const error = await response.json();
            showAlert(`Error creating entry: ${error.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error creating entry: ${error.message}`, 'danger');
    }
}

function editEntry(entryId) {
    const entry = currentMetadata.entries.find(e => e.id === entryId);
    if (!entry) return;
    
    document.getElementById('editEntryId').value = entry.id;
    document.getElementById('editTitle').value = entry.title;
    document.getElementById('editFileName').value = entry.fileName;
    document.getElementById('editType').value = entry.type;
    document.getElementById('editDescription').value = entry.description;
    document.getElementById('editAgeRating').value = entry.ageRating;
    document.getElementById('editTags').value = entry.tags.join(', ');
    document.getElementById('editLoopable').checked = entry.loopable;
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

async function saveEntry() {
    const entryId = document.getElementById('editEntryId').value;
    const entry = {
        id: entryId,
        title: document.getElementById('editTitle').value,
        fileName: document.getElementById('editFileName').value,
        type: document.getElementById('editType').value,
        description: document.getElementById('editDescription').value,
        ageRating: document.getElementById('editAgeRating').value,
        tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t),
        loopable: document.getElementById('editLoopable').checked
    };
    
    try {
        const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/${entryId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(entry)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            await loadAllData();
            showAlert('Entry updated successfully', 'success');
        } else {
            const error = await response.json();
            showAlert(`Error updating entry: ${error.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error updating entry: ${error.message}`, 'danger');
    }
}

async function deleteEntry(entryId) {
    if (!confirm('Are you sure you want to delete this entry?')) return;
    
    try {
        const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/${entryId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            await loadAllData();
            showAlert('Entry deleted successfully', 'success');
        } else {
            const error = await response.json();
            showAlert(`Error deleting entry: ${error.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error deleting entry: ${error.message}`, 'danger');
    }
}

async function createMissingMetadata() {
    if (missingMetadataCharacters.length === 0) {
        showAlert('No missing metadata found', 'info');
        return;
    }
    
    if (!confirm(`Create metadata entries for ${missingMetadataCharacters.length} missing characters?`)) return;
    
    const entries = missingMetadataCharacters.map(character => ({
        id: character.id,
        title: character.name || character.id,
        fileName: character.id,
        type: 'image',
        description: `Media for ${character.name}`,
        ageRating: 'E',
        tags: ['character', ...(character.metadata?.archetypes || [])],
        loopable: false
    }));
    
    try {
        for (const entry of entries) {
            const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/entries`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entry)
            });
            
            if (!response.ok) {
                console.error(`Failed to create metadata for ${entry.id}`);
            }
        }
        
        await loadAllData();
        showAlert(`Created metadata for ${entries.length} characters`, 'success');
    } catch (error) {
        showAlert(`Error creating metadata: ${error.message}`, 'danger');
    }
}

async function bulkCreateMissingMetadata() {
    const selected = Array.from(document.querySelectorAll('.missing-metadata-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selected.length === 0) {
        showAlert('Please select characters to create metadata for', 'warning');
        return;
    }
    
    if (!confirm(`Create metadata entries for ${selected.length} selected characters?`)) return;
    
    const entries = selected.map(characterId => {
        const character = allCharacters.find(c => c.id === characterId);
        return {
            id: characterId,
            title: character?.name || characterId,
            fileName: characterId,
            type: 'image',
            description: `Media for ${character?.name}`,
            ageRating: 'E',
            tags: ['character', ...(character?.metadata?.archetypes || [])],
            loopable: false
        };
    });
    
    try {
        for (const entry of entries) {
            const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/entries`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entry)
            });
            
            if (!response.ok) {
                console.error(`Failed to create metadata for ${entry.id}`);
            }
        }
        
        await loadAllData();
        showAlert(`Created metadata for ${entries.length} selected characters`, 'success');
    } catch (error) {
        showAlert(`Error creating metadata: ${error.message}`, 'danger');
    }
}

function toggleSelectAllMissing() {
    const selectAll = document.getElementById('selectAllMissing');
    const checkboxes = document.querySelectorAll('.missing-metadata-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });
}

function updateImportFormat() {
    const format = document.getElementById('importFormat').value;
    const textSection = document.getElementById('textImportSection');
    const fileSection = document.getElementById('fileImportSection');
    
    if (format === 'file') {
        textSection.classList.add('d-none');
        fileSection.classList.remove('d-none');
    } else {
        textSection.classList.remove('d-none');
        fileSection.classList.add('d-none');
        
        const label = document.querySelector('label[for="metadataText"]');
        if (format === 'yaml') {
            label.textContent = 'Character Media Metadata YAML';
            document.getElementById('metadataText').placeholder = 'Paste YAML data here...';
        } else {
            label.textContent = 'Character Media Metadata JSON';
            document.getElementById('metadataText').placeholder = 'Paste JSON data here...';
        }
    }
}

async function importMetadata() {
    const format = document.getElementById('importFormat').value;
    const overwriteExisting = document.getElementById('overwriteExisting').checked;
    let data = '';
    
    if (format === 'file') {
        const fileInput = document.getElementById('metadataFile');
        if (!fileInput.files.length) {
            showAlert('Please select a file to import', 'warning');
            return;
        }
        
        const file = fileInput.files[0];
        data = await file.text();
    } else {
        data = document.getElementById('metadataText').value.trim();
        if (!data) {
            showAlert('Please provide data to import', 'warning');
            return;
        }
    }
    
    try {
        let parsedData;
        
        if (format === 'yaml' || (format === 'file' && data.includes(':'))) {
            // Parse YAML using a simple YAML parser
            parsedData = parseYAML(data);
        } else {
            // Parse JSON
            parsedData = JSON.parse(data);
        }
        
        const response = await fetch(`/api/admin/CharacterMediaMetadataAdmin/import?overwriteExisting=${overwriteExisting}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: data
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            await loadAllData();
            document.getElementById('metadataText').value = '';
            document.getElementById('metadataFile').value = '';
            showAlert('Character metadata imported successfully', 'success');
        } else {
            const error = await response.json();
            showAlert(`Error importing metadata: ${error.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error importing metadata: ${error.message}`, 'danger');
    }
}

function parseYAML(yamlText) {
    // Simple YAML parser for basic structures
    const lines = yamlText.split('\n').filter(line => line.trim());
    const result = [];
    let currentEntry = null;
    
    for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('- ')) {
            // New array item
            if (currentEntry) result.push(currentEntry);
            currentEntry = {};
            const keyValue = trimmed.substring(2);
            if (keyValue.includes(':')) {
                const [key, value] = keyValue.split(':').map(s => s.trim());
                currentEntry[key] = parseValue(value);
            }
        } else if (trimmed.includes(':') && currentEntry) {
            const [key, value] = trimmed.split(':').map(s => s.trim());
            currentEntry[key] = parseValue(value);
        }
    }
    
    if (currentEntry) result.push(currentEntry);
    return result;
}

function parseValue(value) {
    if (!value) return '';
    if (value === 'true') return true;
    if (value === 'false') return false;
    if (value.startsWith('[') && value.endsWith(']')) {
        return value.slice(1, -1).split(',').map(s => s.trim());
    }
    return value;
}

function exportMetadata(format = 'json') {
    if (!currentMetadata) return;
    
    let content, mimeType, filename;
    
    if (format === 'yaml') {
        content = convertToYAML(currentMetadata.entries);
        mimeType = 'text/yaml';
        filename = 'character-media-metadata.yaml';
    } else {
        content = JSON.stringify(currentMetadata.entries, null, 2);
        mimeType = 'application/json';
        filename = 'character-media-metadata.json';
    }
    
    const dataStr = `data:${mimeType};charset=utf-8,` + encodeURIComponent(content);
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", filename);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function convertToYAML(entries) {
    let yaml = '';
    
    for (const entry of entries) {
        yaml += `- id: ${entry.id}\n`;
        yaml += `  title: ${entry.title}\n`;
        yaml += `  fileName: ${entry.fileName}\n`;
        yaml += `  type: ${entry.type}\n`;
        yaml += `  description: ${entry.description}\n`;
        yaml += `  ageRating: ${entry.ageRating}\n`;
        yaml += `  tags: [${entry.tags.join(', ')}]\n`;
        yaml += `  loopable: ${entry.loopable}\n\n`;
    }
    
    return yaml;
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
