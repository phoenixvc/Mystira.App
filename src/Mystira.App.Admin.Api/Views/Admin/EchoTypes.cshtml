@{
    ViewData["Title"] = "Echo Types Management";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Echo Types</h3>
                    <a href="/admin" class="btn btn-secondary">Back to Dashboard</a>
                </div>
                <div class="card-body">
                    <div id="errorAlert" class="alert alert-danger d-none"></div>
                    <div id="successAlert" class="alert alert-success d-none"></div>

                    <div class="row">
                        <div class="col-md-8">
                            <h5>Existing Echo Types</h5>
                            <div class="mb-3">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search echo types..." onkeyup="filterTable()">
                            </div>
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>Name</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="echoTypesTableBody">
                                        <!-- Filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-muted">
                                <span id="recordCount">0</span> echo types
                            </div>
                        </div>

                        <div class="col-md-4">
                            <h5 id="formTitle">Create / Update Echo Type</h5>
                            <form id="echoTypeForm" onsubmit="return false;">
                                <input type="hidden" id="echoTypeId" />
                                <div class="mb-3">
                                    <label for="echoTypeName" class="form-label">Name *</label>
                                    <input type="text" id="echoTypeName" class="form-control" required />
                                </div>
                                <div class="mb-3">
                                    <label for="echoTypeCategory" class="form-label">Category</label>
                                    <select id="echoTypeCategory" class="form-select">
                                        <option value="">-- Select Category --</option>
                                        <option value="moral">Moral</option>
                                        <option value="emotional">Emotional</option>
                                        <option value="behavioral">Behavioral</option>
                                        <option value="social">Social</option>
                                        <option value="cognitive">Cognitive</option>
                                        <option value="identity">Identity</option>
                                        <option value="meta">Meta</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="echoTypeDescription" class="form-label">Description</label>
                                    <textarea id="echoTypeDescription" class="form-control" rows="3"></textarea>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveEchoType()">Save</button>
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const apiBase = '/api/admin/echotypes';

    async function loadEchoTypes() {
        try {
            const res = await fetch(apiBase, { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to load echo types');
            const data = await res.json();
            const tbody = document.getElementById('echoTypesTableBody');
            tbody.innerHTML = '';
            data.forEach(echoType => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${echoType.name}</td>
                    <td><span class="badge bg-secondary">${echoType.category || 'N/A'}</span></td>
                    <td>${(echoType.description || '').substring(0, 50)}${(echoType.description || '').length > 50 ? '...' : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editEchoType(${JSON.stringify(echoType)})'>Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick='deleteEchoType("${echoType.id}")'>Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('recordCount').textContent = data.length;
        } catch (e) {
            showError(e.message);
        }
    }

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById('echoTypesTableBody');
        const rows = tbody.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;
            for (let j = 0; j < cells.length - 1; j++) {
                if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
            rows[i].style.display = found ? '' : 'none';
        }
    }

    function editEchoType(echoType) {
        document.getElementById('echoTypeId').value = echoType.id;
        document.getElementById('echoTypeName').value = echoType.name;
        document.getElementById('echoTypeCategory').value = echoType.category || '';
        document.getElementById('echoTypeDescription').value = echoType.description || '';
        document.getElementById('formTitle').textContent = 'Update Echo Type';
    }

    async function saveEchoType() {
        const id = document.getElementById('echoTypeId').value;
        const name = document.getElementById('echoTypeName').value;
        const category = document.getElementById('echoTypeCategory').value;
        const description = document.getElementById('echoTypeDescription').value;

        if (!name) {
            showError('Name is required');
            return;
        }

        const payload = { name, category, description };

        try {
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiBase}/${id}` : apiBase;
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Failed to save echo type');
            }

            showSuccess(id ? 'Echo type updated successfully' : 'Echo type created successfully');
            resetForm();
            loadEchoTypes();
        } catch (e) {
            showError(e.message);
        }
    }

    async function deleteEchoType(id) {
        if (!confirm('Are you sure you want to delete this echo type?')) return;

        try {
            const res = await fetch(`${apiBase}/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) throw new Error('Failed to delete echo type');

            showSuccess('Echo type deleted successfully');
            loadEchoTypes();
        } catch (e) {
            showError(e.message);
        }
    }

    function resetForm() {
        document.getElementById('echoTypeForm').reset();
        document.getElementById('echoTypeId').value = '';
        document.getElementById('formTitle').textContent = 'Create / Update Echo Type';
    }

    function showError(message) {
        const alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.classList.remove('d-none');
        setTimeout(() => alert.classList.add('d-none'), 5000);
    }

    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.classList.remove('d-none');
        setTimeout(() => alert.classList.add('d-none'), 5000);
    }

    // Load on page load
    loadEchoTypes();
</script>
