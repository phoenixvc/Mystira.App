@{
    ViewData["Title"] = "Content Bundles";
    // Per-request CSP nonce provided by SecurityHeadersMiddleware (prod)
    var cspNonce = Context?.Items["CspNonce"] as string;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Content Bundles</h3>
                    <a href="/admin" class="btn btn-secondary">Back to Dashboard</a>
                </div>
                <div class="card-body">
                    <div id="errorAlert" class="alert alert-danger d-none"></div>

                    <div class="row">
                        <div class="col-md-7">
                            <h5>Existing Bundles</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Age Group</th>
                                            <th>Scenarios</th>
                                            <th>Free</th>
                                            <th colspan="2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="bundlesTableBody">
                                        <!-- Filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <h5 id="formTitle">Create / Update Bundle</h5>
                            <form id="bundleForm">
                                <input type="hidden" id="bundleId" />
                                <div class="mb-3">
                                    <label for="title" class="form-label">Title</label>
                                    <input type="text" id="title" class="form-control" required />
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea id="description" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="imageId" class="form-label">Image Id (CachedMystiraImage)</label>
                                    <input type="text" id="imageId" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="ageGroup" class="form-label">Age Group (e.g., 3-5)</label>
                                    <input type="text" id="ageGroup" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="scenarioIds" class="form-label">Scenario Ids (comma-separated)</label>
                                    <input type="text" id="scenarioIds" class="form-control" />
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="isFree">
                                    <label class="form-check-label" for="isFree">Is Free</label>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" id="saveBtn" class="btn btn-primary">Save</button>
                                    <button type="button" id="resetBtn" class="btn btn-secondary">Reset</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="@cspNonce">
    const apiBase = '/api/admin/bundlesadmin';

    async function loadBundles() {
        try {
            const res = await fetch(apiBase, { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to load bundles');
            const data = await res.json();
            const tbody = document.getElementById('bundlesTableBody');
            tbody.innerHTML = '';
            data.forEach(b => {
               const tr = document.createElement('tr');

               const tdTitle = document.createElement('td');
               tdTitle.textContent = b.title || '';
               tr.appendChild(tdTitle);

               const tdAge = document.createElement('td');
               tdAge.textContent = b.ageGroup || '';
               tr.appendChild(tdAge);

               const tdScenarios = document.createElement('td');
               tdScenarios.textContent = (b.scenarioIds || []).length;
               tr.appendChild(tdScenarios);

               const tdFree = document.createElement('td');
               tdFree.textContent = b.isFree ? 'Yes' : 'No';
               tr.appendChild(tdFree);

               const tdEdit = document.createElement('td');
               const editBtn = document.createElement('button');
               editBtn.className = 'btn btn-sm btn-outline-primary';
               editBtn.type = 'button';
               editBtn.textContent = 'Edit';
               editBtn.addEventListener('click', () => editBundle(b));
               tdEdit.appendChild(editBtn);
               tr.appendChild(tdEdit);

               const tdDelete = document.createElement('td');
               const delBtn = document.createElement('button');
               delBtn.className = 'btn btn-sm btn-outline-danger';
               delBtn.type = 'button';
               delBtn.textContent = 'Delete';
               delBtn.addEventListener('click', () => deleteBundle(b.id, b.title));
               tdDelete.appendChild(delBtn);
               tr.appendChild(tdDelete);

               tbody.appendChild(tr);
            });
        } catch (e) {
            showError(e.message);
        }
    }

    function editBundle(b) {
        document.getElementById('formTitle').innerText = 'Update Bundle';
        document.getElementById('bundleId').value = b.id;
        document.getElementById('title').value = b.title || '';
        document.getElementById('description').value = b.description || '';
        document.getElementById('imageId').value = b.imageId || '';
        document.getElementById('ageGroup').value = b.ageGroup || '';
        document.getElementById('scenarioIds').value = (b.scenarioIds || []).join(',');
        document.getElementById('isFree').checked = !!b.isFree;
    }

    function resetForm() {
        document.getElementById('formTitle').innerText = 'Create / Update Bundle';
        document.getElementById('bundleForm').reset();
        document.getElementById('bundleId').value = '';
    }

    async function saveBundle() {
        const id = document.getElementById('bundleId').value.trim();
        const payload = {
            id: id,
            title: document.getElementById('title').value.trim(),
            description: document.getElementById('description').value.trim(),
            imageId: document.getElementById('imageId').value.trim(),
            ageGroup: document.getElementById('ageGroup').value.trim(),
            scenarioIds: document.getElementById('scenarioIds').value.split(',').map(s => s.trim()).filter(Boolean),
            prices: [],
            isFree: document.getElementById('isFree').checked
        };

        try {
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiBase}/${id}` : apiBase;
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.message || 'Failed to save bundle');
            }
            resetForm();
            await loadBundles();
        } catch (e) {
            showError(e.message);
        }
    }

    async function deleteBundle(bundleId, bundleTitle) {
        if (!confirm(`Are you sure you want to delete the bundle "${bundleTitle}"?`)) {
            return;
        }

        try {
            const res = await fetch(`${apiBase}/${bundleId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.message || 'Failed to delete bundle');
            }
            resetForm();
            await loadBundles();
        } catch (e) {
            showError(e.message);
        }
    }

    function showError(message) {
        const el = document.getElementById('errorAlert');
        el.textContent = message;
        el.classList.remove('d-none');
    }

    // Wire up form and actions without inline handlers (CSP-safe)
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('bundleForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            saveBundle();
        });

        const resetBtn = document.getElementById('resetBtn');
        resetBtn.addEventListener('click', () => resetForm());

        loadBundles();
    });
</script>
