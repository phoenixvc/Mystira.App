@{
    ViewData["Title"] = "Media Management";
    Layout = "_Layout";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üñºÔ∏è Media Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshMedia()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchInput" placeholder="Search media files..." onkeyup="filterMedia()">
    </div>
    <div class="col-md-6">
        <select class="form-control" id="typeFilter" onchange="filterMedia()">
            <option value="">All Types</option>
            <option value="image">Images</option>
            <option value="audio">Audio</option>
            <option value="video">Video</option>
        </select>
    </div>
</div>

<!-- Media Grid -->
<div class="row" id="mediaContainer">
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading media files...</p>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Media Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="previewContent">
                <!-- Preview content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let allMedia = [];
let filteredMedia = [];

$(document).ready(function() {
    loadMedia();
});

async function loadMedia() {
    try {
        const response = await fetch('/api/admin/mediaadmin', {
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        allMedia = data.media || [];
        filteredMedia = [...allMedia];
        displayMedia(filteredMedia);
    } catch (error) {
        console.error('Error loading media:', error);
        $('#mediaContainer').html('<div class="col-12 text-center py-5"><p class="text-danger">Error loading media files. Please check authentication.</p></div>');
    }
}

function displayMedia(mediaList) {
    let html = '';
    
    if (mediaList.length === 0) {
        html = '<div class="col-12 text-center py-5"><p class="text-muted">No media files found</p></div>';
    } else {
        mediaList.forEach(media => {
            const preview = getMediaPreview(media);
            const sizeFormatted = formatFileSize(media.fileSizeBytes);
            
            html += `
                <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-center mb-3" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                ${preview}
                            </div>
                            <h6 class="card-title">${media.mediaId}</h6>
                            <p class="card-text small text-muted">${media.description || 'No description'}</p>
                            <div class="mb-2">
                                <span class="badge bg-secondary">${media.mediaType}</span>
                                <span class="badge bg-info">${sizeFormatted}</span>
                            </div>
                            <div class="mb-2">
                                ${media.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join(' ')}
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">ID: ${media.mediaId}</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary btn-sm" onclick="previewMedia('${media.mediaId}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteMedia('${media.mediaId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    $('#mediaContainer').html(html);
}

function getMediaIcon(type) {
    switch(type) {
        case 'image': return 'fas fa-image';
        case 'audio': return 'fas fa-music';
        case 'video': return 'fas fa-video';
        default: return 'fas fa-file';
    }
}

function getMediaPreview(media) {
    if (media.mediaType === 'image') {
        // Use the URL directly from the media asset
        return `<img src="${media.url}" class="img-fluid" style="max-height: 100px; max-width: 100px; object-fit: cover;" alt="${getFileNameFromUrl(media.url)}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <i class="fas fa-image fa-3x text-muted" style="display: none;"></i>`;
    } else {
        const icon = getMediaIcon(media.mediaType);
        return `<i class="${icon} fa-3x text-muted"></i>`;
    }
}

function getFileNameFromUrl(url) {
    try {
        const urlObj = new URL(url);
        const pathname = urlObj.pathname;
        const filename = pathname.substring(pathname.lastIndexOf('/') + 1);
        // Remove the UUID prefix that Azure adds
        const match = filename.match(/^[a-f0-9-]+-(.+)$/);
        return match ? match[1] : filename;
    } catch (e) {
        return 'Unknown';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function filterMedia() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    
    filteredMedia = allMedia.filter(media => {
        const matchesSearch = !searchTerm || 
            getFileNameFromUrl(media.url).toLowerCase().includes(searchTerm) ||
            media.description?.toLowerCase().includes(searchTerm) ||
            media.mediaId.toLowerCase().includes(searchTerm) ||
            media.tags.some(tag => tag.toLowerCase().includes(searchTerm));
            
        const matchesType = !typeFilter || media.mediaType === typeFilter;
        
        return matchesSearch && matchesType;
    });
    
    displayMedia(filteredMedia);
}

async function previewMedia(mediaId) {
    try {
        const media = allMedia.find(m => m.mediaId === mediaId);
        if (!media) {
            alert('Media not found');
            return;
        }

        document.getElementById('previewModalLabel').textContent = getFileNameFromUrl(media.url);
        
        let previewHtml = '';
        const mediaUrl = media.url; // Use the URL directly
        
        switch (media.mediaType) {
            case 'image':
                previewHtml = `<img src="${mediaUrl}" class="img-fluid" alt="${getFileNameFromUrl(media.url)}" style="max-width: 100%; max-height: 400px;">`;
                break;
            case 'audio':
                previewHtml = `
                    <div class="mb-3">
                        <i class="fas fa-music fa-4x text-muted"></i>
                    </div>
                    <audio controls class="w-100">
                        <source src="${mediaUrl}" type="${media.mimeType}">
                        Your browser does not support the audio element.
                    </audio>
                `;
                break;
            case 'video':
                previewHtml = `
                    <video controls class="w-100" style="max-height: 400px;">
                        <source src="${mediaUrl}" type="${media.mimeType}">
                        Your browser does not support the video element.
                    </video>
                `;
                break;
            default:
                previewHtml = `<p>Preview not available for this file type.</p>`;
        }
        
        // Add media details
        previewHtml += `
            <div class="mt-3 text-start">
                <h6>Media Details:</h6>
                <ul class="list-unstyled">
                    <li><strong>ID:</strong> ${media.mediaId}</li>
                    <li><strong>File Name:</strong> ${getFileNameFromUrl(media.url)}</li>
                    <li><strong>Type:</strong> ${media.mediaType}</li>
                    <li><strong>Size:</strong> ${formatFileSize(media.fileSizeBytes)}</li>
                    <li><strong>Description:</strong> ${media.description || 'No description'}</li>
                    <li><strong>Tags:</strong> ${media.tags.join(', ') || 'No tags'}</li>
                </ul>
            </div>
        `;
        
        document.getElementById('previewContent').innerHTML = previewHtml;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    } catch (error) {
        console.error('Error previewing media:', error);
        alert('Error loading media preview');
    }
}

async function deleteMedia(mediaId) {
    if (!confirm('Are you sure you want to delete this media file? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/mediaadmin/${mediaId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
            }
        });
        
        if (response.ok) {
            alert('Media file deleted successfully');
            loadMedia(); // Refresh the list
        } else {
            const error = await response.json();
            alert(`Error deleting media: ${error.message || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting media:', error);
        alert('Error deleting media file');
    }
}

function refreshMedia() {
    loadMedia();
}
</script>
}