@{
    ViewData["Title"] = "Badge Images";
    // CSP nonce for inline scripts (required in production where strict CSP is enabled)
    var cspNonce = Context.Items["CspNonce"] as string;
}

<div class="container-fluid">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Badge Image Library</h1>
            <p class="text-muted mb-0">Upload new badge artwork or reuse existing assets by Image_Id. Images are stored with their binary so you can preview them inline.</p>
        </div>
        <a class="btn btn-outline-secondary" href="/admin/badges">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Badges
        </a>
    </div>

    <div class="row gy-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="h6 mb-0">Upload Badge Image</h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger d-none" id="uploadError"></div>
                    <div class="alert alert-success d-none" id="uploadSuccess"></div>
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label" for="imageIdInput">Image Id</label>
                            <input type="text" class="form-control" id="imageIdInput" placeholder="e.g. badges-3-5-curiosity-bronze" required maxlength="200">
                            <small class="text-muted">Use a descriptive, kebab-case identifier. This is what badges will reference.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="imageFileInput">Artwork File</label>
                            <input type="file" class="form-control" id="imageFileInput" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-upload me-1"></i>
                            Upload Image
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                    <h2 class="h6 mb-0">Existing Images</h2>
                    <form id="imageFilterForm" class="d-flex gap-2">
                        <input type="search" class="form-control" id="imageFilter" placeholder="Search by Image_Id">
                        <button class="btn btn-outline-primary" type="submit">Search</button>
                    </form>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle" id="imageTable">
                            <thead>
                                <tr>
                                    <th scope="col">Preview</th>
                                    <th scope="col">Image Id</th>
                                    <th scope="col">Size</th>
                                    <th scope="col" class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="imageTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">No images found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script nonce="@cspNonce">
(() => {
    const imagesApi = '/api/admin/badges/images';

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('uploadForm').addEventListener('submit', onUploadSubmit);
        document.getElementById('imageFilterForm').addEventListener('submit', evt => {
            evt.preventDefault();
            loadImages(document.getElementById('imageFilter').value.trim());
        });
        loadImages('');
    });

    async function loadImages(query) {
        const response = await fetch(`${imagesApi}?imageId=${encodeURIComponent(query || '')}`);
        if (!response.ok) {
            return;
        }
        const images = await response.json();
        renderImages(images);
    }

    function renderImages(images) {
        const tbody = document.getElementById('imageTableBody');
        if (!images.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No images match this query.</td></tr>';
            return;
        }
        tbody.innerHTML = images.map(image => `
            <tr>
                <td style="width: 110px;">
                    ${image.dataUrl ? `<img src="${image.dataUrl}" alt="${image.imageId}" class="img-fluid rounded" style="max-height: 70px;">` : '<span class="text-muted">No preview</span>'}
                </td>
                <td>
                    <div class="fw-semibold text-truncate">${image.imageId}</div>
                    <small class="text-muted">${new Date(image.updatedAt).toLocaleDateString()}</small>
                </td>
                <td>${humanFileSize(image.fileSizeBytes)}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" data-delete-id="${image.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        tbody.querySelectorAll('button[data-delete-id]').forEach(btn => btn.addEventListener('click', () => onDeleteImage(btn.dataset.deleteId)));
    }

    function humanFileSize(bytes) {
        const units = ['B', 'KB', 'MB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size.toFixed(1)} ${units[unitIndex]}`;
    }

    async function onUploadSubmit(evt) {
        evt.preventDefault();
        const form = evt.currentTarget;
        const formData = new FormData();
        const imageId = document.getElementById('imageIdInput').value.trim();
        const fileInput = document.getElementById('imageFileInput');
        if (!imageId || !fileInput.files.length) {
            return;
        }
        formData.append('imageId', imageId);
        formData.append('file', fileInput.files[0]);
        const response = await fetch(imagesApi, {
            method: 'POST',
            body: formData
        });
        const errorAlert = document.getElementById('uploadError');
        const successAlert = document.getElementById('uploadSuccess');
        if (!response.ok) {
            const error = await response.json().catch(() => ({ message: 'Upload failed' }));
            errorAlert.textContent = error.message || 'Upload failed';
            errorAlert.classList.remove('d-none');
            successAlert.classList.add('d-none');
            return;
        }
        errorAlert.classList.add('d-none');
        successAlert.textContent = 'Image uploaded successfully.';
        successAlert.classList.remove('d-none');
        form.reset();
        await loadImages(document.getElementById('imageFilter').value.trim());
    }

    async function onDeleteImage(id) {
        if (!confirm('Delete this badge image?')) {
            return;
        }
        const response = await fetch(`${imagesApi}/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (!response.ok) {
            alert('Unable to delete image.');
            return;
        }
        await loadImages(document.getElementById('imageFilter').value.trim());
    }
})();
</script>
}
