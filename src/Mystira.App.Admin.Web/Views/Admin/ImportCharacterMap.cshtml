@{
    ViewData["Title"] = "Import Character Map";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Import Character Map</h3>
                    <a href="/admin/charactermaps" class="btn btn-secondary">Back to Character Maps</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Upload Character Map YAML</h5>
                                </div>
                                <div class="card-body">
                                    <form id="characterMapForm" method="post" enctype="multipart/form-data" action="/api/admin/charactermapsadmin/import">
                                        <div class="form-group mb-3">
                                            <label for="yamlFile">Character Map YAML File</label>
                                            <input type="file" class="form-control" id="yamlFile" name="file" accept=".yaml,.yml" required>
                                            <small class="form-text text-muted">
                                                Upload a YAML file containing character map configuration
                                            </small>
                                        </div>

                                        <div class="form-group mb-3">
                                            <label for="name">Character Map Name (Optional)</label>
                                            <input type="text" class="form-control" id="name" name="name" placeholder="e.g., Fantasy Heroes">
                                            <small class="form-text text-muted">
                                                If provided, this will override the name in the YAML file
                                            </small>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" value="true" id="validateReferences" name="validateReferences" checked>
                                            <label class="form-check-label" for="validateReferences">
                                                Validate character image references
                                            </label>
                                            <small class="form-text text-muted">
                                                Checks that all image references in the character map exist in the media database
                                            </small>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" value="true" id="overwriteExisting" name="overwriteExisting">
                                            <label class="form-check-label" for="overwriteExisting">
                                                Overwrite existing character map
                                            </label>
                                            <small class="form-text text-muted">
                                                Warning: This will replace an existing character map with the same ID
                                            </small>
                                        </div>

                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-primary">Upload Character Map</button>
                                            <button type="button" class="btn btn-info" onclick="validateYamlFile()">Validate YAML</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Expected YAML Format</h5>
                                </div>
                                <div class="card-body">
                                    <pre class="small"><code>characters:
  - id: "BearMapleYoungerKids"
    name: "Maple"
    image: "image-bear-maple-younger-kids--ede14750"
    metadata:
      roles:
        - "Peacemaker"
        - "Emotion Mender"
        - "The Bridge"
        - "Justice Walker"
        - "Shield Bearer"
        - "Quiet Leader"
        - "Peace Builder"
      archetypes:
        - "The Heart Warmer"
        - "The Comfort Giver"
        - "The Listener"
        - "The Group Glue"
        - "The Quiet Strength"
        - "The Ally"
        - "The Caregiver"
      species: "bear"
      age: 8
      traits:
        - "kind-hearted"
        - "patient"
        - "gentle"
        - "responsible"
        - "fair-minded"
      backstory: >
        Maple is a young bear whose quiet strength comes not from his size, but from his immense patience and kindness.
        He moves through the world with a gentle and thoughtful nature, preferring to listen and understand rather than act rashly.
        His core belief is that a caring heart is the best guide in any situation.

  - id: "FoxJinxYoungerKids"
    name: "Jinx"
    image: "image-fox-jinx-younger-kids-bf9d103d"
    metadata:
      roles:
        - "Bold Striker"
        - "Risk Taker"
        - "The First to Try"
        - "Rescue Helper"
        - "Truth Teller"
      archetypes:
        - "The Brave Buddy"
        - "The Explorer"
        - "The Trickster"
        - "The Chase Champion"
        - "The Hero"
      species: "fox"
      age: 7
      traits:
        - "brave"
        - "impulsive"
        - "energetic"
        - "confident"
        - "loyal"
      backstory: >
        Jinx is a bold young fox with clever eyes and a tail that's often twitching with excitement.
        He is the first to leap into a new adventure.
        He is brave, full of energy, and believes the best way to solve a problem is to face it head-on.
        While his impulsiveness sometimes gets him into tricky spots, his loyal heart and courageous spirit always shine through.
</code></pre>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5>Character Archetypes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="small">
                                        <div class="mb-1"><strong>heroic:</strong> Traditional heroes, knights</div>
                                        <div class="mb-1"><strong>guardian:</strong> Protectors, defenders</div>
                                        <div class="mb-1"><strong>trickster:</strong> Rogues, jesters</div>
                                        <div class="mb-1"><strong>wise/mental:</strong> Wizards, scholars</div>
                                        <div class="mb-1"><strong>inner:</strong> Personal growth focused</div>
                                        <div class="mb-1"><strong>moral:</strong> Ethics and values driven</div>
                                        <div class="mb-1"><strong>elemental:</strong> Nature-based powers</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{ var cspNonce = Context.Items["CspNonce"] as string; }
<script nonce="@cspNonce">
function validateYamlFile() {
    const fileInput = document.getElementById('yamlFile');
    if (!fileInput.files.length) {
        alert('Please select a YAML file first');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            // Basic validation - check if it looks like YAML
            const content = e.target.result;
            if (!content.includes('name:') || !content.includes('characters:')) {
                alert('Warning: This doesn\'t look like a valid character map YAML file.\nExpected to find "name:" and "characters:" fields.');
                return;
            }

            alert('YAML file appears to be valid. Click "Upload Character Map" to proceed.');
        } catch (error) {
            alert('Error reading file: ' + error.message);
        }
    };

    reader.readAsText(file);
}

document.getElementById('characterMapForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading...';
    submitBtn.disabled = true;

    fetch('/api/admin/charactermapsadmin/import', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
            const message = data.message || data.Message || 'Error uploading character map';
            throw new Error(message);
        }

        const count = Array.isArray(data) ? data.length : (data.count ?? 0);
        alert(`Character map uploaded successfully! Imported ${count} map(s).`);
        window.location.href = '/admin/charactermaps';
    })
    .catch(error => {
        alert('Error: ' + error.message);
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Auto-validate when file is selected
document.getElementById('yamlFile').addEventListener('change', function() {
    if (this.files.length > 0) {
        const fileName = this.files[0].name;
        if (!fileName.toLowerCase().endsWith('.yaml') && !fileName.toLowerCase().endsWith('.yml')) {
            alert('Please select a YAML file (.yaml or .yml)');
            this.value = '';
        }
    }
});
</script>
