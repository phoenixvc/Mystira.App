@{
    ViewData["Title"] = "Avatar Management";
    Layout = "_Layout";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ðŸŽ¨ Avatar Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" id="refreshAvatarsBtn" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Age Group Selector -->
<div class="row mb-4">
    <div class="col-md-6">
        <label class="form-label">Select Age Group</label>
        <select class="form-select" id="ageGroupSelect">
            <option value="">-- Select an age group --</option>
            <option value="1-2">Ages 1-2</option>
            <option value="3-5">Ages 3-5</option>
            <option value="6-9">Ages 6-9</option>
            <option value="10-12">Ages 10-12</option>
            <option value="13-18">Ages 13-18</option>
            <option value="19-150">Ages 19+</option>
        </select>
    </div>
</div>

<!-- Current Avatars for Selected Age Group -->
<div id="avatarContainer" class="d-none">
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Current Avatars for <span id="selectedAgeGroup" class="badge bg-primary"></span></h5>
        </div>
        <div class="card-body">
            <div class="row" id="avatarGrid">
                <div class="col-12 text-center py-4">
                    <p class="text-muted">No avatars configured for this age group.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Avatar Section -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Add Avatars to Selected Age Group</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Search Media Files (Images)</label>
                <input type="text" class="form-control" id="mediaSearch" placeholder="Search by media ID or name...">
            </div>
            <div class="col-md-6">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-info w-100" id="searchMediaBtn">
                    <i class="fas fa-search me-2"></i>Search Available Media
                </button>
            </div>
        </div>

        <div id="availableMediaContainer" class="d-none">
            <h6 class="mb-3">Available Media</h6>
            <div class="row" id="availableMediaGrid">
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Alert -->
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    <strong>How to use:</strong> Select an age group, then search for and add media files (images) as avatars. Each avatar will be available for users to select when creating or editing profiles in that age group.
</div>

@section Scripts {
@{ var cspNonce = Context.Items["CspNonce"] as string; }
<script nonce="@cspNonce">
let currentAgeGroup = '';
let allMedia = [];
let currentAvatars = {};
let availableMediaCache = {};

$(document).ready(function() {
    loadAvatars();

    // Bind UI events (no inline handlers to satisfy CSP)
    $('#refreshAvatarsBtn').on('click', () => loadAvatars());
    $('#ageGroupSelect').on('change', () => onAgeGroupChange());
    $('#searchMediaBtn').on('click', (e) => { e.preventDefault(); searchAvailableMedia(); });
    $('#mediaSearch').on('input', () => searchAvailableMedia());

    // Delegate clicks in dynamic grids
    $('#avatarGrid').on('click', 'button[data-action="remove-avatar"]', function() {
        const mediaId = this.getAttribute('data-media-id');
        if (mediaId) removeAvatar(mediaId);
    });

    $('#availableMediaGrid').on('click', 'button[data-action="add-avatar"]', function() {
        const mediaId = this.getAttribute('data-media-id');
        if (mediaId) addAvatarToGroup(mediaId);
    });
});

async function loadAvatars() {
    try {
        const response = await fetch('/api/admin/avataradmin', {
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        currentAvatars = data.ageGroupAvatars || {};

        console.log('Loaded avatars:', currentAvatars);
    } catch (error) {
        console.error('Error loading avatars:', error);
        showError('Failed to load avatar configuration. Please try again.');
    }
}

async function onAgeGroupChange() {
    const select = document.getElementById('ageGroupSelect');
    currentAgeGroup = select.value;

    if (!currentAgeGroup) {
        document.getElementById('avatarContainer').classList.add('d-none');
        document.getElementById('availableMediaContainer').classList.add('d-none');
        return;
    }

    document.getElementById('selectedAgeGroup').textContent = select.options[select.selectedIndex].text;
    document.getElementById('avatarContainer').classList.remove('d-none');

    displayCurrentAvatars();
}

async function displayCurrentAvatars() {
    const avatarIds = currentAvatars[currentAgeGroup] || [];
    const container = document.getElementById('avatarGrid');

    if (avatarIds.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No avatars configured for this age group.</p></div>';
        return;
    }

    let html = '';
    for (const mediaId of avatarIds) {
        html += `
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <img src="/api/admin/mediaadmin/${mediaId}" alt="Avatar" class="img-fluid mb-2 max-w-100 max-h-200 of-contain">
                        <p class="small text-muted">${mediaId}</p>
                        <button class="btn btn-sm btn-danger" data-action="remove-avatar" data-media-id="${mediaId}">
                            <i class="fas fa-trash me-1"></i>Remove
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

async function loadAvailableMedia() {
    if (!currentAgeGroup) {
        showError('Please select an age group first.');
        return;
    }

    // Clear search box and just reuse searchAvailableMedia with empty term
    document.getElementById('mediaSearch').value = '';
    await searchAvailableMedia();
}

function displayAvailableMedia(mediaList) {
    const container = document.getElementById('availableMediaGrid');
    const currentAvatarIds = currentAvatars[currentAgeGroup] || [];

    if (mediaList.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No media files found.</p></div>';
        return;
    }

    let html = '';
    for (const media of mediaList) {
        const isAlreadyAdded = currentAvatarIds.includes(media.mediaId);
        const btnClass = isAlreadyAdded ? 'btn-success' : 'btn-primary';
        const btnText = isAlreadyAdded ? 'âœ“ Added' : '+ Add';
        const btnDisabled = isAlreadyAdded ? 'disabled' : '';

        html += `
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <img src="${media.url}" alt="${media.mediaId}" class="img-fluid mb-2 max-w-100 max-h-150 of-contain">
                        <p class="small text-muted">${media.mediaId}</p>
                        <button class="btn btn-sm ${btnClass} w-100" data-action="add-avatar" data-media-id="${media.mediaId}" ${btnDisabled}>
                            ${btnText}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

async function searchAvailableMedia() {
    if (!currentAgeGroup) {
        showError('Please select an age group first.');
        return;
    }

    const raw = document.getElementById('mediaSearch').value;
    const searchTerm = raw.trim();

    const encodedSearch = searchTerm
        ? `&search=${encodeURIComponent(searchTerm)}`
        : '';

    const url = `/api/admin/mediaadmin?mediaType=image&pageSize=100${encodedSearch}`;
    console.log('searchAvailableMedia term:', searchTerm);
    console.log('searchAvailableMedia URL:', url);

    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('searchAvailableMedia response:', data);

        allMedia = data.media || [];
        availableMediaCache = {};

        allMedia.forEach(media => {
            availableMediaCache[media.mediaId] = media;
        });

        document.getElementById('availableMediaContainer').classList.remove('d-none');
        displayAvailableMedia(allMedia);
    } catch (error) {
        console.error('Error loading available media:', error);
        showError('Failed to load available media. Please try again.');
    }
}


async function addAvatarToGroup(mediaId) {
    if (!currentAgeGroup) {
        showError('Please select an age group first.');
        return;
    }

    try {
        console.log('addAvatarToGroup called with mediaId:', mediaId, 'ageGroup:', currentAgeGroup);

        const response = await fetch(`/api/admin/avataradmin/${currentAgeGroup}/add`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || ''),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mediaId)
        });

        console.log('addAvatarToGroup response status:', response.status);

        if (!response.ok) {
            const responseText = await response.text();
            console.error('addAvatarToGroup error response:', responseText);
            throw new Error(`Add avatar failed: ${response.status} - ${responseText}`);
        }

        const data = await response.json();
        console.log('addAvatarToGroup success response:', data);

        showSuccess(`Avatar added to ${currentAgeGroup} group!`);

        // âœ… Update local avatar list for this age group
        if (!currentAvatars[currentAgeGroup]) {
            currentAvatars[currentAgeGroup] = [];
        }
        if (!currentAvatars[currentAgeGroup].includes(mediaId)) {
            currentAvatars[currentAgeGroup].push(mediaId);
            console.log('Updated local currentAvatars:', currentAvatars);
        }

        // âœ… Re-render the current avatars (top section)
        displayCurrentAvatars();

        // âœ… Re-render the *current* media list so "+ Add" â†’ "âœ“ Added"
        displayAvailableMedia(allMedia);
    } catch (error) {
        console.error('Error adding avatar:', error);
        showError('Failed to add avatar. Please try again.');
    }
}

async function removeAvatar(mediaId) {
    if (!currentAgeGroup) {
        showError('Please select an age group first.');
        return;
    }

    if (!confirm(`Remove avatar ${mediaId} from ${currentAgeGroup} group?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/avataradmin/${currentAgeGroup}/remove/${mediaId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        showSuccess(`Avatar removed from ${currentAgeGroup} group!`);
        await loadAvatars();
        await displayCurrentAvatars();
    } catch (error) {
        console.error('Error removing avatar:', error);
        showError('Failed to remove avatar. Please try again.');
    }
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.insertBefore(alert, document.body.firstChild);
    setTimeout(() => alert.remove(), 5000);
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.insertBefore(alert, document.body.firstChild);
    setTimeout(() => alert.remove(), 3000);
}
</script>
}
