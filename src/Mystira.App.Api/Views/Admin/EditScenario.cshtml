@model Mystira.App.Domain.Models.Scenario
@{
    ViewData["Title"] = "Edit Scenario";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Edit Scenario: @Model.Title</h3>
                    <div>
                        <a href="/admin/scenarios" class="btn btn-secondary">Back to Scenarios</a>
                        <button type="submit" form="editScenarioForm" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="editScenarioForm" method="post" action="/admin/scenarios/edit/@Model.Id">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Basic Information -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Basic Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="title">Title</label>
                                            <input type="text" class="form-control" id="title" name="title" value="@Model.Title" required>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="description">Description</label>
                                            <textarea class="form-control" id="description" name="description" rows="4" required>@Model.Description</textarea>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="summary">Summary</label>
                                            <textarea class="form-control" id="summary" name="summary" rows="3">@Model.Summary</textarea>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="difficulty">Difficulty</label>
                                                    <select class="form-control" id="difficulty" name="difficulty">
                                                        <option value="Easy" selected="@(Model.Difficulty == Mystira.App.Domain.Models.DifficultyLevel.Easy)">Easy</option>
                                                        <option value="Medium" selected="@(Model.Difficulty == Mystira.App.Domain.Models.DifficultyLevel.Medium)">Medium</option>
                                                        <option value="Hard" selected="@(Model.Difficulty == Mystira.App.Domain.Models.DifficultyLevel.Hard)">Hard</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="sessionLength">Session Length</label>
                                                    <select class="form-control" id="sessionLength" name="sessionLength">
                                                        <option value="Short" selected="@(Model.SessionLength == Mystira.App.Domain.Models.SessionLength.Short)">Short (~30 min)</option>
                                                        <option value="Medium" selected="@(Model.SessionLength == Mystira.App.Domain.Models.SessionLength.Medium)">Medium (~60 min)</option>
                                                        <option value="Long" selected="@(Model.SessionLength == Mystira.App.Domain.Models.SessionLength.Long)">Long (~90+ min)</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="minimumAge">Minimum Age</label>
                                                    <input type="text" class="form-control" id="minimumAge" name="minimumAge" value="@Model.MinimumAge">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="tags">Tags (comma-separated)</label>
                                            <input type="text" class="form-control" id="tags" name="tags" value="@string.Join(", ", Model.Tags)">
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="archetypes">Archetypes (comma-separated)</label>
                                            <input type="text" class="form-control" id="archetypes" name="archetypes" value="@string.Join(", ", Model.Archetypes)">
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="compassAxes">Compass Axes (comma-separated, max 4)</label>
                                            <input type="text" class="form-control" id="compassAxes" name="compassAxes" value="@string.Join(", ", Model.CompassAxes)">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Scenes Section -->
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5>Scenes (@Model.Scenes.Count)</h5>
                                        <button type="button" class="btn btn-sm btn-success" onclick="addScene()">Add Scene</button>
                                    </div>
                                    <div class="card-body">
                                        <div id="scenesContainer">
                                            @for (int i = 0; i < Model.Scenes.Count; i++)
                                            {
                                                var scene = Model.Scenes[i];
                                                <div class="scene-item border p-3 mb-3">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <h6>Scene @(i + 1): @scene.Title</h6>
                                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeScene(this)">Remove</button>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <input type="hidden" name="scenes[@i].Id" value="@scene.Id">
                                                            <div class="form-group mb-2">
                                                                <label>Scene Title</label>
                                                                <input type="text" class="form-control form-control-sm" name="scenes[@i].Title" value="@scene.Title">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-group mb-2">
                                                                <label>Type</label>
                                                                <select class="form-control form-control-sm" name="scenes[@i].Type">
                                                                    <option value="Narrative" selected="@(scene.Type == Mystira.App.Domain.Models.SceneType.Narrative)">Narrative</option>
                                                                    <option value="Choice" selected="@(scene.Type == Mystira.App.Domain.Models.SceneType.Choice)">Choice</option>
                                                                    <option value="Roll" selected="@(scene.Type == Mystira.App.Domain.Models.SceneType.Roll)">Roll</option>
                                                                    <option value="Special" selected="@(scene.Type == Mystira.App.Domain.Models.SceneType.Special)">Special</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-group mb-2">
                                                                <label>Next Scene ID</label>
                                                                <input type="text" class="form-control form-control-sm" name="scenes[@i].NextSceneId" value="@scene.NextSceneId">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group mb-2">
                                                        <label>Description</label>
                                                        <textarea class="form-control form-control-sm" name="scenes[@i].Description" rows="3">@scene.Description</textarea>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sidebar -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Scenario Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-info" onclick="previewScenario()">Preview Scenario</button>
                                            <button type="button" class="btn btn-warning" onclick="validateScenario()">Validate Media References</button>
                                            <button type="button" class="btn btn-secondary" onclick="exportScenario()">Export as YAML</button>
                                        </div>
                                        
                                        <hr>
                                        
                                        <div class="mb-3">
                                            <strong>Created:</strong><br>
                                            <small>@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>Scenario ID:</strong><br>
                                            <small class="text-muted">@Model.Id</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function addScene() {
    // Basic scene addition - in a real implementation, this would be more sophisticated
    alert('Scene addition functionality would be implemented here');
}

function removeScene(button) {
    if (confirm('Are you sure you want to remove this scene?')) {
        button.closest('.scene-item').remove();
    }
}

function previewScenario() {
    window.open('/admin/scenarios/preview/@Model.Id', '_blank');
}

async function validateScenario() {
    const scenarioId = '@Model.Id';
    
    try {
        // Show loading indicator
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Validating...';
        
        const response = await fetch(`/api/scenarios/${scenarioId}/validate-references`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const validationResult = await response.json();
        
        // Debug: Log the validation result to console
        console.log('Validation Result:', validationResult);
        
        // Restore button
        button.disabled = false;
        button.textContent = originalText;
        
        displayValidationResults(validationResult);
        
    } catch (error) {
        console.error('Error validating scenario references:', error);
        
        // Restore button
        const button = event.target;
        button.disabled = false;
        button.textContent = 'Validate Media References';
        
        alert(`Error validating references: ${error.message}`);
    }
}

function displayValidationResults(validationResult) {
    // Remove any existing validation results
    const existingResults = document.getElementById('validationResults');
    if (existingResults) {
        existingResults.remove();
    }
    
    // Debug: Log individual properties
    console.log('HasMissingReferences:', validationResult.HasMissingReferences);
    console.log('MissingReferences:', validationResult.MissingReferences);
    console.log('TotalReferences:', validationResult.TotalReferences);
    
    // Create validation results container
    const resultsContainer = document.createElement('div');
    resultsContainer.id = 'validationResults';
    resultsContainer.className = 'card mt-3';
    
    let resultsHtml = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Reference Validation Results</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('validationResults').remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body">
    `;
    
    if (!validationResult.HasMissingReferences) {
        resultsHtml += `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>All references are valid!</strong> No missing media or character references found.
                <br><small class="text-muted">Total references checked: ${validationResult.TotalReferences || 0}</small>
            </div>
        `;
    } else {
        resultsHtml += `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Some references could not be resolved.</strong> Please review the issues below.
                <br><small class="text-muted">${validationResult.MissingReferencesCount} of ${validationResult.TotalReferences} references have issues</small>
            </div>
        `;
        
        if (validationResult.MissingReferences && validationResult.MissingReferences.length > 0) {
            resultsHtml += `<div class="mb-3">`;
            
            // Group by reference type
            const mediaRefs = validationResult.MissingReferences.filter(ref => ref.ReferenceType === 'media');
            const characterRefs = validationResult.MissingReferences.filter(ref => ref.ReferenceType === 'character');
            
            console.log('Media refs found:', mediaRefs.length);
            console.log('Character refs found:', characterRefs.length);
            
            if (mediaRefs.length > 0) {
                resultsHtml += `
                    <h6 class="text-danger">Missing Media References (${mediaRefs.length}):</h6>
                    <div class="list-group list-group-flush mb-3">
                `;
                
                mediaRefs.forEach(ref => {
                    // Determine media type from issue description or reference ID
                    const mediaType = ref.ReferenceId.includes('.jpg') || ref.ReferenceId.includes('.png') || ref.ReferenceId.includes('.jpeg') ? 'image' :
                                     ref.ReferenceId.includes('.mp3') || ref.ReferenceId.includes('.wav') ? 'audio' : 'video';
                    const typeIcon = mediaType === 'image' ? 'fa-image' : 
                                   mediaType === 'audio' ? 'fa-volume-up' : 'fa-video';
                    resultsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <i class="fas ${typeIcon} text-muted me-2"></i>
                                    <strong>${ref.ReferenceId}</strong>
                                    <br>
                                    <small class="text-muted">Scene: ${ref.SceneId} (${ref.SceneTitle}) | Type: ${mediaType}</small>
                                    <br>
                                    <small class="text-danger">${ref.Description}</small>
                                </div>
                                <span class="badge bg-danger">${ref.IssueType}</span>
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `</div>`;
            }
            
            if (characterRefs.length > 0) {
                resultsHtml += `
                    <h6 class="text-danger">Missing Character References (${characterRefs.length}):</h6>
                    <div class="list-group list-group-flush">
                `;
                
                characterRefs.forEach(ref => {
                    resultsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <i class="fas fa-user text-muted me-2"></i>
                                    <strong>${ref.ReferenceId}</strong>
                                    <br>
                                    <small class="text-muted">Scene: ${ref.SceneId} (${ref.SceneTitle})</small>
                                    <br>
                                    <small class="text-danger">${ref.Description}</small>
                                </div>
                                <span class="badge bg-warning">${ref.IssueType}</span>
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `</div>`;
            }
            
            resultsHtml += `</div>`;
            
            // If no media or character refs were found but we have missing references, show them raw
            if (mediaRefs.length === 0 && characterRefs.length === 0) {
                resultsHtml += `
                    <h6 class="text-warning">Unrecognized Missing References (${validationResult.MissingReferences.length}):</h6>
                    <div class="list-group list-group-flush mb-3">
                `;
                
                validationResult.MissingReferences.forEach(ref => {
                    resultsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <i class="fas fa-question text-muted me-2"></i>
                                    <strong>${ref.ReferenceId || 'Unknown Reference'}</strong>
                                    <br>
                                    <small class="text-muted">Type: ${ref.ReferenceType || 'Unknown'} | Scene: ${ref.SceneId || 'Unknown'}</small>
                                    <br>
                                    <small class="text-danger">${ref.Description || 'No description available'}</small>
                                    <br>
                                    <small class="text-info">Issue: ${ref.IssueType || 'Unknown issue'}</small>
                                </div>
                                <span class="badge bg-secondary">${ref.IssueType || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `</div>`;
            }
        } else if (validationResult.HasMissingReferences) {
            resultsHtml += `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Validation indicates missing references, but no detailed list is available.</strong>
                    <br><small>This may indicate a data format issue. Check the browser console for more details.</small>
                </div>
            `;
        }
        
        // Add summary and recommendations
        resultsHtml += `
            <div class="alert alert-info">
                <h6><i class="fas fa-lightbulb me-2"></i>Recommendations:</h6>
                <ul class="mb-0">
                    <li>Upload missing media files through the <a href="/admin/media" target="_blank">Media Management</a> page</li>
                    <li>Add missing characters through the <a href="/admin/charactermaps" target="_blank">Character Maps</a> page</li>
                    <li>Update scenario to use existing media/character references</li>
                    <li>Ensure media metadata entries exist for all referenced files</li>
                </ul>
            </div>
        `;
    }
    
    resultsHtml += `</div>`;
    
    resultsContainer.innerHTML = resultsHtml;
    
    // Insert the results after the sidebar card
    const sidebar = document.querySelector('.col-md-4');
    sidebar.appendChild(resultsContainer);
    
    // Scroll to results
    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function exportScenario() {
    window.open('/admin/scenarios/export/@Model.Id', '_blank');
}
</script>