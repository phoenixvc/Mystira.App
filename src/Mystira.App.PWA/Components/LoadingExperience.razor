@implements IDisposable
@inject IJSRuntime jsRuntime

<div class="loading-screen">
    <div class="loading-content">
        <img src="images/mystira-logo.webp" alt="Mystira" class="loading-logo" />
        <h1 class="loading-title">Mystira</h1>

        <div class="loading-status">
            <div class="loading-spinner"></div>
            <p class="loading-message">@currentMessage</p>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public bool AutoStart { get; set; } = true;
    [Parameter] public EventCallback OnLoaded { get; set; }

    private string currentMessage = "Starting Mystira…";
    private DotNetObjectReference<LoadingExperience>? selfReference;

    private readonly string[] messages = new[]
    {
        "Starting Mystira…",
        "Loading your library…",
        "Preparing story engine…",
        "Almost ready…"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AutoStart)
        {
            // Cycle through messages for visual feedback
            foreach (var message in messages)
            {
                currentMessage = message;
                StateHasChanged();
                await Task.Delay(150);
            }

            if (OnLoaded.HasDelegate)
            {
                await OnLoaded.InvokeAsync();
            }
        }
    }

    public void Dispose()
    {
        selfReference?.Dispose();
    }
}
