@using Microsoft.JSInterop
@* Hero Section Component *@
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="row" style="margin-top: 0;">
    <div class="col-12 text-center mb-5 hero-section" style="position: relative; margin-top: 0;">
        <!-- Particle Background Canvas -->
        <canvas id="particle-canvas" class="particle-canvas" aria-hidden="true"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: auto;"></canvas>
        
        <!-- Golden Light Tubes - positioned around the logo/video area -->
        <div class="golden-lights" aria-hidden="true" id="golden-lights-container">
            <svg class="golden-light-svg" viewBox="0 0 600 500" preserveAspectRatio="xMidYMid meet">
                <!-- Animated twirling light tubes that orbit around center -->
                <g class="light-tube-group light-tube-group-1">
                    <!-- Left orbital tube -->
                    <path class="light-tube light-tube-1" 
                          d="M 50 150 C 100 80, 200 100, 280 200 S 320 320, 300 280 S 350 200, 300 240 C 250 280, 280 350, 380 320" 
                          fill="none" stroke="url(#goldenGradient1)" stroke-width="3" stroke-linecap="round" />
                    <path class="light-tube light-tube-1-glow" 
                          d="M 50 150 C 100 80, 200 100, 280 200 S 320 320, 300 280 S 350 200, 300 240 C 250 280, 280 350, 380 320" 
                          fill="none" stroke="url(#goldenGradient1)" stroke-width="12" opacity="0.2" stroke-linecap="round" />
                </g>
                
                <g class="light-tube-group light-tube-group-2">
                    <!-- Right orbital tube -->
                    <path class="light-tube light-tube-2" 
                          d="M 550 180 C 500 100, 400 130, 340 220 S 310 350, 300 280 S 250 200, 300 240 C 350 280, 330 380, 230 350" 
                          fill="none" stroke="url(#goldenGradient2)" stroke-width="3" stroke-linecap="round" />
                    <path class="light-tube light-tube-2-glow" 
                          d="M 550 180 C 500 100, 400 130, 340 220 S 310 350, 300 280 S 250 200, 300 240 C 350 280, 330 380, 230 350" 
                          fill="none" stroke="url(#goldenGradient2)" stroke-width="12" opacity="0.2" stroke-linecap="round" />
                </g>
                
                <g class="light-tube-group light-tube-group-3">
                    <!-- Inner spiral around logo -->
                    <path class="light-tube light-tube-3" 
                          d="M 200 180 Q 250 140, 300 180 T 400 250 Q 360 320, 300 320 T 200 250 Q 250 200, 300 220" 
                          fill="none" stroke="url(#goldenGradient3)" stroke-width="2.5" stroke-linecap="round" />
                    <path class="light-tube light-tube-3-glow" 
                          d="M 200 180 Q 250 140, 300 180 T 400 250 Q 360 320, 300 320 T 200 250 Q 250 200, 300 220" 
                          fill="none" stroke="url(#goldenGradient3)" stroke-width="8" opacity="0.15" stroke-linecap="round" />
                </g>
                
                <!-- Gradients with brighter golden colors -->
                <defs>
                    <linearGradient id="goldenGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700;stop-opacity:0.8" />
                        <stop offset="50%" style="stop-color:#FFA500;stop-opacity:0.6" />
                        <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:0.4" />
                    </linearGradient>
                    <linearGradient id="goldenGradient2" x1="100%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700;stop-opacity:0.7" />
                        <stop offset="50%" style="stop-color:#FFA500;stop-opacity:0.5" />
                        <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:0.35" />
                    </linearGradient>
                    <linearGradient id="goldenGradient3" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFE066;stop-opacity:0.6" />
                        <stop offset="50%" style="stop-color:#FFD700;stop-opacity:0.5" />
                        <stop offset="100%" style="stop-color:#FFA500;stop-opacity:0.3" />
                    </linearGradient>
                    
                    <!-- Filter for extra glow effect -->
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
            </svg>
        </div>
        
        <div class="hero-content" style="position: relative; z-index: 1;">
            <h1 class="mystira-title mb-2">
                <span class="title-text">Mystira</span><span class="alpha-badge">ALPHA</span>
            </h1>
            <p class="mystira-tagline mb-4">Where imagination meets growth</p>
            <div class="hero-logo-container mb-4">
                <!-- Logo Intro Video (plays on page load, then fades to logo) -->
                <video id="logo-intro-video" 
                       class="hero-logo-video @(showVideo ? "visible" : "hidden")" 
                       autoplay 
                       muted 
                       playsinline
                       aria-label="Mystira logo introduction video">
                    <source src="videos/logo-intro.mp4" type="video/mp4">
                </video>
                <!-- Static Logo (shown after video fades) -->
                <img src="images/mystira-logo.webp"
                     id="hero-logo-static"
                     alt="Mystira - Where imagination meets growth"
                     width="300"
                     height="300"
                     class="hero-logo @(showVideo ? "hidden" : "visible")" />
                     
                <!-- Replay button (appears after video ends) -->
                <button id="replay-video-btn" 
                        class="replay-btn @(showReplayButton ? "visible" : "hidden")"
                        @onclick="ReplayVideo"
                        title="Replay intro video"
                        aria-label="Replay introduction video">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            @if (ShowDescription)
            {
                <p class="hero-description mb-4">
                    Bring stories to life with Mystira â€” an interactive adventure platform that helps children, parents, and group leaders explore imagination, teamwork, and growth through guided storytelling and play.
                </p>

                @if (ShowCallToActions)
                {
                    <div class="hero-cta-buttons d-flex gap-3 justify-content-center flex-wrap mb-4">
                        <a href="/signup" class="btn btn-primary-custom btn-lg px-5 py-3">
                            <i class="fas fa-rocket me-2"></i>Get Started
                        </a>
                        <button class="btn btn-outline-primary btn-lg px-5 py-3" @onclick="OnWatchDemo">
                            <i class="fas fa-play-circle me-2"></i>Watch Demo (2 min)
                        </button>
                    </div>

                    <!-- Trust Indicators -->
                    <!--
                    <div class="trust-badges">
                        <span class="trust-badge">
                            <i class="fas fa-shield-alt me-1"></i>Safe for Kids
                        </span>
                        <span class="trust-badge">
                            <i class="fas fa-ban me-1"></i>No Ads
                        </span>
                        <CoppaCompliancePill />
                    </div>
                    -->
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public bool ShowDescription { get; set; } = false;

    [Parameter]
    public bool ShowCallToActions { get; set; } = false;

    [Parameter]
    public EventCallback OnWatchDemoClick { get; set; }

    private bool _particlesInitialized = false;
    private bool showVideo = true;
    private bool showReplayButton = false;
    private DotNetObjectReference<HeroSection>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_particlesInitialized)
        {
            _particlesInitialized = true;
            try
            {
                await JSRuntime.InvokeVoidAsync("MystiraParticles.init", "particle-canvas");
                
                // Initialize logo intro video fade transition with callback
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initLogoIntroVideo", _dotNetRef);
            }
            catch (Exception)
            {
                // Silently fail if JS interop is not available (e.g., during prerendering)
            }
        }
    }

    [JSInvokable]
    public void OnVideoEnded()
    {
        showVideo = false;
        showReplayButton = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnVideoError()
    {
        showVideo = false;
        showReplayButton = false;
        StateHasChanged();
    }

    private async Task ReplayVideo()
    {
        showVideo = true;
        showReplayButton = false;
        StateHasChanged();
        
        try
        {
            await JSRuntime.InvokeVoidAsync("replayLogoVideo");
        }
        catch (JSException)
        {
            // Silently fail
        }
    }

    private async Task OnWatchDemo()
    {
        if (OnWatchDemoClick.HasDelegate)
        {
            await OnWatchDemoClick.InvokeAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("MystiraParticles.destroy");
            await JSRuntime.InvokeVoidAsync("cleanupLogoIntroVideo");
        }
        catch (Exception)
        {
            // Silently fail if JS interop is not available
        }
        
        // Dispose the DotNetObjectReference to prevent memory leaks
        _dotNetRef?.Dispose();
    }
}
