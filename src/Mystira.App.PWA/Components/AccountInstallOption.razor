@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (showInstallOption)
{
    <button class="dropdown-item" @onclick="InstallPwaAsync">
        <i class="fas fa-download me-2"></i>
        Install App
    </button>
}

@code {
    private bool showInstallOption;
    private IJSObjectReference? jsModule;
    private PeriodicTimer? checkTimer;
    private CancellationTokenSource? cts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/pwaInstall.js");

                // Check if app is installed
                await UpdateInstallOptionVisibility();

                // Start periodic check to detect installation changes
                cts = new CancellationTokenSource();
                _ = MonitorInstallationStateAsync(cts.Token);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing account install option: {ex.Message}");
            }
        }
    }

    private async Task MonitorInstallationStateAsync(CancellationToken cancellationToken)
    {
        checkTimer = new PeriodicTimer(TimeSpan.FromSeconds(2));

        try
        {
            while (await checkTimer.WaitForNextTickAsync(cancellationToken))
            {
                await UpdateInstallOptionVisibility();
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when component is disposed
        }
    }

    private async Task UpdateInstallOptionVisibility()
    {
        try
        {
            if (jsModule != null)
            {
                var isInstalled = await jsModule.InvokeAsync<bool>("isAppInstalled");
                var shouldShow = !isInstalled;

                if (showInstallOption != shouldShow)
                {
                    showInstallOption = shouldShow;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking install state: {ex.Message}");
        }
    }

    private async Task InstallPwaAsync()
    {
        try
        {
            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("installPwa");
                // Check if installed after attempting install
                await UpdateInstallOptionVisibility();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error installing PWA from account menu: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        cts?.Cancel();
        cts?.Dispose();
        checkTimer?.Dispose();

        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }

        jsModule = null;
    }
}
