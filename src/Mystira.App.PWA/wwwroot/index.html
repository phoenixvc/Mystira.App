<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <title>Mystira</title>
    <base href="/" />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#8B5CF6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Mystira" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-TileColor" content="#8B5CF6" />
    <meta name="msapplication-TileImage" content="icons/icon-192.png">
    <meta name="msapplication-navbutton-color" content="#8B5CF6" />

    <!-- Standard favicon -->
    <link rel="icon" type="image/x-icon" href="icons/favicon.png">

    <!-- Faviconand Apple Touch Icons -->
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png" />
    
    <!-- Open Graph / PWA Description -->
    <meta property="og:title" content="Mystira - Adventures for Children" />
    <meta property="og:description" content="Dynamic D&D Style App for Dungeon Masters working with young players" />
    <meta property="og:image" content="icons/icon-512.png" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!--link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"-->
    
    <!-- Custom CSS -->
    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />

    <!-- Scripts -->
    <script src="js/imageCacheManager.js"></script>

    <!-- Application Insights -->
    <script type="text/javascript">
        !function(T,l,y){
            var S=T.location,
                k="script",
                D="instrumentationKey",
                C="ingestionendpoint",
                I="disableExceptionTracking",
                E="ai.device.",
                b="toLowerCase",
                w="crossOrigin",
                N="POST",
                e="appInsightsSDK",
                t=l.documentElement,
                n=S.protocol==="https:"?"https:":"http:",
                u=function(e){e.queue=[],e.version=2;var t=l.createElement(k);t.async=!0,t.src=n+"//js.monitor.azure.com/scripts/b/ai.2.min.js",t.setAttribute("crossorigin","anonymous");var i=l.getElementsByTagName(k)[0];i.parentNode.insertBefore(t,i)};var i={config:{connectionString:"InstrumentationKey=6c9db606-e0bd-4b74-ade5-68c3bf5b2865;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/;LiveEndpoint=https://westeurope.livediagnostics.monitor.azure.com/;ApplicationId=009864dd-fb88-4dce-bc62-7a9b8df50c1f",enableAutoRouteTracking:!0}};var s=T[e]||function(e){function t(e){i[e]=function(){var t=arguments;i.queue.push(function(){i[e].apply(i,t)})}}var i={config:e};i.initialize=!0;var n=l.createElement(k);n.src=e.url||"https://js.monitor.azure.com/scripts/b/ai.2.min.js",l.getElementsByTagName(k)[0].parentNode.appendChild(n);try{i.cookie=l.cookie}catch(e){}i.queue=[],i.version=2;for(var a=["trackEvent","trackPageView","trackException","trackTrace","trackDependencyData","trackMetric","startTrackEvent","stopTrackEvent","startTrackPage","stopTrackPage","flush"],o=0;o<a.length;o++)t(a[o]);return i}(i.config);T[e]=s,s.queue&&0===s.queue.length?s.trackPageView({}):l.write("<"+'script src="https://js.monitor.azure.com/scripts/b/ai.2.min.js"><\/script>')
        }(window,document);
    </script>

</head>

<body>
    <div id="app">
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-muted">Loading Mystira...</div>
            </div>
        </div>
    </div>

    <!-- Error Display for Script Loading Issues -->
    <div id="blazor-error-ui" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Application Error</h4>
            <p>An error has occurred. This application may no longer respond until reloaded.</p>
            <div id="sri-error-message" style="display: none;">
                <p><strong>SRI Integrity Error Detected</strong></p>
                <p>This usually happens when the browser has cached an old version of the application. Please try the following steps:</p>
                <ol>
                    <li>Click "Clear Cache & Reload" below</li>
                    <li>If that doesn't work, try a hard refresh (Ctrl+F5 or Cmd+Shift+R)</li>
                    <li>As a last resort, clear your browser cache completely</li>
                </ol>
            </div>
            <hr>
            <button type="button" class="btn btn-outline-danger me-2" onclick="window.location.reload()">Reload</button>
            <button type="button" class="btn btn-outline-warning" onclick="clearCacheAndReload()">Clear Cache & Reload</button>
        </div>
    </div>

    <!-- Blazor WebAssembly Scripts -->
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/outside-click-handler.js"></script>
    <!-- Dice Component Script -->
    <script src="dice.js"></script>

    <!-- SRI Error Detection and Cache Clearing -->
    <script>
        // Function to clear all caches and reload
        async function clearCacheAndReload() {
            console.log('Clearing all caches and reloading...');
            
            try {
                // Clear service worker caches
                if ('caches' in window) {
                    const cacheKeys = await caches.keys();
                    await Promise.all(cacheKeys.map(key => caches.delete(key)));
                    console.log('Cleared', cacheKeys.length, 'cache(s)');
                }
                
                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(registration => registration.unregister()));
                    console.log('Unregistered', registrations.length, 'service worker(s)');
                }
                
                // Reload with a timestamp to bypass browser cache
                const timestamp = new Date().getTime();
                window.location.href = window.location.pathname + '?t=' + timestamp;
            } catch (error) {
                console.error('Error clearing cache:', error);
                // Fallback to simple reload
                window.location.reload(true);
            }
        }

        // Detect SRI errors and show appropriate message
        window.addEventListener('error', function(event) {
            const errorMessage = event.message || '';
            const errorUrl = event.filename || '';
            
            if (errorMessage.includes('integrity') || 
                errorMessage.includes('SRI') || 
                errorMessage.includes('digest') ||
                (errorUrl.includes('.wasm') && errorMessage.includes('Failed to fetch'))) {
                
                console.log('SRI error detected:', errorMessage);
                
                // Show SRI-specific error message
                const errorUi = document.getElementById('blazor-error-ui');
                const sriMessage = document.getElementById('sri-error-message');
                
                if (errorUi) {
                    errorUi.style.display = 'block';
                    if (sriMessage) {
                        sriMessage.style.display = 'block';
                    }
                }
            }
        }, true);

        // Also listen for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            const errorMessage = event.reason?.message || '';
            
            if (errorMessage.includes('integrity') || 
                errorMessage.includes('SRI') || 
                errorMessage.includes('digest') ||
                errorMessage.includes('Mystira.App.Domain.wasm')) {
                
                console.log('SRI promise rejection detected:', errorMessage);
                
                // Show SRI-specific error message
                const errorUi = document.getElementById('blazor-error-ui');
                const sriMessage = document.getElementById('sri-error-message');
                
                if (errorUi) {
                    errorUi.style.display = 'block';
                    if (sriMessage) {
                        sriMessage.style.display = 'block';
                    }
                }
            }
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);

                        // Check for service worker updates periodically
                        registration.addEventListener('updatefound', () => {
                            console.log('New service worker found, installing...');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New worker is installed, we have an old worker controlling the page
                                    console.log('New service worker ready, prompting user to refresh');
                                    
                                    // Optionally, you could show a toast notification here
                                    // For now, we'll let the service worker activation handle cache clearing
                                }
                            });
                        });

                        // Only clear caches on first visit or when service worker updates
                        // This prevents race conditions with WASM file loading and SRI checks
                        if (!navigator.serviceWorker.controller) {
                            console.log('First visit - waiting for service worker to activate');
                        } else if (registration.active && registration.active !== registration.installing) {
                            // Service worker was already active, no need to clear caches
                            console.log('Service worker already active - no cache clearing needed');
                        }

                        // Force update check to ensure latest version
                        registration.update();
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
