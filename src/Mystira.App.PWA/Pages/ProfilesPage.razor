@page "/profiles"
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject IApiClient ApiClient
@inject ILogger<ProfilesPage> Logger
@using Account = Mystira.App.PWA.Models.Account
System.Linq
@using Mystira.App.Domain.Models
@using UserProfile = Mystira.App.PWA.Models.UserProfile

<PageTitle>Manage Profiles â€¢ Mystira</PageTitle>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center loading-container">
        <div class="text-center">
            <div class="spinner-border text-primary-custom mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted">Loading profiles...</p>
        </div>
    </div>
}
else if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center loading-container">
        <div class="text-center">
            <i class="fas fa-lock fa-3x text-warning mb-3"></i>
            <h3>Authentication Required</h3>
            <p class="text-muted mb-4">Please sign in to manage your profiles.</p>
            <a href="/signin" class="btn btn-primary-custom">
                <i class="fas fa-sign-in-alt me-2"></i>Sign In
            </a>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary me-3" @onclick="GoBack">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div>
                            <h2 class="mb-1">Manage Profiles</h2>
                            <p class="text-muted mb-0">Create, edit, and manage player profiles for your adventures</p>
                        </div>
                    </div>
                    <button class="btn btn-primary-custom" @onclick="OpenCreateModal">
                        <i class="fas fa-user-plus me-2"></i>New Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        @successMessage
                        <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        @errorMessage
                        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                    </div>
                </div>
            </div>
        }

        <!-- Profiles List -->
        @if (!profiles.Any())
        {
            <div class="row">
                <div class="col-12">
                    <div class="card text-center">
                        <div class="card-body py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="card-title">No Profiles Yet</h5>
                            <p class="text-muted mb-4">You haven't created any profiles yet. Create your first profile to get
                                started!</p>
                            <button class="btn btn-primary-custom" @onclick="OpenCreateModal">
                                <i class="fas fa-user-plus me-2"></i>Create Your First Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row g-4">
                @foreach (var profile in profiles)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="profile-card h-100">
                            <!-- Avatar Section -->
                            <div class="profile-avatar-section">
                                @if (!string.IsNullOrEmpty(profile.SelectedAvatarMediaId))
                                {
                                    <div class="profile-avatar-wrapper">
                                        <CachedMystiraImage
                                            MediaId="@profile.SelectedAvatarMediaId"
                                            Alt="@($"{profile.Name} avatar")"
                                            ImageClass="profile-avatar-image" />
                                    </div>
                                }
                                else
                                {
                                    <div class="profile-avatar-wrapper profile-avatar-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                }
                                @if (profile.IsGuest)
                                {
                                    <span class="guest-badge" title="Guest Profile">
                                        <i class="fas fa-user-clock"></i>
                                    </span>
                                }
                            </div>

                            <!-- Profile Info -->
                            <div class="profile-info">
                                <h5 class="profile-name">@profile.Name</h5>
                                <span class="profile-age-badge" title="Age Range">
                                    <i class="fas fa-birthday-cake me-1"></i>@GetAgeRangeDisplay(profile.AgeGroup)
                                </span>
                            </div>

                            <!-- Profile Meta -->
                            <div class="profile-meta">
                                <div class="meta-item" title="Profile created on @FormatDate(profile.CreatedAt)">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>@FormatDate(profile.CreatedAt)</span>
                                </div>
                                @if (profile.HasCompletedOnboarding)
                                {
                                    <div class="meta-item meta-success" title="This profile has completed onboarding">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Ready to play</span>
                                    </div>
                                }
                            </div>

                            <!-- Action Buttons -->
                            <div class="profile-actions">
                                <button class="btn-profile-action btn-edit" @onclick="() => OpenEditModal(profile)" title="Edit profile">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                <button class="btn-profile-action btn-delete" @onclick="() => ConfirmDelete(profile)" title="Delete profile">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

<!-- Create/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block modal-backdrop">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @if (isEditMode)
                        {
                            <span>Edit Profile: @editingProfile?.Name</span>
                        }
                        else
                        {
                            <span>Create New Profile</span>
                        }
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <!-- Validation Messages -->
                    @if (!string.IsNullOrEmpty(modalValidationMessage))
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @modalValidationMessage
                        </div>
                    }

                    <!-- Profile Name -->
                    <div class="mb-3">
                        <label class="form-label">Profile Name*</label>
                        <input type="text" class="form-control" @bind="formData.Name" placeholder="Enter profile name" />
                    </div>

                    <!-- Age Group -->
                    <div class="mb-3">
                        <label class="form-label">Age Range*</label>
                        <select class="form-select" @bind="formData.AgeGroup" @bind:after="OnAgeGroupChanged">
                            <option value="">Select age range...</option>
                            @foreach (var ageRange in AgeRanges.All)
                            {
                                <option value="@ageRange">@AgeRanges.GetDisplayName(ageRange)</option>
                            }
                        </select>
                    </div>

                    <!-- Avatar Selection -->
                    @if (!string.IsNullOrEmpty(formData.AgeGroup))
                    {
                        <div class="mb-3">
                            <label class="form-label">Choose Avatar</label>

                            @if (isSelectingAvatar)
                            {
                                <!-- Show avatar carousel while selecting -->
                                <AvatarCarousel AgeGroup="@formData.AgeGroup"
                                                OnAvatarSelected="OnAvatarSelected"
                                                OnCancel="OnAvatarSelectionCanceled" />
                            }
                            else if (isAvatarSelected && !string.IsNullOrEmpty(formData.SelectedAvatarMediaId))
                            {
                                <!-- Show selected avatar -->
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <CachedMystiraImage MediaId="@formData.SelectedAvatarMediaId" Alt="Selected Avatar"
                                                ImageClass="thumbnail-image" Width="150" Height="150" />
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ChangeAvatar">
                                            <i class="fas fa-sync-alt me-2"></i>Change Avatar
                                        </button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- No avatar selected yet; offer to choose -->
                                <button type="button" class="btn btn-outline-primary" @onclick="StartAvatarSelection">
                                    <i class="fas fa-user-circle me-2"></i>Choose Avatar
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Please select an age range first to see available avatars.
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveProfile" disabled="@(isSaving || isSelectingAvatar)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>@(isEditMode ? "Update" : "Create")</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block modal-backdrop">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Profile</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the profile <strong>@profileToDelete?.Name</strong>?</p>
                    <p class="text-muted small">This action cannot be undone and will remove all associated data.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteConfirm">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteProfile" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <span>Delete Profile</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserProfile> profiles = new();
    private Account? currentAccount;
    private bool isLoading = true;
    private bool isAuthenticated = false;

    // Modal state
    private bool showModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private UserProfile? editingProfile;
    private ProfileFormData formData = new();
    private bool isAvatarSelected = false;
    private bool isSelectingAvatar = false;

    // Delete confirmation
    private bool showDeleteConfirm = false;
    private bool isDeleting = false;
    private UserProfile? profileToDelete;

    // Messages
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private string modalValidationMessage = string.Empty;
    private string selectedAvatar = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("Initializing Profiles page");

            currentAccount = await AuthService.GetCurrentAccountAsync();
            if (currentAccount == null)
            {
                isAuthenticated = false;
                isLoading = false;
                StateHasChanged();
                return;
            }

            isAuthenticated = true;
            await LoadProfiles();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing profiles page");
            errorMessage = "Failed to load profiles. Please refresh the page.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            Logger.LogInformation("Loading profiles for account {AccountId}", currentAccount?.Id);

            if (currentAccount == null) return;

            profiles = await ApiClient.GetProfilesByAccountAsync(currentAccount.Id) ?? new List<UserProfile>();
            Logger.LogInformation("Loaded {Count} profiles", profiles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading profiles");
            errorMessage = "Failed to load profiles";
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/home");
    }

    private void OpenCreateModal()
    {
        isEditMode = false;
        editingProfile = null;
        formData = new ProfileFormData();
        modalValidationMessage = string.Empty;
        isAvatarSelected = false;
        isSelectingAvatar = false;
        showModal = true;
    }

    private void OpenEditModal(UserProfile profile)
    {
        isEditMode = true;
        editingProfile = profile;
        formData = new ProfileFormData
        {
            Name = profile.Name,
            AgeGroup = profile.AgeGroup,
            AvatarMediaId = profile.SelectedAvatarMediaId,
            SelectedAvatarMediaId = profile.SelectedAvatarMediaId
        };
        modalValidationMessage = string.Empty;
        isAvatarSelected = !string.IsNullOrEmpty(profile.SelectedAvatarMediaId);
        isSelectingAvatar = false;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editingProfile = null;
        formData = new ProfileFormData();
        modalValidationMessage = string.Empty;
        isAvatarSelected = false;
        isSelectingAvatar = false;
    }

    private async Task SaveProfile()
    {
        try
        {
            modalValidationMessage = string.Empty;

            // Validate
            if (string.IsNullOrWhiteSpace(formData.Name))
            {
                modalValidationMessage = "Profile name is required";
                return;
            }

            // Validate
            if (string.IsNullOrWhiteSpace(formData.AgeGroup))
            {
                modalValidationMessage = "Age Range is required";
                return;
            }

            isSaving = true;
            StateHasChanged();

            if (isEditMode && editingProfile != null)
            {
                // Update existing profile
                var updateRequest = new UpdateUserProfileRequest
                {
                    Name = formData.Name,
                    AgeGroup = formData.AgeGroup,
                    SelectedAvatarMediaId = formData.SelectedAvatarMediaId
                };

                var updated = await ApiClient.UpdateProfileAsync(editingProfile.Id, updateRequest);
                if (updated != null)
                {
                    successMessage = $"Profile '{formData.Name}' updated successfully";
                    await LoadProfiles();
                    CloseModal();
                }
                else
                {
                    errorMessage = "Failed to update profile. Please try again.";
                }
            }
            else
            {
                // Create new profile
                if (currentAccount == null) return;

                var createRequest = new CreateUserProfileRequest
                {
                    Name = formData.Name,
                    AgeGroup = formData.AgeGroup,
                    AvatarMediaId = formData.AvatarMediaId,
                    AccountId = currentAccount.Id,
                    IsGuest = false,
                    HasCompletedOnboarding = false,
                    SelectedAvatarMediaId = formData.SelectedAvatarMediaId
                };

                var created = await ApiClient.CreateProfileAsync(createRequest);
                if (created != null)
                {
                    successMessage = $"Profile '{formData.Name}' created successfully";
                    await LoadProfiles();
                    CloseModal();
                }
                else
                {
                    errorMessage = "Failed to create profile. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving profile");
            errorMessage = "An error occurred while saving the profile";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void ConfirmDelete(UserProfile profile)
    {
        profileToDelete = profile;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        profileToDelete = null;
    }

    private async Task DeleteProfile()
    {
        try
        {
            if (profileToDelete == null) return;

            isDeleting = true;
            StateHasChanged();

            var success = await ApiClient.DeleteProfileAsync(profileToDelete.Id);
            if (success)
            {
                successMessage = $"Profile '{profileToDelete.Name}' deleted successfully";
                await LoadProfiles();
                CloseDeleteConfirm();
            }
            else
            {
                errorMessage = "Failed to delete profile. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting profile");
            errorMessage = "An error occurred while deleting the profile";
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private string GetAgeRangeDisplay(string? ageGroup)
    {
        return ageGroup == null ? "Age group not specified" : AgeGroupConstants.GetDisplayName(ageGroup);
    }

    private string FormatDate(DateTime? date)
    {
        return date?.ToString("MMM d, yyyy") ?? "Unknown";
    }

    private void OnAgeGroupChanged()
    {
        formData.SelectedAvatarMediaId = null;
        formData.AvatarMediaId = null;
        isAvatarSelected = false;
        isSelectingAvatar = true; // prompt user to pick an avatar after changing age group
        StateHasChanged();
    }

    private Task OnAvatarSelected(string mediaId)
    {
        formData.AvatarMediaId = mediaId;
        formData.SelectedAvatarMediaId = mediaId;
        isAvatarSelected = true;
        isSelectingAvatar = false;
        Logger.LogInformation("Avatar selected for profile: {MediaId}", mediaId);
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ChangeAvatar()
    {
        isAvatarSelected = false;
        isSelectingAvatar = true;
        StateHasChanged();
    }

    private void StartAvatarSelection()
    {
        isSelectingAvatar = true;
        StateHasChanged();
    }

    private void OnAvatarSelectionCanceled()
    {
        // User canceled selection; keep previous avatar if it existed
        isSelectingAvatar = false;

        // If we already had a selected avatar (tracked by the bound form data),
        // ensure the UI returns to showing it instead of the "Choose Avatar" state.
        if (!string.IsNullOrEmpty(formData?.SelectedAvatarMediaId))
        {
            isAvatarSelected = true;
        }
        else
        {
            isAvatarSelected = false;
        }

        StateHasChanged();
    }

    private class ProfileFormData
    {
        public string Name { get; set; } = string.Empty;
        public string? AgeGroup { get; set; }
        public string? AvatarMediaId { get; set; }
        public string? SelectedAvatarMediaId { get; set; }
    }
}
