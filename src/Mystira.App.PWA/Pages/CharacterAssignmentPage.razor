@page "/character-assignment/{scenarioId}"
@inject NavigationManager NavigationManager
@inject ICharacterAssignmentService CharacterAssignmentService
@inject IAuthService AuthService
@inject IGameSessionService GameSessionService
@inject IApiClient ApiClient
@inject ILogger<CharacterAssignment> Logger
@inject IJSRuntime JSRuntime
@using System.Linq

<PageTitle>Assign Players - Mystira</PageTitle>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center loading-container">
        <div class="text-center">
            <div class="spinner-border text-primary-custom mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted">Preparing character assignment...</p>
        </div>
    </div>
}
else if (assignmentData?.Scenario == null)
{
    <div class="d-flex justify-content-center align-items-center loading-container">
        <div class="text-center">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h3>Scenario Not Found</h3>
            <p class="text-muted mb-4">We couldn't load the scenario for character assignment.</p>
            <button class="btn btn-primary-custom" @onclick="GoBack">
                <i class="fas fa-arrow-left me-2"></i>Back to Adventures
            </button>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    <div>
                        <h2 class="mb-1">Assign Players</h2>
                        <p class="text-muted mb-0">@assignmentData.Scenario.Title</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Cards Grid -->
        <div class="row g-4 mb-4">
            @for (int i = 0; i < characterAssignments.Count; i++)
            {
                var assignment = characterAssignments[i];
                var cardIndex = i;

                <div class="col-md-6 col-lg-3">
                    <div
                        class="card h-100 character-card @(assignment.IsUnused ? "border-secondary bg-light" : "border-primary")">
                        <div class="card-body d-flex flex-column">
                            <!-- Character Info -->
                            <div class="text-center mb-3">
                                @if (!string.IsNullOrEmpty(assignment.Image))
                                {
                                    <img src="@(ApiClient.GetMediaResourceEndpointUrl(assignment.Image))"
                                        class="character-avatar mb-2" alt="@assignment.CharacterName" />
                                }
                                else
                                {
                                    <div class="character-avatar-placeholder mb-2">
                                        <i class="fas fa-user fa-2x"></i>
                                    </div>
                                }
                                <h6 class="card-title mb-1">@assignment.CharacterName</h6>
                                <small class="text-muted">@assignment.DisplayInfo</small>
                            </div>

                            <!-- Media Controls -->
                            <div class="media-controls">
                                @if (!string.IsNullOrEmpty(assignment.Image))
                                {
                                    <button class="btn-media btn-media-view"
                                        @onclick="() => PreviewImage(ApiClient.GetMediaResourceEndpointUrl(assignment.Image))"
                                        @onclick:stopPropagation="true"
                                        title="View full image">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                }
                                @if (!string.IsNullOrEmpty(assignment.Audio))
                                {
                                    <button class="btn-media btn-media-audio @(isPlayingAudio == assignment.Audio ? "playing" : "")"
                                        @onclick="() => PlayAudio(ApiClient.GetMediaResourceEndpointUrl(assignment.Audio))"
                                        @onclick:stopPropagation="true"
                                        title="@(isPlayingAudio == assignment.Audio ? "Stop audio" : "Play character voice")">
                                        <i class="fas @(isPlayingAudio == assignment.Audio ? "fa-pause" : "fa-volume-up")"></i>
                                    </button>
                                }
                            </div>

                            <!-- Player Assignment -->
                            <div class="mt-auto">
                                @if (assignment.IsUnused)
                                {
                                    <div class="text-center text-muted py-2">
                                        <i class="fas fa-minus-circle mb-1"></i>
                                        <small>Unused Character</small>
                                    </div>
                                }
                                else
                                {
                                    <div class="player-assignment">
                                        @if (assignment.PlayerAssignment == null)
                                        {
                                            <button class="btn-assign-player"
                                                @onclick="async () => await OpenPlayerAssignment(cardIndex)">
                                                <i class="fas fa-user-plus me-2"></i>Assign Player
                                            </button>
                                        }
                                        else
                                        {
                                            <div class="assigned-player-card">
                                                <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(assignment.PlayerAssignment.SelectedAvatarMediaId))
                                                    {
                                                        <div class="player-avatar me-2 player-avatar-large">
                                                            <CachedMystiraImage MediaId="@assignment.PlayerAssignment.SelectedAvatarMediaId"
                                                                Alt="Player Avatar" Width="80" Height="80" />
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="player-avatar-placeholder me-2">
                                                            @if (assignment.PlayerAssignment.Type == "AI")
                                                            {
                                                                <i class="fas fa-robot"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="fas fa-user"></i>
                                                            }
                                                        </div>
                                                    }
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold">@GetPlayerDisplayName(assignment.PlayerAssignment)</div>
                                                        <small class="text-muted">
                                                            @if (assignment.PlayerAssignment.Type == "AI")
                                                            {
                                                                <span class="ai-player-badge">AI Player</span>
                                                            }
                                                            else
                                                            {
                                                                @assignment.PlayerAssignment.Type
                                                            }
                                                        </small>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-danger"
                                                        @onclick="() => RemovePlayerAssignment(cardIndex)" title="Remove">
                                                        &#10060;
                                                    </button>
                                                    <!-- hiding plus button to add as profile for now
                                                                    @if (assignment.PlayerAssignment?.Type == "Guest")
                                                                    {
                                                                           <button class="btn btn-sm btn-outline-primary ms-1" @onclick="() => CreateProfileFromGuest(assignment.PlayerAssignment)" title="Create Profile">
                                                                               <i class="fas fa-user-plus"></i>
                                                                           </button>
                                                                    }
                -->
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-secondary" @onclick="GoBack">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </button>

                    <div class="d-flex gap-2 flex-wrap">
                        @if (HasUnassignedCharacters)
                        {
                            <button class="btn btn-outline-info" @onclick="FillRemainingWithAI"
                                title="Assign Guests players to all remaining unassigned characters">
                                <i class="fas fa-robot me-2"></i>Fill with Guests
                            </button>
                        }

                        <button class="btn btn-outline-primary" @onclick="ManageProfiles">
                            <i class="fas fa-users me-2"></i>Manage Profiles
                        </button>

                        <div class="btn-disabled-wrapper">
                            <button class="btn btn-primary-custom btn-lg" @onclick="BeginSession"
                                disabled="@(!CanBeginSession)">
                                @if (isStartingSession)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Starting...</span>
                                }
                                else
                                {
                                    <i class="fas fa-play me-2"></i>
                                    <span>Begin Session</span>
                                }
                            </button>
                            @if (!CanBeginSession)
                            {
                                <span class="disabled-tooltip">
                                    <i class="fas fa-info-circle me-1"></i>Assign all characters first
                                </span>
                            }
                        </div>
                    </div>
                </div>

                @if (!CanBeginSession)
                {
                    <div class="alert alert-warning mt-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @UnassignedCount character@(UnassignedCount != 1 ? "s" : "") still need@(UnassignedCount == 1 ? "s" : "") a player assignment.
                        </div>
                        <button class="btn btn-sm btn-outline-warning" @onclick="FillRemainingWithAI">
                            <i class="fas fa-robot me-2"></i>Assign Guest to remaining
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Player Assignment Modal -->
@if (showPlayerAssignmentModal)
{
    <div class="modal fade show d-block modal-backdrop">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Player to @currentAssignment?.CharacterName</h5>
                    <button type="button" class="btn-close" @onclick="ClosePlayerAssignment"></button>
                </div>
                <div class="modal-body">
                    <!-- Validation Message -->
                    @if (!string.IsNullOrEmpty(validationMessage))
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @validationMessage
                        </div>
                    }

                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <button class="nav-link @(assignmentTab == "profiles" ? "active" : "")"
                                @onclick="@(() => SetAssignmentTab("profiles"))">
                                <i class="fas fa-users me-1"></i>Profiles
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link @(assignmentTab == "new-profile" ? "active" : "")"
                                @onclick="@(() => SetAssignmentTab("new-profile"))">
                                <i class="fas fa-user-plus me-1"></i>New Profile
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link @(assignmentTab == "guest" ? "active" : "")"
                                @onclick="@(() => SetAssignmentTab("guest"))">
                                <i class="fas fa-user-circle me-1"></i>Guest
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link @(assignmentTab == "ai" ? "active" : "")"
                                @onclick="@(() => SetAssignmentTab("ai"))">
                                <i class="fas fa-robot me-1"></i>AI Player
                            </button>
                        </li>
                    </ul>

                    @if (assignmentTab == "profiles")
                    {
                        <!-- Profiles Tab -->
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Note: A single profile can be used for multiple character assignments.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Profile</label>
                            <select class="form-select" @bind="selectedProfileId">
                                <option value="">Choose a profile...</option>
                                @foreach (var profile in availableProfiles)
                                {
                                    <option value="@profile.Id">@profile.Name (@profile.DisplayAgeRange)</option>
                                }
                            </select>
                        </div>
                    }
                    else if (assignmentTab == "new-profile")
                    {
                        <!-- New Profile Tab -->
                        <div class="mb-3">
                            <label class="form-label">Profile Name *</label>
                            <input type="text" class="form-control" @bind="newProfileName" placeholder="Enter profile name" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Age Group *</label>
                            <select class="form-select" @bind="newProfileAgeRange" @bind:after="OnAgeGroupChanged">
                                <option value="">Select age range...</option>
                                @foreach (var ageRange in AgeRanges.All)
                                {
                                    <option value="@ageRange">@AgeRanges.GetDisplayName(ageRange)</option>
                                }
                            </select>
                        </div>

                        @if (!string.IsNullOrEmpty(newProfileAgeRange))
                        {
                            <div class="mb-3">
                                <label class="form-label">Choose Avatar</label>

                                @if (isAvatarSelected && !string.IsNullOrEmpty(selectedAvatarMediaId))
                                {
                                    <!-- Show selected avatar -->
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <CachedMystiraImage MediaId="@selectedAvatarMediaId" Alt="Selected Avatar"
                                                    ImageClass="thumbnail-image" Width="150" Height="150" />
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ChangeAvatar">
                                                <i class="fas fa-sync-alt me-2"></i>Change Avatar
                                            </button>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <!-- Show avatar carousel -->
                                    <AvatarCarousel AgeGroup="@newProfileAgeRange" OnAvatarSelected="OnAvatarSelected" />
                                }
                            </div>
                        }
                    }
                    else if (assignmentTab == "guest")
                    {
                        <!-- Guest Tab -->
                        <div class="mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" @bind="guestName" placeholder="Enter guest name" />
                        </div>
                    }
                    else if (assignmentTab == "ai")
                    {
                        <!-- AI Player Tab -->
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>AI Player</strong><br />
                            <small>The AI will control this character during the session. Great for solo play or when you have fewer players than characters!</small>
                        </div>

                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-robot fa-4x text-primary-custom"></i>
                            </div>
                            <h6 class="mb-2">AI-Controlled Character</h6>
                            <p class="text-muted small mb-0">
                                The character will be played by the AI assistant, responding naturally during the adventure.
                            </p>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePlayerAssignment">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmPlayerAssignment"
                        disabled="@(!CanConfirmAssignment)">
                        Assign Player
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Image Preview Modal -->
@if (showImagePreview)
{
    <div class="modal fade show d-block modal-backdrop-dark">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center">
                    <img src="@previewImage" class="img-fluid" alt="Character Preview" />
                    <button type="button" class="btn btn-light btn-lg position-absolute top-0 end-0 m-3"
                        @onclick="CloseImagePreview">
                        &#10060;
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string ScenarioId { get; set; } = string.Empty;

    private CharacterAssignmentResponse? assignmentData;
    private List<CharacterAssignment> characterAssignments = new();
    private List<UserProfile> availableProfiles = new();
    private bool isLoading = true;
    private bool isStartingSession = false;

    // Modal state
    private bool showPlayerAssignmentModal = false;
    private bool showImagePreview = false;
    private string assignmentTab = "profiles";
    private CharacterAssignment? currentAssignment;
    private int currentAssignmentIndex = -1;

    // Form state
    private string selectedProfileId = string.Empty;
    private string guestName = string.Empty;
    private string guestAgeRange = string.Empty;
    private string newProfileName = string.Empty;
    private string newProfileAgeRange = string.Empty;
    private string? selectedAvatarMediaId;
    private string? previewImage;
    private string validationMessage = string.Empty;
    private bool isAvatarSelected = false;

    // Audio
    private string? isPlayingAudio = null;
    private IJSObjectReference? audioModule;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("Initializing character assignment for scenario: {ScenarioId}", ScenarioId);
            await LoadCharacterAssignmentData();

            // Load the audio module when component initializes
            audioModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
            "import", "./js/audioPlayer.js");

        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing character assignment");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCharacterAssignmentData()
    {
        assignmentData = await CharacterAssignmentService.GetCharacterAssignmentDataAsync(ScenarioId, characterAssignments);

        if (assignmentData != null)
        {
            characterAssignments = assignmentData.CharacterAssignments;
            availableProfiles = assignmentData.AvailableProfiles;
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/home");
    }

    private async Task CreateGuestProfileImmediately(PlayerAssignment guest)
    {
        try
        {
            var account = await AuthService.GetCurrentAccountAsync();
            if (account == null)
            {
                Logger.LogError("No account found for creating profile");
                return;
            }

            var profileRequest = new CreateUserProfileRequest
            {
                Name = guest.GuestName!,
                AgeGroup = guest.GuestAgeRange ?? "1-2",
                AccountId = account.Id,
                IsGuest = false // This is now a real profile
            };

            var createdProfile = await ApiClient.CreateProfileAsync(profileRequest);
            if (createdProfile != null)
            {
                // Update the guest assignment to use the new profile
                guest.ProfileId = createdProfile.Id;
                guest.ProfileName = createdProfile.Name;
                guest.Type = "Profile"; // Change from Guest to Profile

                Logger.LogInformation("Successfully created profile from guest: {ProfileName}", createdProfile.Name);

                // Refresh available profiles
                await LoadCharacterAssignmentData();

                // Update UI
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating profile from guest: {GuestName}", guest.GuestName);
        }
    }

    private async Task OpenPlayerAssignment(int index)
    {
        try
        {
            currentAssignmentIndex = index;
            currentAssignment = characterAssignments[index];
            showPlayerAssignmentModal = true;

            // Reset form state
            selectedProfileId = string.Empty;
            guestName = string.Empty;
            guestAgeRange = string.Empty;
            newProfileName = string.Empty;
            newProfileAgeRange = string.Empty;
            selectedAvatarMediaId = null;
            isAvatarSelected = false;
            assignmentTab = "profiles";
            validationMessage = string.Empty;

            // Pre-load profiles when modal opens
            if (!availableProfiles.Any())
            {
                Logger.LogInformation("Pre-loading available profiles for character assignment");
                availableProfiles = await CharacterAssignmentService.GetAvailableProfilesAsync() ?? new List<UserProfile>();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error opening player assignment modal");
        }
    }

    private void ClosePlayerAssignment()
    {
        showPlayerAssignmentModal = false;
        currentAssignment = null;
        currentAssignmentIndex = -1;
    }

    private void SetAssignmentTab(string tab)
    {
        assignmentTab = tab;
    }

    private void OnAgeGroupChanged()
    {
        selectedAvatarMediaId = null;
        isAvatarSelected = false;
        StateHasChanged();
    }

    private Task OnAvatarSelected(string mediaId)
    {
        selectedAvatarMediaId = mediaId;
        isAvatarSelected = true;
        Logger.LogInformation("Avatar selected: {MediaId}", mediaId);
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ChangeAvatar()
    {
        isAvatarSelected = false;
        StateHasChanged();
    }

    private async Task ConfirmPlayerAssignment()
    {
        if (currentAssignmentIndex < 0 || currentAssignment == null) return;

        // Clear previous validation message
        validationMessage = string.Empty;

        var playerAssignment = new PlayerAssignment();

        if (assignmentTab == "profiles" && !string.IsNullOrEmpty(selectedProfileId))
        {
            var profile = availableProfiles.FirstOrDefault(p => p.Id == selectedProfileId);
            if (profile != null)
            {
                playerAssignment.Type = "Profile";
                playerAssignment.ProfileId = profile.Id;
                playerAssignment.ProfileName = profile.Name;
                playerAssignment.ProfileImage = null;
                playerAssignment.SelectedAvatarMediaId = profile.SelectedAvatarMediaId;
            }
        }
        else if (assignmentTab == "new-profile" && !string.IsNullOrEmpty(newProfileName) &&
        !string.IsNullOrEmpty(newProfileAgeRange))
        {
            // Create the new profile immediately
            var account = await AuthService.GetCurrentAccountAsync();
            if (account == null)
            {
                validationMessage = "Unable to create profile. Please try again.";
                StateHasChanged();
                return;
            }

            var profileRequest = new CreateUserProfileRequest
            {
                Name = newProfileName,
                AgeGroup = newProfileAgeRange,
                AccountId = account.Id,
                IsGuest = false,
                AvatarMediaId = selectedAvatarMediaId,
                SelectedAvatarMediaId = selectedAvatarMediaId
            };

            var createdProfile = await ApiClient.CreateProfileAsync(profileRequest);
            if (createdProfile != null)
            {
                playerAssignment.Type = "Profile";
                playerAssignment.ProfileId = createdProfile.Id;
                playerAssignment.ProfileName = createdProfile.Name;
                playerAssignment.ProfileImage = null;
                playerAssignment.SelectedAvatarMediaId = createdProfile.SelectedAvatarMediaId;

                // Add the newly created profile to available profiles list
                availableProfiles.Add(createdProfile);

                Logger.LogInformation("Added new profile to available profiles: {ProfileName} with avatar: {AvatarId}",
                createdProfile.Name, createdProfile.SelectedAvatarMediaId);
            }
            else
            {
                validationMessage = "Failed to create profile. Please try again.";
                StateHasChanged();
                return;
            }
        }
        else if (assignmentTab == "guest" && !string.IsNullOrEmpty(guestName))
        {
            playerAssignment.Type = "Guest";
            playerAssignment.GuestName = guestName;
            playerAssignment.GuestAgeRange = guestAgeRange;
            playerAssignment.SaveAsProfile = false;
        }
        else if (assignmentTab == "ai")
        {
            playerAssignment.Type = "AI";
            playerAssignment.GuestName = $"AI ({currentAssignment?.CharacterName ?? "Player"})";
            playerAssignment.ProfileName = $"AI ({currentAssignment?.CharacterName ?? "Player"})";
        }

        if (!string.IsNullOrEmpty(playerAssignment.Type))
        {
            characterAssignments[currentAssignmentIndex].PlayerAssignment = playerAssignment;
            ClosePlayerAssignment();
            StateHasChanged();
        }
    }

    private void RemovePlayerAssignment(int index)
    {
        characterAssignments[index].PlayerAssignment = null;
        StateHasChanged();
    }

    private async Task BeginSession()
    {
        if (!CanBeginSession) return;

        try
        {
            isStartingSession = true;
            StateHasChanged();

            Logger.LogInformation("Beginning session with character assignments for scenario: {ScenarioId}", ScenarioId);

            // Get current account
            var account = await AuthService.GetCurrentAccountAsync();
            if (account == null)
            {
                Logger.LogError("No account found for starting session");
                return;
            }

            // Create guest profiles if needed (for any remaining guests that weren't created immediately)
            var guestProfilesToCreate = characterAssignments
            .Where(ca => ca.PlayerAssignment?.Type == "Guest" && ca.PlayerAssignment.SaveAsProfile == true &&
            string.IsNullOrEmpty(ca.PlayerAssignment.ProfileId))
            .Select(ca => ca.PlayerAssignment!)
            .ToList();

            if (guestProfilesToCreate.Any())
            {
                foreach (var guest in guestProfilesToCreate)
                {
                    var guestProfileRequest = new CreateGuestProfileRequest
                    {
                        Name = guest.GuestName!,
                        AgeRange = guest.GuestAgeRange,
                        AccountId = account.Id,
                        IsGuest = false // Saving as real profile
                    };

                    var createdProfile = await CharacterAssignmentService.CreateGuestProfileAsync(guestProfileRequest);
                    if (createdProfile != null)
                    {
                        guest.ProfileId = createdProfile.Id;
                        guest.ProfileName = createdProfile.Name;
                    }
                }
            }

            // Set character assignments in GameSessionService for text replacement
            GameSessionService.SetCharacterAssignments(characterAssignments);

            // Start the game session
            var request = new StartGameSessionRequest
            {
                ScenarioId = ScenarioId,
                AccountId = account.Id,
                ProfileId = account.UserProfileIds.FirstOrDefault() ?? "default-profile",
                CharacterAssignments = characterAssignments,
                TargetAgeGroup = assignmentData!.Scenario.AgeGroup,
                Scenario = assignmentData!.Scenario // Pass the full scenario for local session setup
            };

            var success = await CharacterAssignmentService.StartGameSessionWithAssignmentsAsync(request);

            if (success)
            {
                Logger.LogInformation("Session started successfully, navigating to {NavigationManagerBaseUri}game",
                NavigationManager.BaseUri);
                NavigationManager.NavigateTo("/game");
            }
            else
            {
                Logger.LogError("Failed to start game session");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error beginning session");
        }
        finally
        {
            isStartingSession = false;
            StateHasChanged();
        }
    }

    private void ManageProfiles()
    {
        Logger.LogInformation("Navigating to profiles management page");
        NavigationManager.NavigateTo("/profiles");
    }

    private void PreviewImage(string imageUrl)
    {
        previewImage = imageUrl;
        showImagePreview = true;
    }

    private void CloseImagePreview()
    {
        showImagePreview = false;
        previewImage = null;
    }

    private async Task PlayAudio(string audioUrl)
    {
        try
        {
            if (audioModule == null)
            {
                return;
            }

            if (isPlayingAudio == audioUrl)
            {
                // Stop the currently playing audio
                await audioModule.InvokeVoidAsync("stopAudio");
                isPlayingAudio = null;
            }
            else
            {
                // Stop any currently playing audio first
                if (!string.IsNullOrEmpty(isPlayingAudio))
                {
                    await audioModule.InvokeVoidAsync("stopAudio");
                }

                // Start playing the new audio
                await audioModule.InvokeVoidAsync("playAudio", audioUrl);
                isPlayingAudio = audioUrl;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error playing audio: {ex.Message}");
            // Optionally handle the error in the UI
        }
        finally
        {
            StateHasChanged();
        }
    }


    private async Task CreateProfileFromGuest(PlayerAssignment guest)
    {
        try
        {
            var account = await AuthService.GetCurrentAccountAsync();
            if (account == null)
            {
                Logger.LogError("No account found for creating profile");
                return;
            }

            var profileRequest = new CreateUserProfileRequest
            {
                Name = guest.GuestName!,
                AgeGroup = guest.GuestAgeRange ?? "1-2",
                AccountId = account.Id,
                IsGuest = false // This is now a real profile
            };

            var createdProfile = await ApiClient.CreateProfileAsync(profileRequest);
            if (createdProfile != null)
            {
                // Update the guest assignment to use the new profile
                guest.ProfileId = createdProfile.Id;
                guest.ProfileName = createdProfile.Name;
                guest.Type = "Profile"; // Change from Guest to Profile

                // Refresh available profiles
                await LoadCharacterAssignmentData();

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating profile from guest: {GuestName}", guest.GuestName);
        }
    }

    private string GetAgeGroupNameFromRange(string? ageRange)
    {
        return ageRange switch
        {
            "1-2" => "toddlers",
            "3-5" => "preschoolers",
            "6-9" => "school",
            "10-12" => "preteens",
            "13-18" => "teens",
            _ => "school"
        };
    }

    private string ToTitleCase(string input)
    {
        if (string.IsNullOrEmpty(input))
            return string.Empty;

        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(input.ToLower());
    }

    private string GetPlayerDisplayName(PlayerAssignment assignment)
    {
        return assignment.Type switch
        {
            "Profile" => assignment.ProfileName ?? "Unknown Profile",
            "Guest" => assignment.GuestName ?? "Unknown Guest",
            "AI" => assignment.ProfileName ?? "AI Player",
            _ => "Unknown Player"
        };
    }

    private bool CanConfirmAssignment
    {
        get
        {
            if (assignmentTab == "profiles")
                return !string.IsNullOrEmpty(selectedProfileId);
            else if (assignmentTab == "new-profile")
                return !string.IsNullOrEmpty(newProfileName) && !string.IsNullOrEmpty(newProfileAgeRange);
            else if (assignmentTab == "ai")
                return true; // AI assignment is always valid
            else
                return !string.IsNullOrEmpty(guestName);
        }
    }

    private bool CanBeginSession
    {
        get
        {
            return characterAssignments.All(ca =>
            ca.IsUnused || (ca.PlayerAssignment != null && !string.IsNullOrEmpty(ca.PlayerAssignment.Type)));
        }
    }

    private bool HasUnassignedCharacters
    {
        get
        {
            return characterAssignments.Any(ca =>
                !ca.IsUnused && ca.PlayerAssignment == null);
        }
    }

    private int UnassignedCount
    {
        get
        {
            return characterAssignments.Count(ca =>
                !ca.IsUnused && ca.PlayerAssignment == null);
        }
    }

    private void FillRemainingWithAI()
    {
        foreach (var assignment in characterAssignments)
        {
            if (!assignment.IsUnused && assignment.PlayerAssignment == null)
            {
                assignment.PlayerAssignment = new PlayerAssignment
                {
                    Type = "AI",
                    ProfileName = $"Guest ({assignment.CharacterName})",
                    GuestName = $"Guest ({assignment.CharacterName})"
                };
            }
        }
        StateHasChanged();
        Logger.LogInformation("Filled {Count} unassigned characters with Guest players", UnassignedCount);
    }
}
