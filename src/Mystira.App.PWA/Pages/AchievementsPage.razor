@page "/achievements"
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject IProfileService ProfileService
@inject IPlayerContextService PlayerContextService
@inject IAchievementsService AchievementsService
@inject ILogger<AchievementsPage> Logger

<PageTitle>Achievements â€¢ Mystira</PageTitle>

<div class="container-fluid py-4 achievements-page @GetAgeGroupCssClass(model?.AgeGroupId)">
    @if (isLoading)
    {
        <LoadingIndicator Message="Loading achievements..." />
    }
    else if (!isAuthenticated)
    {
        <div class="d-flex justify-content-center align-items-center loading-container">
            <div class="text-center">
                <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                <h3>Authentication Required</h3>
                <p class="text-muted mb-4">Please sign in to see your achievements.</p>
                <a href="/signin" class="btn btn-primary-custom">
                    <i class="fas fa-sign-in-alt me-2"></i>Sign In
                </a>
            </div>
        </div>
    }
    else if (!profiles.Any())
    {
        <EmptyState IconClass="fas fa-user-friends fa-4x"
                   Title="Create a Profile to Start Earning Badges"
                   Message="Profiles help Mystira pick the right adventures and achievements for each player."
                   ShowClearButton="false">
            <a class="btn btn-primary-custom" href="/profiles">
                <i class="fas fa-users me-2"></i>Manage Profiles
            </a>
        </EmptyState>
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <EmptyState IconClass="fas fa-exclamation-triangle fa-4x"
                   Title="Couldn't Load Achievements"
                   Message="@errorMessage"
                   ShowClearButton="false"
                   ShowRetryButton="true"
                   OnRetry="ReloadAsync">
            <a class="btn btn-outline-secondary" href="/adventures">
                <i class="fas fa-compass me-2"></i>Continue Adventures
            </a>
        </EmptyState>
    }
    // Note: Do not render the empty state here to ensure the header/back button
    // remains visible even when a profile has no badges. The empty state is
    // rendered later, below the header, based on computed visibility.
    else
    {
        @if (isSelectingProfile && profiles.Count > 1)
        {
            <div class="row g-3 profile-grid mb-4">
                @foreach (var p in profiles)
                {
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <div class="card profile-card h-100" @onclick="(() => OnProfileCardClicked(p))">
                            <div class="card-body d-flex flex-column align-items-center text-center">
                                <div class="profile-icon mb-3">
                                    @if (!string.IsNullOrEmpty(p.SelectedAvatarMediaId))
                                    {
                                        <CachedMystiraImage MediaId="@p.SelectedAvatarMediaId" Alt="@($"{p.Name} avatar")" ImageClass="profile-avatar-image" />
                                    }
                                    else
                                    {
                                        <i class="fas fa-user-circle"></i>
                                    }
                                </div>
                                <div class="profile-title">@p.Name</div>
                                <div class="text-muted small">@AgeRanges.GetDisplayName(p.AgeGroup ?? model?.AgeGroupId ?? "")</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <div class="row mb-4" hidden="@(isSelectingProfile && profiles.Count > 1)">
            <div class="col-12">
                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                    <div>
                        <h2 class="mb-1">@GetHeaderTitle(model?.AgeGroupId ?? selectedProfile?.AgeGroup ?? "")</h2>
                        <p class="text-muted mb-0">
                            Tracking progress for <strong>@(selectedProfile?.Name ?? model?.ProfileName)</strong>
                            <span class="ms-1">(@AgeRanges.GetDisplayName(model?.AgeGroupId ?? selectedProfile?.AgeGroup ?? ""))</span>
                        </p>
                    </div>

                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                        @if (profiles.Count > 1)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="ShowProfileSelection">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </button>
                        }
                        <div class="btn-group view-toggle" role="group" aria-label="View mode">
                            <button type="button" class="btn btn-sm @(viewMode == ViewMode.Simplified ? "btn-primary" : "btn-outline-secondary")" @onclick="(() => SetViewMode(ViewMode.Simplified))">
                                <i class="fas fa-th me-2"></i>Simplified
                            </button>
                            <button type="button" class="btn btn-sm @(viewMode == ViewMode.Advanced ? "btn-primary" : "btn-outline-secondary")" @onclick="(() => SetViewMode(ViewMode.Advanced))">
                                <i class="fas fa-list me-2"></i>Advanced
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        // Only compute visible axes when we actually have a model loaded.
        IReadOnlyList<AxisAchievementsSectionViewModel> visibleAxes = model is null
            ? Array.Empty<AxisAchievementsSectionViewModel>()
            : AchievementsFiltering.Apply(model, filterOptions);

        @if (isSelectingProfile && profiles.Count > 1)
        {
            <!-- When selecting a profile, suppress achievements empty-state rendering -->
        }
        else if (visibleAxes.Count == 0)
        {
            <EmptyState IconClass="fas fa-trophy fa-4x"
                       Title="No Badges Yet"
                       Message="Complete adventures to start earning achievements!"
                       ShowClearButton="false">
                <a class="btn btn-primary-custom" href="/adventures">
                    <i class="fas fa-compass me-2"></i>Continue Adventures
                </a>
            </EmptyState>
        }
        else
        {
            if (viewMode == ViewMode.Simplified)
            {
                // Simplified grid: badges only
                var allTiers = visibleAxes.SelectMany(a => a.Tiers)
                    .Where(t => t.IsEarned)
                    .ToList();
                <div class="simplified-grid">
                    @foreach (var tier in allTiers)
                    {
                        <button type="button" class="badge-thumb earned" title="@tier.Title" @onclick="(() => OpenTierModal(tier))">
                            @if (!string.IsNullOrWhiteSpace(tier.ImageUrl))
                            {
                                <img src="@tier.ImageUrl" alt="@tier.Title" loading="lazy" />
                            }
                            else
                            {
                                <i class="fas fa-medal"></i>
                            }
                        </button>
                    }
                </div>

                @if (modalTier is not null)
                {
                    <div class="modal fade show d-block modal-backdrop">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">@modalTier.Title (@modalTier.Tier)</h5>
                                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseTierModal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex flex-column gap-3">
                                        <div class="ratio ratio-16x9">
                                            @if (!string.IsNullOrWhiteSpace(modalTier.ImageUrl))
                                            {
                                                <img src="@modalTier.ImageUrl" alt="@modalTier.Title" class="w-100 h-100 object-cover rounded" />
                                            }
                                            else
                                            {
                                                <div class="d-flex align-items-center justify-content-center bg-light rounded">
                                                    <i class="fas fa-medal fa-3x opacity-75"></i>
                                                </div>
                                            }
                                        </div>

                                        <div>
                                            <p class="mb-2">@modalTier.Description</p>
                                            @if (modalTier.IsEarned)
                                            {
                                                <div class="text-success fw-semibold mb-1">Earned</div>
                                            }
                                            @if (modalTier.IsEarned && modalTier.EarnedAt.HasValue)
                                            {
                                                <div class="text-success small">
                                                    <i class="fas fa-calendar-check me-1"></i>
                                                    Earned @modalTier.EarnedAt.Value.ToLocalTime().ToString("dd-MMM-yyyy")
                                                </div>
                                            }
                                            @if (!modalTier.IsEarned)
                                            {
                                                <div class="tier-progress-container">
                                                    <div class="progress">
                                                        <div class="progress-bar" role="progressbar" style="width: @($"{modalTier.ProgressPercent}%")" aria-valuenow="@((int)modalTier.ProgressPercent)" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="CloseTierModal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                @foreach (var axis in visibleAxes)
                {
                    <div class="card axis-card mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
                                <div>
                                    <h5 class="mb-1">@axis.AxisName</h5>
                                </div>
                                <span class="badge bg-secondary">@axis.Tiers.Count tier@(axis.Tiers.Count == 1 ? "" : "s")</span>
                            </div>

                            @if (axis.AxisCopy.Any())
                            {
                                <div class="axis-copy mb-3">
                                    @foreach (var copy in axis.AxisCopy)
                                    {
                                        <div class="axis-copy-item">
                                            <span class="axis-copy-direction">@GetDirectionLabel(copy.Direction)</span>
                                            <span class="axis-copy-text">@copy.Description</span>
                                        </div>
                                    }
                                </div>
                            }

                            <div class="row g-3">
                                @foreach (var tier in axis.Tiers)
                                {
                                    <div class="col-12 col-md-6 col-lg-4">
                                        <div class="tier-card tier-@GetTierCssSuffix(tier.Tier) @(tier.IsEarned ? "earned" : "") @(IsTierExpanded(tier) ? "expanded" : "")" data-tier="@tier.Tier">
                                            <div class="tier-card-header">
                                                <div class="tier-image">
                                                    @if (!string.IsNullOrWhiteSpace(tier.ImageUrl))
                                                    {
                                                        <img src="@tier.ImageUrl" alt="@tier.Title" loading="lazy" />
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-medal"></i>
                                                    }
                                                </div>
                                                <div class="tier-title">
                                                    <div class="tier-label">@tier.Tier</div>
                                                    <div class="tier-name">@tier.Title</div>
                                                </div>
                                                @if (tier.IsEarned)
                                                {
                                                    <div class="tier-earned-badge" title="Earned">
                                                        <i class="fas fa-star"></i>
                                                    </div>
                                                }
                                                @if (tier.IsEarned)
                                                {
                                                    <button type="button" class="btn btn-link btn-sm tier-info-toggle" title="More info" @onclick="(() => ToggleTierInfo(tier))">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                }
                                            </div>

                                            <div class="tier-card-body">
                                                 @if (IsTierExpanded(tier))
                                                 {
                                                     <p class="tier-description">@tier.Description</p>
                                                 }

                                                 @if (tier.IsEarned)
                                                 {
                                                     <div class="text-success fw-semibold">Earned</div>
                                                 }

                                                 @if (tier.IsEarned && tier.EarnedAt.HasValue)
                                                 {
                                                     <div class="tier-earned-at">
                                                         <i class="fas fa-calendar-check me-1"></i>
                                                         Earned @tier.EarnedAt.Value.ToLocalTime().ToString("dd-MMM-yyyy")
                                                     </div>
                                                 }

                                                 @if (!tier.IsEarned)
                                                 {
                                                     <div class="tier-progress-container">
                                                         <div class="progress">
                                                             <div class="progress-bar" role="progressbar" style="width: @($"{tier.ProgressPercent}%")" aria-valuenow="@((int)tier.ProgressPercent)" aria-valuemin="0" aria-valuemax="100"></div>
                                                         </div>
                                                      </div>
                                                  }
                                              </div>
                                         </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        }
    }
</div>

@code {
    private bool isLoading = true;
    private bool isAuthenticated;
    private List<UserProfile> profiles = new();
    private UserProfile? selectedProfile;
    private AchievementsViewModel? model;
    private string? errorMessage;
    private bool isSelectingProfile;
    private readonly HashSet<string> expandedTierKeys = new(StringComparer.OrdinalIgnoreCase);
    private ViewMode viewMode = ViewMode.Simplified;
    private BadgeTierViewModel? modalTier;

    private readonly AchievementsFilterOptions filterOptions = new() { ShowEarned = true, ShowInProgress = true };

    protected override async Task OnInitializedAsync()
    {
        await InitializeAsync();
    }

    private async Task InitializeAsync()
    {
        isLoading = true;
        errorMessage = null;
        model = null;

        try
        {
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                return;
            }

            var account = await AuthService.GetCurrentAccountAsync();
            if (account == null)
            {
                errorMessage = "Unable to load your account.";
                return;
            }

            profiles = await ProfileService.GetUserProfilesAsync(account.Id) ?? new List<UserProfile>();
            if (!profiles.Any())
            {
                return;
            }

            // If only one profile, auto-select and load achievements; otherwise show selection grid
            if (profiles.Count == 1)
            {
                selectedProfile = profiles[0];
                await PlayerContextService.SetSelectedProfileIdAsync(selectedProfile.Id);
                await LoadAchievementsAsync(selectedProfile);
                isSelectingProfile = false;
            }
            else
            {
                isSelectingProfile = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing achievements page");
            errorMessage = "Something went wrong while loading achievements.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadAchievementsAsync(UserProfile profile)
    {
        var result = await AchievementsService.GetAchievementsAsync(profile);
        if (!result.IsSuccess)
        {
            errorMessage = result.ErrorMessage;
            model = null;
            return;
        }

        model = result.Data;
        errorMessage = null;
    }

    private async Task ReloadAsync()
    {
        if (selectedProfile != null)
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            await InitializeAsync();
        }
        else
        {
            await InitializeAsync();
        }
    }

    private void ShowProfileSelection()
    {
        isSelectingProfile = true;
        model = null;
    }

    private async Task OnProfileCardClicked(UserProfile profile)
    {
        selectedProfile = profile;
        await PlayerContextService.SetSelectedProfileIdAsync(profile.Id);

        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        await LoadAchievementsAsync(profile);

        isSelectingProfile = false;
        isLoading = false;
        StateHasChanged();
    }

    private void ResetFilters() { }

    private void SetViewMode(ViewMode mode) => viewMode = mode;

    private void OpenTierModal(BadgeTierViewModel tier)
    {
        modalTier = tier;
    }

    private void CloseTierModal()
    {
        modalTier = null;
    }

    private string GetTierKey(BadgeTierViewModel tier) => $"{tier.BadgeId}:{tier.Tier}";
    private bool IsTierExpanded(BadgeTierViewModel tier) => expandedTierKeys.Contains(GetTierKey(tier));
    private void ToggleTierInfo(BadgeTierViewModel tier)
    {
        var key = GetTierKey(tier);
        if (!expandedTierKeys.Add(key))
        {
            expandedTierKeys.Remove(key);
        }
    }

    private static string GetTierCssSuffix(string tier)
    {
        return tier.Trim().ToLowerInvariant() switch
        {
            "bronze" => "bronze",
            "silver" => "silver",
            "gold" => "gold",
            _ => "default"
        };
    }

    private static string GetDirectionLabel(string direction)
    {
        return direction.Trim().ToLowerInvariant() switch
        {
            "positive" => "Positive choices",
            "negative" => "Other choices",
            _ => ""
        };
    }

    private static string GetHeaderTitle(string ageGroupId)
    {
        return ageGroupId switch
        {
            "1-2" or "3-5" or "6-9" => "Your Adventure Badges",
            _ => "Achievements"
        };
    }

    private static string GetAgeGroupCssClass(string? ageGroupId)
    {
        if (string.IsNullOrWhiteSpace(ageGroupId))
        {
            return "";
        }

        return ageGroupId switch
        {
            "19+" => "age-group-19plus",
            _ => $"age-group-{ageGroupId.Replace("+", "plus")}".Replace(" ", "")
        };
    }
}

@code {
    private enum ViewMode
    {
        Simplified,
        Advanced
    }
}
