@page "/"
@page "/home"
@using Mystira.App.PWA.Models
@using Mystira.App.PWA.Services
@implements IDisposable

<PageTitle>Mystira</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-4 text-primary-custom">
                <i class="fas fa-dragon me-3"></i>
                Mystira
            </h1>
            <p class="lead text-muted">
                Dynamic Adventures for Young Heroes
            </p>
        </div>
    </div>
    
    <style>
        .dice-roller-container {
            max-width: 300px; /* Adjust this value to control the width */
            margin: 0 auto; /* This centers the container horizontally */
            padding: 15px;
            background-color: var(--bs-body-bg, white);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    
    @if (isLoading)
    {
        <div class="row justify-content-center">
            <div class="col-auto text-center">
                <div class="loading-spinner mb-3"></div>
                <p class="text-muted">Loading adventures...</p>
            </div>
        </div>
    }
    else if (!isAuthenticated)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-lg">
                    <div class="card-body p-5 text-center">
                        <i class="fas fa-user-shield fa-4x text-primary-custom mb-4"></i>
                        <h3 class="card-title mb-3">Welcome to Mystira</h3>
                        <p class="card-text text-muted mb-4">
                            Sign in to access your adventures and create memorable experiences for young heroes.
                        </p>
                        <button class="btn btn-primary-custom btn-lg" @onclick="ShowSignIn">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Sign In
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (scenarios.Any())
    {
        <div class="row">
            @foreach (var scenario in scenarios)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card scenario-card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@scenario.Name</h5>
                            <p class="card-text flex-grow-1">@scenario.Description</p>
                            
                            <div class="mt-auto">
                                <!-- Scenario Metadata -->
                                <div class="scenario-metadata mb-3">
                                    <!-- Group AgeGroup, Difficulty, and Session Length badges in one row -->
                                    <div class="d-flex flex-wrap mb-2">
                                        <span class="badge bg-info text-dark me-1 mb-1">
                                            <i class="fas fa-users me-1"></i>Ages @scenario.AgeGroup
                                        </span>
                                        <span class="badge bg-warning me-1 mb-1">
                                            <i class="fas fa-signal me-1"></i>@scenario.Difficulty
                                        </span>
                                        <span class="badge bg-success me-1 mb-1">
                                            <i class="fas fa-clock me-1"></i>@scenario.SessionLength
                                        </span>
                                    </div>
        
                                    <!-- Core Axes in a separate row -->
                                    @if (scenario.CoreAxes != null && scenario.CoreAxes.Any())
                                    {
                                        <div class="d-flex flex-wrap mb-2">
                                            @foreach (var axis in scenario.CoreAxes.Take(4))
                                            {
                                                <span class="badge bg-primary me-1 mb-1">@axis</span>
                                            }
                                            @if (scenario.CoreAxes.Count > 4)
                                            {
                                                <span class="badge bg-primary mb-1">+@(scenario.CoreAxes.Count - 4)</span>
                                            }
                                        </div>
                                    }
        
                                    <!-- Tags in a separate row -->
                                    @if (scenario.Tags?.Any() == true)
                                    {
                                        <div class="d-flex flex-wrap">
                                            @foreach (var tag in scenario.Tags.Take(3))
                                            {
                                                <span class="badge bg-secondary me-1 mb-1">@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(tag.ToLower())</span>
                                            }
                                            @if (scenario.Tags.Length > 3)
                                            {
                                                <span class="badge bg-secondary mb-1">+@(scenario.Tags.Length - 3)</span>
                                            }
                                        </div>
                                    }
                                </div>
                                
                                <button class="btn btn-primary-custom btn-lg w-100" 
                                        @onclick="() => StartAdventure(scenario)"
                                        disabled="@isStartingAdventure">
                                    @if (isStartingAdventure)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Starting...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-play me-2"></i>
                                        <span>Start Adventure</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h3>No Adventures Available</h3>
                        <p class="text-muted mb-4">
                            We couldn't load any adventures right now. This might be due to a connection issue.
                        </p>
                        <button class="btn btn-primary-custom" @onclick="LoadScenarios">
                            <i class="fas fa-refresh me-2"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Inject] private IAuthService AuthService { get; set; } = default!;
    [Inject] private IApiClient ApiClient { get; set; } = default!;
    [Inject] private IGameSessionService GameSessionService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private ILogger<Home> Logger { get; set; } = default!;

    private List<Scenario> scenarios = new();
    private bool isLoading = true;
    private bool isStartingAdventure = false;
    private bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            Logger.LogInformation("Home component initializing...");
            
            // Subscribe to authentication state changes
            AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
            
            // Check current authentication status
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            
            Logger.LogInformation("Auth service initialized. IsAuthenticated: {IsAuthenticated}", isAuthenticated);
            
            // Load scenarios only if authenticated
            if (isAuthenticated) 
            {
                await LoadScenarios();
            }
            else 
            {
                isLoading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during component initialization");
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnAuthenticationStateChanged(object? sender, bool authenticated)
    {
        isAuthenticated = authenticated;
        InvokeAsync(async () => 
        {
            if (authenticated)
            {
                await LoadScenarios();
            }
            else 
            {
                scenarios.Clear();
            }
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        if (AuthService != null)
        {
            AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
    }

    private async Task LoadScenarios()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("Loading scenarios...");
            scenarios = await ApiClient.GetScenariosAsync();
            Logger.LogInformation("Loaded {Count} scenarios", scenarios.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scenarios");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task StartAdventure(Scenario scenario)
    {
        try
        {
            isStartingAdventure = true;
            StateHasChanged();
            
            Logger.LogInformation("Starting adventure: {ScenarioName}", scenario.Name);
            
            // Clear any existing game session
            GameSessionService.ClearGameSession();
            
            // Get the full scenario with scenes
            var fullScenario = await ApiClient.GetScenarioAsync(scenario.Id);
            if (fullScenario == null)
            {
                Logger.LogError("Could not load scenario details for: {ScenarioName}", scenario.Name);
                return;
            }
            
            // Start the game session
            var success = await GameSessionService.StartGameSessionAsync(fullScenario);
            if (success)
            {
                Logger.LogInformation("Game session started successfully for: {ScenarioName}", scenario.Name);
                Navigation.NavigateTo("/game");
            }
            else
            {
                Logger.LogError("Failed to start game session for: {ScenarioName}", scenario.Name);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting adventure: {ScenarioName}", scenario.Name);
        }
        finally
        {
            isStartingAdventure = false;
            StateHasChanged();
        }
    }

    private async Task ShowSignIn()
    {
        try
        {
            Logger.LogInformation("Performing demo sign in...");
            
            // For demo purposes, use a simple authentication
            var success = await AuthService.LoginAsync("demo@mystira.com", "password");
            
            if (success)
            {
                Logger.LogInformation("Demo sign in successful");
            }
            else
            {
                Logger.LogError("Demo sign in failed");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during sign in");
        }
    }
}
