@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject IProfileService ProfileService
@inject IGameSessionService GameSessionService
@inject IApiClient ApiClient
@inject ILogger<Home> Logger

@page "/"
@page "/home"
@using Mystira.App.PWA.Models
@using Mystira.App.PWA.Services
@using Mystira.App.PWA.Components
@using SessionStatus = Mystira.App.Domain.Models.SessionStatus
@implements IDisposable

<PageTitle>Mystira</PageTitle>

<div class="container-fluid py-4">
    <!-- Hero Section -->
    <HeroSection LogoMediaId="image-final-logo-fe3f75db" ShowDescription="@(!isAuthenticated)" />
    
    <!-- Active Adventures Section -->
    @if (isAuthenticated && !isLoading && activeSessions.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-info">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-gamepad me-2 text-info"></i>Continue Your Adventures
                        </h5>
                        <div class="row">
                            @foreach (var activeSession in activeSessions)
                            {
                                var scenario = scenarios.FirstOrDefault(s => s.Id == activeSession.ScenarioId);
                                if (scenario != null)
                                {
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100 border-info">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">@scenario.Name</h6>
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-play-circle me-1"></i>In Progress
                                                    </span>
                                                </div>
                                                <p class="card-text small text-muted mb-3">
                                                    Started: @activeSession.StartedAt.ToLocalTime().ToString("g")
                                                </p>
                                                <button class="btn btn-info w-100" 
                                                        @onclick="() => ContinueAdventure(activeSession, scenario)">
                                                    <i class="fas fa-play me-2"></i>
                                                    Continue
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Game Session Content (shown when user has profiles and active game) -->
    @if (isAuthenticated && hasProfiles && gameSession != null)
    {
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-4">
                                <div class="me-4">
                                    <h2 class="text-primary-custom mb-1">
                                        Welcome "@(gameSession.PlayerNames.FirstOrDefault() ?? "Player")"! What adventures await us today?
                                    </h2>
                                </div>
                                <div class="avatar-placeholder">
                                    <CachedMystiraImage 
                                        MediaId="placeholder-avatar-default"
                                        Alt="Player avatar"
                                        Width="60"
                                        Height="60"
                                        ImageClass="thumbnail-image" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <CachedMystiraImage 
                            MediaId="image-final-logo-fe3f75db"
                            Alt="Mystira Logo"
                            Width="120"
                            Height="120" />
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- In-Progress Adventures Section -->
    @if (isAuthenticated && hasProfiles && inProgressSessions.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-warning">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-play-circle me-2"></i>Continue Your Adventures
                        </h6>
                        <div class="row">
                            @foreach (var session in inProgressSessions)
                            {
                                var scenario = scenarios.FirstOrDefault(s => s.Id == session.ScenarioId);
                                if (scenario != null)
                                {
                                    var scenarioProgress = (session.CurrentSceneId != null) ? $"{session.ChoiceCount} choices made" : "Just started";
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100 border-warning">
                                            <div class="card-body d-flex flex-column">
                                                <h5 class="card-title">@scenario.Title</h5>
                                                <p class="card-text small text-muted">@scenarioProgress</p>
                                                <div class="mt-auto">
                                                    <button class="btn btn-warning btn-sm w-100" 
                                                            @onclick="() => StartAdventure(scenario)"
                                                            disabled="@isStartingAdventure">
                                                        <i class="fas fa-redo me-2"></i>
                                                        Resume
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- Filter Section -->
    @if (isAuthenticated && !isLoading)
    {
        <FilterSection 
            AgeGroups="@availableAgeGroups"
            SelectedAgeGroups="@selectedAgeGroups"
            AgeGroupCounts="@_ageGroupBundleCounts"
            SearchQuery="@searchQuery"
            SearchQueryChanged="@((value) => { searchQuery = value; })"
            ShowCompleted="@showCompletedStories"
            ShowCompletedChanged="@((value) => { showCompletedStories = value; ToggleCompletedStories(); })"
            HiddenCount="@completedScenarioIds.Count"
            ResultCount="@GetResultCount()"
            ResultCountLabel="@GetResultCountLabel()"
            OnAgeGroupToggled="@ToggleAgeGroupFilter"
            OnClearAllFilters="@ClearAllFilters"
            OnSearchCleared="@ClearSearch" />

        <!-- Content Bundles Grid -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes-stacked me-2"></i>
                        @if (!string.IsNullOrEmpty(selectedBundleId))
                        {
                            <span>Selected Bundle: @selectedBundleTitle</span>
                        }
                        else
                        {
                            <span>Available Bundles</span>
                        }
                    </h5>
                    @if (!string.IsNullOrEmpty(selectedBundleId))
                    {
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSelectedBundle">
                            <i class="fas fa-arrow-left me-1"></i>Back to Bundles
                        </button>
                    }
                </div>

                @if (isLoadingBundles)
                {
                    <SkeletonLoader Count="6" />
                }
                else if (!filteredBundles.Any())
                {
                    <div class="alert alert-info">No bundles found for the selected filters.</div>
                }
                else if (string.IsNullOrEmpty(selectedBundleId))
                {
                    @* Featured Bundle *@
                    @if (filteredBundles.Any() && GetFeaturedBundle() != null)
                    {
                        var featured = GetFeaturedBundle();
                        if (featured != null)
                        {
                            <FeaturedBundleCard 
                                Bundle="@featured" 
                                CompletedScenarioIds="@completedScenarioIds"
                                ShowGameState="@gameStateLoadingComplete"
                                OnExplore="@((bundle) => SelectBundle(bundle))" />
                        }
                    }
                    
                    @* Regular Bundle Grid *@
                    <div class="row">
                        @foreach (var bundle in filteredBundles.Where(b => b.Id != GetFeaturedBundle()?.Id))
                        {
                            <BundleCard 
                                Bundle="@bundle"
                                CompletedScenarioIds="@completedScenarioIds"
                                ShowGameState="@gameStateLoadingComplete"
                                OnClick="@((b) => SelectBundle(b))" />
                        }
                    </div>
                }
            </div>
        </div>
    }
    
    <style>
        .dice-roller-container {
            max-width: 300px; /* Adjust this value to control the width */
            margin: 0 auto; /* This centers the container horizontally */
            padding: 15px;
            background-color: var(--bs-body-bg, white);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    
    @if (isLoading)
    {
        <div class="row justify-content-center">
            <div class="col-auto text-center">
                <div class="loading-spinner mb-3"></div>
                <p class="text-muted">Loading adventures...</p>
            </div>
        </div>
    }
    else if (!isAuthenticated)
    {
        <div class="row g-4 justify-content-center">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm text-center p-4">
                    <div class="mb-3 text-primary-custom">
                        <i class="fas fa-book-open fa-3x"></i>
                    </div>
                    <h4 class="mb-3">Interactive Adventures</h4>
                    <p class="text-muted mb-0">
                        Dive into guided quests that adapt to every group, helping facilitators lead unforgettable storytelling sessions with ease.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm text-center p-4">
                    <div class="mb-3 text-success">
                        <i class="fas fa-hands-helping fa-3x"></i>
                    </div>
                    <h4 class="mb-3">Built for Teamwork</h4>
                    <p class="text-muted mb-0">
                        Foster empathy, cooperation, and problem-solving with collaborative prompts that keep every child engaged.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm text-center p-4">
                    <div class="mb-3 text-info">
                        <i class="fas fa-magic fa-3x"></i>
                    </div>
                    <h4 class="mb-3">Guided Storytelling</h4>
                    <p class="text-muted mb-0">
                        Use curated visuals, music, and facilitator tips to spark imagination anywhereâ€”from living rooms to after-school clubs.
                    </p>
                </div>
            </div>
        </div>
    }
    else if (hasProfiles && !string.IsNullOrEmpty(selectedBundleId) && filteredScenarios.Any())
    {
        <div class="row">
            @foreach (var scenario in filteredScenarios)
            {
                var isCompleted = completedScenarioIds.Contains(scenario.Id);
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card scenario-card h-100 @(isCompleted ? "border-success" : "")">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">@scenario.Name</h5>
                                @if (isCompleted)
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Completed
                                    </span>
                                }
                            </div>
                            <p class="card-text flex-grow-1">@scenario.Description</p>
                            
                            <div class="mt-auto">
                                <!-- Scenario Metadata -->
                                <div class="scenario-metadata mb-3">
                                    <!-- Group AgeGroup, Difficulty, and Session Length badges in one row -->
                                    <div class="d-flex flex-wrap mb-2">
                                        <span class="badge bg-info text-dark me-1 mb-1">
                                            <i class="fas fa-users me-1"></i>Ages @scenario.AgeGroup
                                        </span>
                                        <span class="badge bg-warning me-1 mb-1">
                                            <i class="fas fa-signal me-1"></i>@scenario.Difficulty
                                        </span>
                                        <span class="badge bg-success me-1 mb-1">
                                            <i class="fas fa-clock me-1"></i>@scenario.SessionLength
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary-custom flex-fill" 
                                            @onclick="() => StartAdventure(scenario)"
                                            disabled="@isStartingAdventure">
                                        @if (isStartingAdventure)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            <span>Loading...</span>
                                        }
                                        else
                                        {
                                            <i class="fas fa-play me-2"></i>
                                            <span>Start Adventure</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (isAuthenticated && hasProfiles && !string.IsNullOrEmpty(selectedBundleId) && !filteredScenarios.Any() && scenarios.Any())
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-search fa-3x text-info mb-3"></i>
                        <h3>No Adventures Match Your Filters</h3>
                        <p class="text-muted mb-4">
                            Try adjusting your age group filters to see more adventures.
                        </p>
                        <button class="btn btn-primary-custom" @onclick="ClearAllFilters">
                            <i class="fas fa-times me-2"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isAuthenticated && hasProfiles && !string.IsNullOrEmpty(selectedBundleId) && !scenarios.Any())
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h3>No Adventures Available</h3>
                        <p class="text-muted mb-4">
                            We couldn't load any adventures right now. This might be due to a connection issue.
                        </p>
                        <button class="btn btn-primary-custom" @onclick="LoadScenarios">
                            <i class="fas fa-refresh me-2"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isAuthenticated && isLoadingProfiles)
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-spinner fa-spin fa-3x text-primary-custom mb-3"></i>
                        <h3>Loading Profiles...</h3>
                        <p class="text-muted">
                            Please wait while we check your profiles
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isAuthenticated && !hasProfiles)
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-user-plus fa-3x text-primary-custom mb-3"></i>
                        <h3>Create a Profile to Start</h3>
                        <p class="text-muted mb-4">
                            Create your first player profile to unlock magical adventures!
                        </p>
                        <a href="/profiles" class="btn btn-primary-custom">
                            <i class="fas fa-user-plus me-2"></i>
                            Create Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isAuthenticated && hasProfiles && string.IsNullOrEmpty(selectedBundleId))
    {
        <!-- Bundles are shown above; no scenarios until a bundle is selected -->
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h3>No Adventures Available</h3>
                        <p class="text-muted mb-4">
                            We couldn't load any adventures right now. This might be due to a connection issue.
                        </p>
                        <button class="btn btn-primary-custom" @onclick="LoadScenarios">
                            <i class="fas fa-refresh me-2"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Scenario> scenarios = new();
    private List<Scenario> filteredScenarios = new();
    private List<ContentBundle> bundles = new();
    private List<ContentBundle> filteredBundles = new();
    private List<GameSession> inProgressSessions = new();
    private bool isLoadingBundles = false;
    private string? selectedBundleId;
    private string selectedBundleTitle => bundles.FirstOrDefault(b => b.Id == selectedBundleId)?.Title ?? string.Empty;
    private bool isLoading = true;
    private bool isStartingAdventure = false;
    private bool isAuthenticated = false;
    private bool showCompletedStories = true;
    private HashSet<string> completedScenarioIds = new();
    private List<GameSession> activeSessions = new();
    private bool isLoadingGameState = false;
    private bool gameStateLoadingComplete = false;
    private bool hasProfiles = false;
    private bool isLoadingProfiles = false;
    private GameSession? gameSession;
    private string _searchQuery = string.Empty;
    private string searchQuery 
    { 
        get => _searchQuery;
        set 
        {
            if (_searchQuery != value)
            {
                _searchQuery = value;
                ApplyFilters();
            }
        }
    }
    
    // Cache for performance optimization
    private Dictionary<string, int> _ageGroupBundleCounts = new();
    private ContentBundle? _cachedFeaturedBundle;
    
    // Age group filter state
    private readonly HashSet<string> selectedAgeGroups = new();
    private readonly string[] availableAgeGroups = { "1-2", "3-5", "6-9", "10-12", "13-18", "19+" };

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            Logger.LogInformation("Home component initializing...");
            
            // Subscribe to authentication state changes
            AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
            
            // Subscribe to game session changes
            GameSessionService.GameSessionChanged += OnGameSessionChanged;
            
            // Check current authentication status
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            
            Logger.LogInformation("Auth service initialized. IsAuthenticated: {IsAuthenticated}", isAuthenticated);
            
            // Load scenarios only if authenticated
            if (isAuthenticated) 
            {
                await LoadBundles();
                await LoadScenarios();
                await LoadProfiles();
                await LoadInProgressSessions();
                // Start loading game state in background
                _ = LoadGameStateAsync();
                // Get current game session
                gameSession = GameSessionService.CurrentGameSession;
            }
            else 
            {
                isLoading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during component initialization");
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnAuthenticationStateChanged(object? sender, bool authenticated)
    {
        isAuthenticated = authenticated;
        InvokeAsync(async () => 
        {
            if (authenticated)
            {
                await LoadBundles();
                await LoadScenarios();
                await LoadProfiles();
                await LoadInProgressSessions();
                _ = LoadGameStateAsync();
                // Get current game session
                gameSession = GameSessionService.CurrentGameSession;
            }
            else 
            {
                scenarios.Clear();
                filteredScenarios.Clear();
                bundles.Clear();
                filteredBundles.Clear();
                inProgressSessions.Clear();
                selectedAgeGroups.Clear();
                completedScenarioIds.Clear();
                activeSessions.Clear();
                gameStateLoadingComplete = false;
                hasProfiles = false;
                gameSession = null;
            }
            StateHasChanged();
        });
    }

    private void OnGameSessionChanged(object? sender, GameSession? session)
    {
        gameSession = session;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (AuthService != null)
        {
            AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
        if (GameSessionService != null)
        {
            GameSessionService.GameSessionChanged -= OnGameSessionChanged;
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            isLoadingProfiles = true;
            StateHasChanged();
            
            var currentAccount = await AuthService.GetCurrentAccountAsync();
            if (currentAccount != null)
            {
                hasProfiles = await ProfileService.HasProfilesAsync(currentAccount.Id);
                Logger.LogInformation("Profile check for account {AccountId}: HasProfiles = {HasProfiles}", currentAccount.Id, hasProfiles);
            }
            else
            {
                hasProfiles = false;
                Logger.LogWarning("No current account found during profile loading");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading profiles");
            hasProfiles = false;
        }
        finally
        {
            isLoadingProfiles = false;
            StateHasChanged();
        }
    }

    private async Task LoadInProgressSessions()
    {
        try
        {
            var currentAccount = await AuthService.GetCurrentAccountAsync();
            if (currentAccount == null)
            {
                inProgressSessions.Clear();
                return;
            }

            Logger.LogInformation("Loading in-progress sessions for account {AccountId}", currentAccount.Id);
            var sessions = await ApiClient.GetInProgressSessionsAsync(currentAccount.Id);
            inProgressSessions = sessions ?? new List<GameSession>();
            Logger.LogInformation("Loaded {Count} in-progress sessions", inProgressSessions.Count);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading in-progress sessions");
            inProgressSessions.Clear();
        }
    }

    private async Task LoadScenarios()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("Loading scenarios...");
            scenarios = await ApiClient.GetScenariosAsync();
            Logger.LogInformation("Loaded {Count} scenarios", scenarios.Count);
            
            // Apply filters after loading scenarios
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scenarios");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadBundles()
    {
        try
        {
            isLoadingBundles = true;
            StateHasChanged();

            Logger.LogInformation("Loading content bundles...");
            bundles = await ApiClient.GetBundlesAsync();
            Logger.LogInformation("Loaded {Count} bundles", bundles.Count);
            
            // Pre-compute age group counts for performance
            UpdateAgeGroupCounts();

            Logger.LogInformation("Loading completed scenarios and active sessions...");
            
            // Get current account
            var account = await AuthService.GetCurrentAccountAsync();
            if (account != null)
            {
                // Get sessions for this account
                var sessions = await ApiClient.GetSessionsByAccountAsync(account.Id);
                if (sessions != null)
                {
                    // Filter active sessions (InProgress or Paused)
                    activeSessions = sessions
                        .Where(s => s.Status == SessionStatus.InProgress.ToString() || s.Status == SessionStatus.Paused.ToString())
                        .OrderByDescending(s => s.StartedAt)
                        .ToList();
                    
                    Logger.LogInformation("Found {Count} active session(s) for account {AccountId}", 
                        activeSessions.Count, account.Id);
                    
                    // Track completed scenarios
                    completedScenarioIds = sessions
                        .Where(s => s.Status == SessionStatus.Completed.ToString())
                        .Select(s => s.ScenarioId)
                        .ToHashSet();
                    
                    Logger.LogInformation("Loaded {Count} completed scenarios for account {AccountId}", 
                        completedScenarioIds.Count, account.Id);
                }
            }
            
            // Apply filters to show/hide completed scenarios
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading bundles and game state");
        }
        finally
        {
            isLoadingBundles = false;
            StateHasChanged();
        }
    }

    private async Task LoadGameStateAsync()
    {
        try
        {
            isLoadingGameState = true;
            StateHasChanged();
            
            var currentAccount = await AuthService.GetCurrentAccountAsync();
            if (currentAccount != null)
            {
                Logger.LogInformation("Loading game state for account {AccountId}", currentAccount.Id);
                
                var gameStateResponse = await ApiClient.GetScenariosWithGameStateAsync(currentAccount.Id);
                if (gameStateResponse != null)
                {
                    completedScenarioIds = new HashSet<string>(
                        gameStateResponse.Scenarios
                            .Where(s => s.GameState == ScenarioGameState.Completed)
                            .Select(s => s.ScenarioId)
                    );
                    Logger.LogInformation("Loaded game state: {CompletedCount} completed scenarios", completedScenarioIds.Count);
                }
                else
                {
                    Logger.LogWarning("Failed to load game state response");
                    completedScenarioIds = new HashSet<string>();
                }
            }
            
            gameStateLoadingComplete = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading game state");
            completedScenarioIds = new HashSet<string>();
            gameStateLoadingComplete = true;
        }
        finally
        {
            isLoadingGameState = false;
            StateHasChanged();
        }
    }

    private async Task StartAdventure(Scenario scenario)
    {
        try
        {
            isStartingAdventure = true;
            StateHasChanged();
            
            Logger.LogInformation("Starting adventure: {ScenarioName}", scenario.Name);
            
            // Check if there's an in-progress session for this scenario
            var inProgressSession = inProgressSessions.FirstOrDefault(s => s.ScenarioId == scenario.Id);
            if (inProgressSession != null)
            {
                Logger.LogInformation("Found in-progress session {SessionId} for scenario {ScenarioId}, resuming it", 
                    inProgressSession.Id, scenario.Id);
                await ResumeInProgressSession(inProgressSession);
                return;
            }
            
            // Clear any existing game session
            GameSessionService.ClearGameSession();
            
            // Check if we should skip character assignment for young age groups
            if (scenario.AgeGroup == "1-2")
            {
                Logger.LogInformation("Skipping character assignment for age group {AgeGroup}, starting game directly", scenario.AgeGroup);
                
                // Get the full scenario with scenes
                var fullScenario = await ApiClient.GetScenarioAsync(scenario.Id);
                if (fullScenario == null)
                {
                    Logger.LogError("Failed to load full scenario details for: {ScenarioName}", scenario.Name);
                    return;
                }
                
                // Start game session directly without character assignment
                var success = await GameSessionService.StartGameSessionAsync(fullScenario);
                if (success)
                {
                    NavigationManager.NavigateTo("/game");
                }
                else
                {
                    Logger.LogError("Failed to start game session directly for scenario: {ScenarioName}", scenario.Name);
                }
            }
            else
            {
                // Navigate to character assignment page
                Logger.LogInformation("Navigating to character assignment for scenario: {ScenarioId}", scenario.Id);
                await Task.CompletedTask;
                NavigationManager.NavigateTo($"/character-assignment/{scenario.Id}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting adventure: {ScenarioName}", scenario.Name);
        }
        finally
        {
            isStartingAdventure = false;
            StateHasChanged();
        }
    }

    private async Task ResumeInProgressSession(GameSession session)
    {
        try
        {
            Logger.LogInformation("Resuming in-progress session {SessionId}", session.Id);
            
            // Get the full scenario with scenes
            var fullScenario = await ApiClient.GetScenarioAsync(session.ScenarioId);
            if (fullScenario == null)
            {
                Logger.LogError("Failed to load scenario for in-progress session: {ScenarioId}", session.ScenarioId);
                return;
            }

            // Find the current scene
            var currentScene = fullScenario.Scenes.FirstOrDefault(s => s.Id == session.CurrentSceneId);
            if (currentScene == null)
            {
                Logger.LogWarning("Current scene not found in scenario, using first scene");
                currentScene = fullScenario.Scenes.FirstOrDefault();
            }

            if (currentScene == null)
            {
                Logger.LogError("No scenes available in scenario");
                return;
            }

            // Load media for the current scene
            currentScene.AudioUrl = !string.IsNullOrEmpty(currentScene.Media?.Audio) ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Audio) : null;
            currentScene.ImageUrl = !string.IsNullOrEmpty(currentScene.Media?.Image) ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Image) : null;
            currentScene.VideoUrl = !string.IsNullOrEmpty(currentScene.Media?.Video) ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Video) : null;

            // Create a game session object for the service
            var localSession = new GameSession
            {
                Id = session.Id,
                Scenario = fullScenario,
                ScenarioId = fullScenario.Id,
                ScenarioName = fullScenario.Title,
                CurrentScene = currentScene,
                StartedAt = session.StartedAt,
                CompletedScenes = new List<Scene>(),
                IsCompleted = false
            };

            GameSessionService.SetCurrentGameSession(localSession);
            NavigationManager.NavigateTo("/game");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resuming in-progress session {SessionId}", session.Id);
        }
    }

    private void ToggleAgeGroupFilter(string ageGroup)
    {
        if (selectedAgeGroups.Contains(ageGroup))
        {
            selectedAgeGroups.Remove(ageGroup);
        }
        else
        {
            selectedAgeGroups.Add(ageGroup);
        }
        
        ApplyFilters();
        StateHasChanged();
    }

    private void ClearAllFilters()
    {
        selectedAgeGroups.Clear();
        ApplyFilters();
        StateHasChanged();
    }

    private void ToggleCompletedStories()
    {
        showCompletedStories = !showCompletedStories;
        ApplyFilters();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        // Filter bundles by selected age groups and search
        var bundleFiltered = bundles.AsEnumerable();
        if (selectedAgeGroups.Any())
        {
            bundleFiltered = bundleFiltered.Where(b => selectedAgeGroups.Contains(b.AgeGroup));
        }
        if (!string.IsNullOrEmpty(searchQuery))
        {
            bundleFiltered = bundleFiltered.Where(b => 
                b.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                b.Description.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
        }
        filteredBundles = bundleFiltered.ToList();
        
        // Invalidate featured bundle cache when filters change
        _cachedFeaturedBundle = null;

        // Filter scenarios, optionally by selected bundle
        var filtered = scenarios.AsEnumerable();
        if (!string.IsNullOrEmpty(selectedBundleId))
        {
            var selected = bundles.FirstOrDefault(b => b.Id == selectedBundleId);
            var ids = selected?.ScenarioIds ?? new List<string>();
            filtered = filtered.Where(s => ids.Contains(s.Id));
        }
        
        // Apply age group filter
        if (selectedAgeGroups.Any())
        {
            filtered = filtered.Where(s => selectedAgeGroups.Contains(s.AgeGroup));
        }
        
        // Apply search filter (optimized)
        if (!string.IsNullOrEmpty(searchQuery))
        {
            var query = searchQuery.ToLowerInvariant();
            filtered = filtered.Where(s => 
                s.Name.ToLowerInvariant().Contains(query) ||
                s.Description.ToLowerInvariant().Contains(query) ||
                (s.Tags != null && s.Tags.Any(t => t.ToLowerInvariant().Contains(query))));
        }
        
        // Apply completed stories filter
        if (!showCompletedStories)
        {
            filtered = filtered.Where(s => !completedScenarioIds.Contains(s.Id));
        }
        
        filteredScenarios = filtered.ToList();
        
        Logger.LogInformation("Applied filters. Age groups: [{SelectedFilters}], Search: '{SearchQuery}', Show completed: {ShowCompleted}, Showing {Count} of {Total} scenarios", 
            string.Join(", ", selectedAgeGroups), searchQuery, showCompletedStories, filteredScenarios.Count, scenarios.Count);
    }

    private async Task ContinueAdventure(GameSession activeSession, Scenario scenario)
    {
        try
        {
            isStartingAdventure = true;
            StateHasChanged();
            
            Logger.LogInformation("Continuing adventure for session: {SessionId}, Scenario: {ScenarioName}", 
                activeSession.Id, scenario.Name);
            
            // Get the full scenario with scenes
            var fullScenario = await ApiClient.GetScenarioAsync(scenario.Id);
            if (fullScenario == null)
            {
                Logger.LogError("Failed to load full scenario details for: {ScenarioName}", scenario.Name);
                return;
            }
            
            // Find the current scene from the session
            var currentScene = fullScenario.Scenes.FirstOrDefault(s => s.Id == activeSession.CurrentSceneId);
            if (currentScene == null)
            {
                Logger.LogError("Could not find current scene {SceneId} in scenario {ScenarioId}", 
                    activeSession.CurrentSceneId, scenario.Id);
                return;
            }
            
            // Load media URLs for the current scene
            currentScene.AudioUrl = !string.IsNullOrEmpty(currentScene.Media?.Audio) 
                ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Audio) : null;
            currentScene.ImageUrl = !string.IsNullOrEmpty(currentScene.Media?.Image) 
                ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Image) : null;
            currentScene.VideoUrl = !string.IsNullOrEmpty(currentScene.Media?.Video) 
                ? await ApiClient.GetMediaUrlFromId(currentScene.Media.Video) : null;
            
            // Create a local game session to resume from
            var localGameSession = new Models.GameSession
            {
                Id = activeSession.Id,
                Scenario = fullScenario,
                ScenarioId = fullScenario.Id,
                ScenarioName = fullScenario.Title,
                CurrentScene = currentScene,
                StartedAt = activeSession.StartedAt,
                CompletedScenes = new List<Scene>(),
                IsCompleted = false
            };
            
            // Set the game session
            GameSessionService.SetCurrentGameSession(localGameSession);
            
            // Navigate to the game page
            NavigationManager.NavigateTo("/game");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error continuing adventure for session: {SessionId}", activeSession.Id);
        }
        finally
        {
            isStartingAdventure = false;
            StateHasChanged();
        }
    }

    private void SelectBundle(ContentBundle bundle)
    {
        selectedBundleId = bundle.Id;
        ApplyFilters();
        StateHasChanged();
    }

    private void ClearSelectedBundle()
    {
        selectedBundleId = null;
        ApplyFilters();
        StateHasChanged();
    }

    private void ClearSearch()
    {
        searchQuery = string.Empty;
        ApplyFilters();
        StateHasChanged();
    }

    private int GetBundleCountForAgeGroup(string ageGroup)
    {
        // Use cached counts for performance
        if (_ageGroupBundleCounts.TryGetValue(ageGroup, out var count))
        {
            return count;
        }
        return 0;
    }
    
    private void UpdateAgeGroupCounts()
    {
        // Pre-compute bundle counts for all age groups
        _ageGroupBundleCounts = availableAgeGroups
            .ToDictionary(
                ageGroup => ageGroup,
                ageGroup => bundles.Count(b => b.AgeGroup == ageGroup)
            );
    }

    private ContentBundle? GetFeaturedBundle()
    {
        // Return cached value if available
        if (_cachedFeaturedBundle != null || !filteredBundles.Any())
        {
            return _cachedFeaturedBundle;
        }
        
        // Compute and cache the featured bundle
        var freeBundle = filteredBundles.FirstOrDefault(b => b.IsFree);
        if (freeBundle != null)
        {
            _cachedFeaturedBundle = freeBundle;
            return _cachedFeaturedBundle;
        }
        
        _cachedFeaturedBundle = filteredBundles
            .OrderByDescending(b => b.ScenarioIds?.Count ?? 0)
            .FirstOrDefault();
            
        return _cachedFeaturedBundle;
    }
    
    private int? GetResultCount()
    {
        if (!string.IsNullOrEmpty(selectedBundleId))
        {
            return filteredScenarios.Count;
        }
        else if (selectedAgeGroups.Any())
        {
            return filteredBundles.Count;
        }
        return null;
    }
    
    private string GetResultCountLabel()
    {
        if (!string.IsNullOrEmpty(selectedBundleId))
        {
            return $"Showing {filteredScenarios.Count} of {scenarios.Count} adventures";
        }
        else if (selectedAgeGroups.Any())
        {
            var pluralSuffix = filteredBundles.Count != 1 ? "s" : "";
            return $"{filteredBundles.Count} bundle{pluralSuffix} match your filters";
        }
        return string.Empty;
    }
}
