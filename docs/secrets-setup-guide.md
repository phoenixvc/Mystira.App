# Secrets Setup Guide

This guide documents all secrets required for deploying and running the Mystira application.

## Overview

Secrets are stored in Azure Key Vault and referenced by the application at runtime. The infrastructure deployment (`main.bicep`) accepts secure parameters that are then stored in Key Vault.

**Key Vault Naming**: `mys-{env}-mystira-kv-san`
- Dev: `mys-dev-mystira-kv-san`
- Staging: `mys-staging-mystira-kv-san`
- Prod: `mys-prod-mystira-kv-san`

## Required Secrets by Category

### JWT Authentication (Required)

These secrets are **required** for the API to function.

| Secret Name | Key Vault Key | Description | How to Generate |
|-------------|---------------|-------------|-----------------|
| `jwtRsaPrivateKey` | `JwtSettings--RsaPrivateKey` | RSA private key (PEM format) for signing JWTs | See [Generating RSA Keys](#generating-rsa-keys) |
| `jwtRsaPublicKey` | `JwtSettings--RsaPublicKey` | RSA public key (PEM format) for verifying JWTs | See [Generating RSA Keys](#generating-rsa-keys) |
| `jwtIssuer` | `JwtSettings--Issuer` | JWT issuer claim | Default: `MystiraAPI` |
| `jwtAudience` | `JwtSettings--Audience` | JWT audience claim | Default: `MystiraPWA` |

#### Generating RSA Keys

```bash
# Generate a 2048-bit RSA private key
openssl genrsa -out private.pem 2048

# Extract the public key
openssl rsa -in private.pem -pubout -out public.pem

# View the private key (copy this for jwtRsaPrivateKey)
cat private.pem

# View the public key (copy this for jwtRsaPublicKey)
cat public.pem
```

### Azure Communication Services (Optional)

For email and messaging functionality.

| Secret Name | Key Vault Key | Description | Where to Find |
|-------------|---------------|-------------|---------------|
| `acsConnectionString` | (App Settings) | ACS connection string | Azure Portal > ACS > Keys |

**Note**: If `skipCommServiceCreation` is `false`, the connection string is automatically generated by the deployment.

### Discord Bot (Optional)

For Discord integration.

| Secret Name | Key Vault Key | Description | Where to Find |
|-------------|---------------|-------------|---------------|
| `discordBotToken` | `Discord--BotToken` | Discord bot authentication token | [Discord Developer Portal](https://discord.com/developers/applications) > Your App > Bot > Token |

#### Setting up Discord Bot

1. Go to [Discord Developer Portal](https://discord.com/developers/applications)
2. Create a new application or select existing
3. Navigate to "Bot" section
4. Click "Reset Token" to generate a new token
5. Copy the token (you won't see it again!)
6. Enable required intents (Message Content, Server Members, etc.)

### Azure Bot Service / Teams (Optional)

For Microsoft Teams integration.

| Secret Name | Key Vault Key | Description | Where to Find |
|-------------|---------------|-------------|---------------|
| `botMicrosoftAppId` | `Bot--MicrosoftAppId` | Azure AD App Registration client ID | Azure Portal > App Registration > Application (client) ID |
| `botMicrosoftAppPassword` | `Bot--MicrosoftAppPassword` | Azure AD App Registration client secret | Azure Portal > App Registration > Certificates & secrets |

#### Setting up Azure Bot

1. Create an App Registration in Azure AD:
   - Go to Azure Portal > Azure Active Directory > App registrations
   - Click "New registration"
   - Name: `Mystira Bot`
   - Supported account types: "Accounts in any organizational directory"
   - Click "Register"
   - Copy the "Application (client) ID" - this is `botMicrosoftAppId`

2. Create a client secret:
   - In the App Registration, go to "Certificates & secrets"
   - Click "New client secret"
   - Set description and expiry
   - Copy the secret value immediately - this is `botMicrosoftAppPassword`

3. Set `deployAzureBot: true` in your parameter file

### WhatsApp Business (Optional)

For WhatsApp integration via Azure Communication Services.

| Secret Name | Key Vault Key | Description | Where to Find |
|-------------|---------------|-------------|---------------|
| `whatsAppChannelRegistrationId` | `WhatsApp--ChannelRegistrationId` | Channel registration ID | Azure Portal > ACS > Channels > WhatsApp |
| `whatsAppBusinessAccountId` | `WhatsApp--BusinessAccountId` | Meta Business Account ID | [Meta Business Suite](https://business.facebook.com/) > Business Settings |
| `whatsAppPhoneNumberId` | `WhatsApp--PhoneNumberId` | WhatsApp phone number ID | Meta Business Suite > Phone Numbers |
| `whatsAppWebhookVerifyToken` | `WhatsApp--WebhookVerifyToken` | Webhook verification token | Generate a random secure string |

#### Setting up WhatsApp Business

**Prerequisites:**
- Meta Business Account (verified)
- Azure Communication Services resource
- Registered WhatsApp Business number

**Steps:**

1. **Meta Business Setup:**
   - Go to [Meta Business Suite](https://business.facebook.com/)
   - Navigate to Business Settings > WhatsApp accounts
   - Note your Business Account ID
   - Go to Phone Numbers section and note the Phone Number ID

2. **Azure Portal Setup:**
   - Go to your ACS resource
   - Navigate to Channels > WhatsApp
   - Connect your Meta Business account
   - Complete the verification process
   - Copy the Channel Registration ID

3. **Generate Webhook Verify Token:**
   ```bash
   # Generate a secure random token
   openssl rand -base64 32
   ```

4. Set `enableWhatsApp: true` in your parameter file

## GitHub Actions Secrets

For CI/CD deployments, configure these secrets in your GitHub repository:

### Required for All Deployments

| Secret Name | Description |
|-------------|-------------|
| `AZURE_CREDENTIALS` | Azure service principal credentials (JSON) |
| `AZURE_SUBSCRIPTION_ID` | Azure subscription ID |

### Environment-Specific Secrets

Configure these in GitHub Environments (dev, staging, prod):

| Secret Name | Description |
|-------------|-------------|
| `JWT_RSA_PRIVATE_KEY` | RSA private key for JWT signing |
| `JWT_RSA_PUBLIC_KEY` | RSA public key for JWT verification |
| `DISCORD_BOT_TOKEN` | Discord bot token (if using Discord) |
| `BOT_MICROSOFT_APP_ID` | Azure Bot app ID (if using Teams) |
| `BOT_MICROSOFT_APP_PASSWORD` | Azure Bot app password (if using Teams) |
| `WHATSAPP_CHANNEL_REG_ID` | WhatsApp channel registration ID |
| `WHATSAPP_BUSINESS_ACCOUNT_ID` | WhatsApp business account ID |
| `WHATSAPP_PHONE_NUMBER_ID` | WhatsApp phone number ID |
| `WHATSAPP_WEBHOOK_VERIFY_TOKEN` | WhatsApp webhook verification token |

### Setting up AZURE_CREDENTIALS

```bash
# Create a service principal with Contributor role
az ad sp create-for-rbac \
  --name "mystira-github-actions" \
  --role contributor \
  --scopes /subscriptions/{subscription-id} \
  --sdk-auth

# Copy the JSON output to the AZURE_CREDENTIALS secret
```

## Deployment Commands

### Deploy with Secrets

```bash
# Dev environment
az deployment group create \
  --resource-group mys-dev-mystira-rg-san \
  --template-file infrastructure/main.bicep \
  --parameters @infrastructure/params.dev.json \
  --parameters jwtRsaPrivateKey="$(cat private.pem)" \
  --parameters jwtRsaPublicKey="$(cat public.pem)" \
  --parameters discordBotToken="your-discord-token"

# Staging environment
az deployment group create \
  --resource-group mys-staging-mystira-rg-san \
  --template-file infrastructure/main.bicep \
  --parameters @infrastructure/params.staging.json \
  --parameters jwtRsaPrivateKey="$(cat private.pem)" \
  --parameters jwtRsaPublicKey="$(cat public.pem)"

# Production environment
az deployment group create \
  --resource-group mys-prod-mystira-rg-san \
  --template-file infrastructure/main.bicep \
  --parameters @infrastructure/params.prod.json \
  --parameters jwtRsaPrivateKey="$(cat private.pem)" \
  --parameters jwtRsaPublicKey="$(cat public.pem)" \
  --parameters discordBotToken="your-discord-token" \
  --parameters botMicrosoftAppId="your-app-id" \
  --parameters botMicrosoftAppPassword="your-app-password" \
  --parameters whatsAppChannelRegistrationId="your-channel-id" \
  --parameters whatsAppBusinessAccountId="your-business-id" \
  --parameters whatsAppPhoneNumberId="your-phone-id" \
  --parameters whatsAppWebhookVerifyToken="your-verify-token"
```

## Key Vault Secret Reference Format

The application accesses secrets via Key Vault references in App Service configuration:

```
@Microsoft.KeyVault(SecretUri=https://mys-{env}-mystira-kv-san.vault.azure.net/secrets/{secret-name}/)
```

## Troubleshooting

### Common Issues

1. **"Access denied to Key Vault"**
   - Ensure the App Service managed identity has "Key Vault Secrets User" role
   - Check that the Key Vault access policy includes the App Service principal ID

2. **"Secret not found"**
   - Verify the secret name matches exactly (case-sensitive)
   - Check if the secret was created during deployment

3. **"Invalid RSA key format"**
   - Ensure the PEM key includes header/footer lines
   - Check for proper newlines in the key

4. **"Bot authentication failed"**
   - Verify the App ID and Password match the Azure AD App Registration
   - Check that the App Registration is in the correct tenant

## Security Best Practices

1. **Rotate secrets regularly** - Especially bot tokens and API keys
2. **Use separate keys per environment** - Never share production keys with dev/staging
3. **Enable Key Vault soft delete** - Prevents accidental permanent deletion
4. **Monitor secret access** - Enable Key Vault diagnostic logging
5. **Limit access** - Use RBAC to restrict who can read/modify secrets
