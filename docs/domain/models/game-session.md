# Game Session Domain Model

## Overview

The `GameSession` domain model represents an active playthrough of a scenario, tracking choices, compass values, echoes, and achievements.

## Class Definition

**Namespace**: `Mystira.App.Domain.Models`

**Location**: `src/Mystira.App.Domain/Models/GameSession.cs`

## Properties

| Property              | Type                                  | Description                                  |
| --------------------- | ------------------------------------- | -------------------------------------------- |
| `Id`                  | `string`                              | Unique identifier for the session            |
| `ScenarioId`          | `string`                              | ID of the scenario being played              |
| `AccountId`           | `string`                              | ID of the account owning the session         |
| `ProfileId`           | `string`                              | ID of the user profile playing               |
| `PlayerNames`         | `List<string>`                        | Names of players (for children, no accounts) |
| `Status`              | `SessionStatus`                       | Current session status                       |
| `CurrentSceneId`      | `string`                              | ID of current scene                          |
| `ChoiceHistory`       | `List<SessionChoice>`                 | History of choices made                      |
| `EchoHistory`         | `List<EchoLog>`                       | History of echoes generated                  |
| `CompassValues`       | `Dictionary<string, CompassTracking>` | Compass values by axis                       |
| `Achievements`        | `List<SessionAchievement>`            | Achievements earned in session               |
| `StartTime`           | `DateTime`                            | When session started                         |
| `EndTime`             | `DateTime?`                           | When session ended (nullable)                |
| `ElapsedTime`         | `TimeSpan`                            | Total elapsed time                           |
| `IsPaused`            | `bool`                                | Whether session is paused                    |
| `PausedAt`            | `DateTime?`                           | When session was paused (nullable)           |
| `SceneCount`          | `int`                                 | Total number of scenes in scenario           |
| `TargetAgeGroupName`  | `string`                              | Target age group name                        |
| `TargetAgeGroup`      | `AgeGroup`                            | Target age group object (convenience)        |
| `SelectedCharacterId` | `string?`                             | Character ID selected for text replacement   |

## Methods

### `GetTotalElapsedTime()`

Calculates total elapsed time including paused time.

**Returns**: `TimeSpan` - Total elapsed time

**Logic**:

- If paused: `ElapsedTime + (Now - PausedAt)`
- If in progress: `ElapsedTime + (Now - StartTime)`
- Otherwise: `ElapsedTime`

## Related Domain Models

### SessionChoice

Represents a choice made in the session.

**Properties**:

- `SceneId` - Scene where choice was made
- `SceneTitle` - Title of scene
- `ChoiceText` - Text of the choice
- `NextScene` - Next scene ID
- `ChosenAt` - When choice was made
- `EchoGenerated` - Echo generated by choice (optional)
- `CompassChange` - Compass change from choice (optional)

### SessionAchievement

Achievement earned during the session.

**Properties**:

- `Id` - Achievement identifier
- `Title` - Achievement title
- `Description` - Achievement description
- `IconName` - Icon name for display
- `Type` - Achievement type
- `CompassAxis` - Compass axis (for compass-based achievements)
- `ThresholdValue` - Threshold value reached
- `EarnedAt` - When achievement was earned
- `IsVisible` - Whether achievement is visible

### CompassTracking

Tracks compass values for an axis.

**Properties**:

- `Axis` - Compass axis name
- `CurrentValue` - Current compass value (-2.0 to 2.0)
- `StartingValue` - Starting compass value
- `History` - History of compass changes
- `LastUpdated` - Last update timestamp

## Enums

### SessionStatus

- `NotStarted` - Session created but not started
- `InProgress` - Active session
- `Paused` - Temporarily paused
- `Completed` - Finished scenario
- `Abandoned` - User abandoned session

### AchievementType

- `CompassThreshold` - Compass axis reached threshold
- `FirstChoice` - First choice made
- `SessionComplete` - Completed scenario
- `EchoRevealed` - Echo revealed
- `ConsistentChoice` - Multiple choices in same direction
- `MoralGrowth` - Positive compass movement

## Use Case Integration

Used in:

- `CreateGameSessionUseCase` - Creates new sessions
- `MakeChoiceUseCase` - Processes choices
- `ProgressSceneUseCase` - Progresses to scenes
- Service methods: `ResumeSessionAsync`, `EndSessionAsync`, `SelectCharacterAsync`

## Repository

Persisted through `IGameSessionRepository`.

## Related Documentation

- [Create Game Session Use Case](../../usecases/gamesessions/create-game-session.md)
- [Make Choice Use Case](../../usecases/gamesessions/make-choice.md)
- [Scenario Domain Model](./scenario.md)
