{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "7327044634459104264"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Environment name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "dev-euw",
      "metadata": {
        "description": "Resource name prefix"
      }
    },
    "jwtSecretKey": {
      "type": "securestring",
      "metadata": {
        "description": "JWT secret key for API authentication"
      }
    },
    "acsConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Communication Services connection string"
      }
    },
    "acsSenderEmail": {
      "type": "string",
      "defaultValue": "donotreply@mystira.app",
      "metadata": {
        "description": "Sender email address for Azure Communication Services"
      }
    },
    "corsAllowedOrigins": {
      "type": "string",
      "defaultValue": "http://localhost:7000,https://localhost:7000,https://mystira.app,https://mango-water-04fdb1c03.3.azurestaticapps.net,https://blue-water-0eab7991e.3.azurestaticapps.net",
      "metadata": {
        "description": "Allowed CORS origins for APIs"
      }
    },
    "skipStorageCreation": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip storage account creation if it already exists"
      }
    },
    "existingStorageConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Connection string for existing storage account (if skipStorageCreation is true)"
      }
    },
    "existingStorageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of existing storage account (if skipStorageCreation is true)"
      }
    },
    "existingStorageResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group where existing storage account is located (if skipStorageCreation is true)"
      }
    },
    "newStorageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Storage account name to create (only used if skipStorageCreation is false)"
      }
    },
    "skipCommServiceCreation": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip Communication Services creation if it already exists"
      }
    },
    "existingCommServiceResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group where existing Communication Service is located (if skipCommServiceCreation is true)"
      }
    },
    "skipCosmosCreation": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip Cosmos DB creation if it already exists"
      }
    },
    "existingCosmosResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group where existing Cosmos DB is located (if skipCosmosCreation is true)"
      }
    },
    "existingCosmosDbAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of existing Cosmos DB account (if skipCosmosCreation is true)"
      }
    },
    "existingCosmosConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Connection string for existing Cosmos DB (if skipCosmosCreation is true)"
      }
    },
    "skipAppServiceCreation": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip App Service creation if they already exist"
      }
    },
    "existingAppServiceResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group where existing App Services are located (if skipAppServiceCreation is true)"
      }
    }
  },
  "variables": {
    "acsConnectionStringToUse": "[if(parameters('skipCommServiceCreation'), parameters('acsConnectionString'), '')]",
    "storageAccountNameToUse": "[if(parameters('skipStorageCreation'), 'placeholder123456789', if(not(equals(parameters('newStorageAccountName'), '')), parameters('newStorageAccountName'), replace(toLower(format('{0}-st-mystira', parameters('resourcePrefix'))), '-', '')))]",
    "storageConnString": "[if(and(parameters('skipStorageCreation'), not(equals(parameters('existingStorageConnectionString'), ''))), parameters('existingStorageConnectionString'), '')]",
    "cosmosConnString": "[if(and(parameters('skipCosmosCreation'), not(equals(parameters('existingCosmosConnectionString'), ''))), parameters('existingCosmosConnectionString'), '')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "log-analytics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "workspaceName": {
            "value": "[format('{0}-log-mystira', parameters('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11174194613217245758"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the workspace"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "metadata": {
                "description": "SKU for the workspace"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Data retention in days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[parameters('workspaceName')]"
            },
            "customerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2022-10-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-insights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[format('{0}-ai-mystira', parameters('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17413815229294713792"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights instance"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "metadata": {
                "description": "Application type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]"
      ]
    },
    {
      "condition": "[not(parameters('skipCommServiceCreation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "communication-services-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "communicationServiceName": {
            "value": "[format('{0}-acs-mystira', parameters('resourcePrefix'))]"
          },
          "emailServiceName": {
            "value": "[format('{0}-email-mystira', parameters('resourcePrefix'))]"
          },
          "domainName": {
            "value": "mystira.app"
          },
          "location": {
            "value": "global"
          },
          "dataLocation": {
            "value": "Europe"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14536589336197053708"
            }
          },
          "parameters": {
            "communicationServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Communication Service"
              }
            },
            "emailServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Email Communication Service"
              }
            },
            "domainName": {
              "type": "string",
              "metadata": {
                "description": "Domain name for email service"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "Location for the resources (Communication Services are global)"
              }
            },
            "dataLocation": {
              "type": "string",
              "defaultValue": "Europe",
              "metadata": {
                "description": "Data location for Communication Services"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('communicationServiceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            {
              "type": "Microsoft.Communication/emailServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('emailServiceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            {
              "type": "Microsoft.Communication/emailServices/domains",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('emailServiceName'), parameters('domainName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "domainManagement": "CustomerManaged",
                "userEngagementTracking": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices', parameters('emailServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Communication/emailServices/domains/senderUsernames",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}/{2}', parameters('emailServiceName'), parameters('domainName'), 'DoNotReply')]",
              "properties": {
                "username": "DoNotReply",
                "displayName": "Mystira"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), parameters('domainName'))]"
              ]
            }
          ],
          "outputs": {
            "communicationServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Communication/communicationServices', parameters('communicationServiceName'))]"
            },
            "communicationServiceName": {
              "type": "string",
              "value": "[parameters('communicationServiceName')]"
            },
            "emailServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Communication/emailServices', parameters('emailServiceName'))]"
            },
            "emailServiceName": {
              "type": "string",
              "value": "[parameters('emailServiceName')]"
            },
            "emailDomainId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), parameters('domainName'))]"
            },
            "emailDomainName": {
              "type": "string",
              "value": "[parameters('domainName')]"
            },
            "senderEmail": {
              "type": "string",
              "value": "[format('DoNotReply@{0}', parameters('domainName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[not(parameters('skipStorageCreation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountNameToUse')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "Standard_LRS"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "709730587905023973"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "Storage account SKU"
              }
            },
            "corsAllowedOrigins": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed CORS origins for blob storage"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": "[if(greater(length(parameters('corsAllowedOrigins')), 0), createArray(createObject('allowedOrigins', parameters('corsAllowedOrigins'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'HEAD'), 'allowedHeaders', createArray('*'), 'exposedHeaders', createArray('*'), 'maxAgeInSeconds', 3600)), createArray())]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'mystira-app-media')]",
              "properties": {
                "publicAccess": "Blob"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageConnectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
            },
            "primaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints]"
            },
            "mediaContainerUrl": {
              "type": "string",
              "value": "[format('{0}mystira-app-media/', reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob)]"
            }
          }
        }
      }
    },
    {
      "condition": "[not(parameters('skipCosmosCreation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "cosmosdb-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDbAccountName": {
            "value": "[format('{0}-cosmos-mystira', parameters('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "databaseName": {
            "value": "MystiraAppDb"
          },
          "serverless": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11170084609584287533"
            }
          },
          "parameters": {
            "cosmosDbAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Cosmos DB account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "databaseName": {
              "type": "string",
              "defaultValue": "MystiraAppDb",
              "metadata": {
                "description": "Database name"
              }
            },
            "serverless": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable serverless mode"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-05-15",
              "name": "[parameters('cosmosDbAccountName')]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "databaseAccountOfferType": "Standard",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "capabilities": "[if(parameters('serverless'), createArray(createObject('name', 'EnableServerless')), createArray())]"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'UserProfiles')]",
              "properties": {
                "resource": {
                  "id": "UserProfiles",
                  "partitionKey": {
                    "paths": [
                      "/accountId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'Accounts')]",
              "properties": {
                "resource": {
                  "id": "Accounts",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'Scenarios')]",
              "properties": {
                "resource": {
                  "id": "Scenarios",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'GameSessions')]",
              "properties": {
                "resource": {
                  "id": "GameSessions",
                  "partitionKey": {
                    "paths": [
                      "/accountId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'ContentBundles')]",
              "properties": {
                "resource": {
                  "id": "ContentBundles",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'PendingSignups')]",
              "properties": {
                "resource": {
                  "id": "PendingSignups",
                  "partitionKey": {
                    "paths": [
                      "/email"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), 'CompassTrackings')]",
              "properties": {
                "resource": {
                  "id": "CompassTrackings",
                  "partitionKey": {
                    "paths": [
                      "/Axis"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosDbAccountName": {
              "type": "string",
              "value": "[parameters('cosmosDbAccountName')]"
            },
            "cosmosDbAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
            },
            "cosmosDbConnectionString": {
              "type": "string",
              "value": "[listConnectionStrings(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2024-05-15').connectionStrings[0].connectionString]"
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2024-05-15').documentEndpoint]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      }
    },
    {
      "condition": "[not(parameters('skipAppServiceCreation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "api-appservice-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServiceName": {
            "value": "[format('{0}-app-mystira-api', parameters('resourcePrefix'))]"
          },
          "appServicePlanName": {
            "value": "[format('{0}-asp-mystira-api', parameters('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "F1"
          },
          "cosmosDbConnectionString": "[if(parameters('skipCosmosCreation'), createObject('value', variables('cosmosConnString')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment'), '2025-04-01').outputs.cosmosDbConnectionString.value))]",
          "storageConnectionString": "[if(parameters('skipStorageCreation'), createObject('value', variables('storageConnString')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageConnectionString.value))]",
          "jwtSecretKey": {
            "value": "[parameters('jwtSecretKey')]"
          },
          "acsConnectionString": {
            "value": "[variables('acsConnectionStringToUse')]"
          },
          "acsSenderEmail": {
            "value": "[parameters('acsSenderEmail')]"
          },
          "corsAllowedOrigins": {
            "value": "[parameters('corsAllowedOrigins')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13391904173256900665"
            }
          },
          "parameters": {
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service"
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "B1",
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "cosmosDbConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Cosmos DB connection string"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Azure Storage connection string"
              }
            },
            "jwtSecretKey": {
              "type": "securestring",
              "metadata": {
                "description": "JWT secret key"
              }
            },
            "acsConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Communication Services connection string"
              }
            },
            "acsSenderEmail": {
              "type": "string",
              "defaultValue": "donotreply@mystira.app",
              "metadata": {
                "description": "Sender email address"
              }
            },
            "corsAllowedOrigins": {
              "type": "string",
              "metadata": {
                "description": "Allowed CORS origins"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]",
                "capacity": 1
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServiceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|9.0",
                  "alwaysOn": "[and(not(equals(parameters('sku'), 'F1')), not(equals(parameters('sku'), 'D1')))]",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "appSettings": [
                    {
                      "name": "ASPNETCORE_ENVIRONMENT",
                      "value": "Development"
                    },
                    {
                      "name": "ConnectionStrings__CosmosDb",
                      "value": "[parameters('cosmosDbConnectionString')]"
                    },
                    {
                      "name": "ConnectionStrings__AzureStorage",
                      "value": "[parameters('storageConnectionString')]"
                    },
                    {
                      "name": "JwtSettings__SecretKey",
                      "value": "[parameters('jwtSecretKey')]"
                    },
                    {
                      "name": "JwtSettings__Issuer",
                      "value": "MystiraAPI"
                    },
                    {
                      "name": "JwtSettings__Audience",
                      "value": "MystiraPWA"
                    },
                    {
                      "name": "AzureCommunicationServices__ConnectionString",
                      "value": "[parameters('acsConnectionString')]"
                    },
                    {
                      "name": "AzureCommunicationServices__SenderEmail",
                      "value": "[parameters('acsSenderEmail')]"
                    },
                    {
                      "name": "CorsSettings__AllowedOrigins",
                      "value": "[parameters('corsAllowedOrigins')]"
                    },
                    {
                      "name": "Azure__BlobStorage__ContainerName",
                      "value": "mystira-app-media"
                    },
                    {
                      "name": "Azure__CosmosDb__DatabaseName",
                      "value": "MystiraAppDb"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_Mode",
                      "value": "recommended"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    }
                  ],
                  "healthCheckPath": "/health"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceName'))]",
              "name": "[format('{0}-diagnostics', parameters('appServiceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceName": {
              "type": "string",
              "value": "[parameters('appServiceName')]"
            },
            "appServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
            },
            "appServiceUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('appServiceName')), '2023-01-01').defaultHostName)]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "condition": "[not(parameters('skipAppServiceCreation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "admin-api-appservice-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServiceName": {
            "value": "[format('{0}-app-mystira-admin-api', parameters('resourcePrefix'))]"
          },
          "appServicePlanName": {
            "value": "[format('{0}-asp-mystira-admin-api', parameters('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "F1"
          },
          "cosmosDbConnectionString": "[if(parameters('skipCosmosCreation'), createObject('value', variables('cosmosConnString')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment'), '2025-04-01').outputs.cosmosDbConnectionString.value))]",
          "storageConnectionString": "[if(parameters('skipStorageCreation'), createObject('value', variables('storageConnString')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageConnectionString.value))]",
          "jwtSecretKey": {
            "value": "[parameters('jwtSecretKey')]"
          },
          "acsConnectionString": {
            "value": "[variables('acsConnectionStringToUse')]"
          },
          "acsSenderEmail": {
            "value": "[parameters('acsSenderEmail')]"
          },
          "corsAllowedOrigins": {
            "value": "[parameters('corsAllowedOrigins')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13391904173256900665"
            }
          },
          "parameters": {
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service"
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "B1",
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "cosmosDbConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Cosmos DB connection string"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Azure Storage connection string"
              }
            },
            "jwtSecretKey": {
              "type": "securestring",
              "metadata": {
                "description": "JWT secret key"
              }
            },
            "acsConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Communication Services connection string"
              }
            },
            "acsSenderEmail": {
              "type": "string",
              "defaultValue": "donotreply@mystira.app",
              "metadata": {
                "description": "Sender email address"
              }
            },
            "corsAllowedOrigins": {
              "type": "string",
              "metadata": {
                "description": "Allowed CORS origins"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]",
                "capacity": 1
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServiceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|9.0",
                  "alwaysOn": "[and(not(equals(parameters('sku'), 'F1')), not(equals(parameters('sku'), 'D1')))]",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "appSettings": [
                    {
                      "name": "ASPNETCORE_ENVIRONMENT",
                      "value": "Development"
                    },
                    {
                      "name": "ConnectionStrings__CosmosDb",
                      "value": "[parameters('cosmosDbConnectionString')]"
                    },
                    {
                      "name": "ConnectionStrings__AzureStorage",
                      "value": "[parameters('storageConnectionString')]"
                    },
                    {
                      "name": "JwtSettings__SecretKey",
                      "value": "[parameters('jwtSecretKey')]"
                    },
                    {
                      "name": "JwtSettings__Issuer",
                      "value": "MystiraAPI"
                    },
                    {
                      "name": "JwtSettings__Audience",
                      "value": "MystiraPWA"
                    },
                    {
                      "name": "AzureCommunicationServices__ConnectionString",
                      "value": "[parameters('acsConnectionString')]"
                    },
                    {
                      "name": "AzureCommunicationServices__SenderEmail",
                      "value": "[parameters('acsSenderEmail')]"
                    },
                    {
                      "name": "CorsSettings__AllowedOrigins",
                      "value": "[parameters('corsAllowedOrigins')]"
                    },
                    {
                      "name": "Azure__BlobStorage__ContainerName",
                      "value": "mystira-app-media"
                    },
                    {
                      "name": "Azure__CosmosDb__DatabaseName",
                      "value": "MystiraAppDb"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_Mode",
                      "value": "recommended"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    }
                  ],
                  "healthCheckPath": "/health"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceName'))]",
              "name": "[format('{0}-diagnostics', parameters('appServiceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 7,
                      "enabled": true
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceName": {
              "type": "string",
              "value": "[parameters('appServiceName')]"
            },
            "appServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
            },
            "appServiceUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('appServiceName')), '2023-01-01').defaultHostName)]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    }
  ],
  "outputs": {
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.instrumentationKey.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
    },
    "communicationServiceId": {
      "type": "string",
      "value": "[if(parameters('skipCommServiceCreation'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingCommServiceResourceGroup')), 'Microsoft.Communication/communicationServices', format('{0}-acs-mystira', parameters('resourcePrefix'))), reference(resourceId('Microsoft.Resources/deployments', 'communication-services-deployment'), '2025-04-01').outputs.communicationServiceId.value)]"
    },
    "emailServiceId": {
      "type": "string",
      "value": "[if(parameters('skipCommServiceCreation'), '', reference(resourceId('Microsoft.Resources/deployments', 'communication-services-deployment'), '2025-04-01').outputs.emailServiceId.value)]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[if(parameters('skipStorageCreation'), parameters('existingStorageAccountName'), reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value)]"
    },
    "storageConnectionString": {
      "type": "string",
      "value": "[if(parameters('skipStorageCreation'), variables('storageConnString'), reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageConnectionString.value)]"
    },
    "cosmosDbAccountName": {
      "type": "string",
      "value": "[if(parameters('skipCosmosCreation'), parameters('existingCosmosDbAccountName'), reference(resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment'), '2025-04-01').outputs.cosmosDbAccountName.value)]"
    },
    "cosmosDbConnectionString": {
      "type": "string",
      "value": "[if(parameters('skipCosmosCreation'), variables('cosmosConnString'), reference(resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment'), '2025-04-01').outputs.cosmosDbConnectionString.value)]"
    },
    "apiAppServiceUrl": {
      "type": "string",
      "value": "[if(parameters('skipAppServiceCreation'), format('https://{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingAppServiceResourceGroup')), 'Microsoft.Web/sites', format('{0}-app-mystira-api', parameters('resourcePrefix'))), '2023-12-01').defaultHostName), reference(resourceId('Microsoft.Resources/deployments', 'api-appservice-deployment'), '2025-04-01').outputs.appServiceUrl.value)]"
    },
    "adminApiAppServiceUrl": {
      "type": "string",
      "value": "[if(parameters('skipAppServiceCreation'), format('https://{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingAppServiceResourceGroup')), 'Microsoft.Web/sites', format('{0}-app-mystira-admin-api', parameters('resourcePrefix'))), '2023-12-01').defaultHostName), reference(resourceId('Microsoft.Resources/deployments', 'admin-api-appservice-deployment'), '2025-04-01').outputs.appServiceUrl.value)]"
    }
  }
}