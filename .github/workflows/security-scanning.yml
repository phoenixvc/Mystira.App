name: Security Scanning

on:
  push:
    branches: [main, dev, staging]
  pull_request:
    branches: [main, dev, staging]
  schedule:
    # Run weekly on Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "9.0.x"

jobs:
  # Secret scanning with gitleaks
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # Dependency vulnerability scanning
  dependency-scanning:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Check for vulnerable packages
        id: vuln-check
        run: |
          echo "## Dependency Vulnerability Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each project for vulnerable packages
          VULNERABLE=false

          for proj in $(find . -name "*.csproj" -not -path "./tests/*"); do
            echo "Checking $proj..."
            RESULT=$(dotnet list "$proj" package --vulnerable --include-transitive 2>&1 || true)

            if echo "$RESULT" | grep -q "has the following vulnerable packages"; then
              VULNERABLE=true
              echo "### âš ï¸ Vulnerable packages in $proj" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$RESULT" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$VULNERABLE" = "true" ]; then
            echo "vulnerable=true" >> $GITHUB_OUTPUT
            echo "::warning::Vulnerable packages detected. Review the workflow summary for details."
          else
            echo "âœ… No vulnerable packages found" >> $GITHUB_STEP_SUMMARY
            echo "vulnerable=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  # CodeQL Analysis (SAST)
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: +security-and-quality

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Install wasm-tools workload
        run: dotnet workload install wasm-tools

      - name: Build for CodeQL
        run: |
          dotnet restore
          dotnet build --no-restore --configuration Release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"

  # Security summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, codeql-analysis]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scanning.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
