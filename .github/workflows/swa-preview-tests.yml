name: SWA Preview - Smoke Tests

on:
  workflow_run:
    workflows: 
      - "PWA CI/CD - Dev Environment"
      - "PWA CI/CD - Staging Environment"
      - "PWA CI/CD - Production Environment"
    types: [completed]
    branches: [dev, staging, main]

permissions:
  contents: read
  pull-requests: write  # Required to read PR comments AND post results
  issues: write         # Required for github.rest.issues.listComments and createComment

jobs:
  wait-for-preview:
    # Only run if the workflow was triggered by a PR and the deployment succeeded
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    name: Wait for SWA Preview Deployment
    timeout-minutes: 15
    outputs:
      preview-url: ${{ steps.get-url.outputs.url }}
    steps:
      - name: Initial delay for SWA comment posting
        run: |
          echo "‚è≥ Waiting 15 seconds for Azure SWA action to post preview URL comment..."
          sleep 15
          echo "‚úÖ Initial delay complete, starting to poll for URL"
      
      - name: Get Preview URL from PR Comments with Retry
        id: get-url
        uses: actions/github-script@v8
        with:
          retries: 5
          retry-exempt-status-codes: 400,401,403,404
          script: |
            const maxAttempts = 10;
            const delayMs = 30000; // 30 seconds between attempts

            // Get PR number from the workflow run that triggered this
            const pullRequests = context.payload.workflow_run.pull_requests;
            if (!pullRequests || pullRequests.length === 0) {
              console.log('‚ùå No pull requests found in workflow_run event');
              core.setOutput('url', '');
              return '';
            }

            const prNumber = pullRequests[0].number;
            console.log(`Looking for SWA preview URL for PR #${prNumber}`);
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}: Looking for SWA preview URL...`);
              
              try {
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                });
                
                // Try multiple patterns to find SWA deployment comment
                const swaComment = comments.data.find(comment => 
                  (comment.user.login === 'github-actions[bot]' || 
                   comment.user.type === 'Bot') &&
                  (comment.body.includes('Azure Static Web Apps') ||
                   comment.body.includes('azurestaticapps.net') ||
                   comment.body.includes('Preview URL'))
                );
                
                if (swaComment) {
                  console.log('Found SWA deployment comment');
                  
                  // Try multiple URL extraction patterns
                  const patterns = [
                    /https:\/\/[^\s<>)"']+\.azurestaticapps\.net[^\s<>)"']*/gi,
                    /Preview URL[:\s]+([^\s<>)"']+\.azurestaticapps\.net[^\s<>)"']*)/i,
                    /\[([^\]]+\.azurestaticapps\.net[^\]]*)\]/i
                  ];
                  
                  for (const pattern of patterns) {
                    const matches = swaComment.body.match(pattern);
                    if (matches) {
                      let url = matches[0];
                      
                      // Clean up URL (remove markdown formatting)
                      url = url.replace(/[\[\]()]/g, '');
                      url = url.replace(/^[:\s]+/, '');
                      
                      // Validate URL format
                      if (url.startsWith('https://') && url.includes('.azurestaticapps.net')) {
                        core.setOutput('url', url);
                        console.log(`‚úÖ Found preview URL: ${url}`);
                        return url;
                      }
                    }
                  }
                  
                  console.log('‚ö†Ô∏è  Found SWA comment but could not extract valid URL');
                  console.log('Comment body:', swaComment.body.substring(0, 200));
                }
                
                if (attempt < maxAttempts) {
                  console.log(`‚è≥ No preview URL found yet. Waiting ${delayMs/1000}s before retry...`);
                  await new Promise(resolve => setTimeout(resolve, delayMs));
                } else {
                  console.log('‚ùå Maximum attempts reached. No preview URL found.');
                  core.setOutput('url', '');
                  return '';
                }
              } catch (error) {
                console.error(`Error on attempt ${attempt}:`, error.message);
                if (attempt === maxAttempts) {
                  throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delayMs));
              }
            }

  smoke-tests:
    runs-on: ubuntu-latest
    needs: wait-for-preview
    if: needs.wait-for-preview.outputs.preview-url != ''
    name: Run SWA Smoke Tests
    timeout-minutes: 10
    env:
      PREVIEW_URL: ${{ needs.wait-for-preview.outputs.preview-url }}
      MAX_RETRIES: 3
      RETRY_DELAY: 10
    
    steps:
      - name: Verify Preview URL
        run: |
          if [ -z "$PREVIEW_URL" ]; then
            echo "‚ùå PREVIEW_URL is empty"
            exit 1
          fi
          echo "‚úÖ Testing URL: $PREVIEW_URL"
      
      - name: Test Home Page Loads
        run: |
          echo "Testing: $PREVIEW_URL"
          
          # Retry logic for home page
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$PREVIEW_URL/")
            
            if [ "$response" = "200" ]; then
              echo "‚úÖ Home page loads successfully (HTTP $response)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è  Home page returned $response"
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚ùå Home page test failed after $MAX_RETRIES attempts"
          exit 1

      - name: Test SPA Routes
        run: |
          # Test key application routes with retry
          routes=("/" "/adventures" "/profile")
          
          for route in "${routes[@]}"; do
            echo "Testing route: $route"
            response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL$route")
            if [ "$response" != "200" ]; then
              echo "‚ùå Route $route returned $response"
              exit 1
            fi
            echo "‚úÖ Route $route works"
          done

      - name: Test Blazor Framework Assets
        run: |
          echo "Testing Blazor WebAssembly assets..."
          
          # Test blazor.boot.json exists
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/_framework/blazor.boot.json")
          if [ "$response" != "200" ]; then
            echo "‚ùå blazor.boot.json not found"
            exit 1
          fi
          echo "‚úÖ blazor.boot.json found"
          
          # Verify it's not cached (should have no-cache header)
          cache_header=$(curl -s -I "$PREVIEW_URL/_framework/blazor.boot.json" | grep -i "cache-control" || echo "")
          if [[ ! "$cache_header" =~ "no-cache" ]]; then
            echo "‚ö†Ô∏è  Warning: blazor.boot.json should have no-cache header"
          else
            echo "‚úÖ blazor.boot.json has correct cache headers"
          fi

      - name: Test Static Asset Caching
        run: |
          echo "Testing static asset cache headers..."
          
          # WASM files should be cached with immutable
          wasm_cache=$(curl -s -I "$PREVIEW_URL/_framework/dotnet.wasm" 2>/dev/null | grep -i "cache-control" || echo "not-found")
          if [[ "$wasm_cache" =~ "immutable" ]]; then
            echo "‚úÖ WASM files have immutable cache headers"
          else
            echo "‚ö†Ô∏è  Warning: WASM files should be cached as immutable"
          fi
          
          # Index.html should NOT be cached
          index_cache=$(curl -s -I "$PREVIEW_URL/" | grep -i "cache-control" || echo "")
          if [[ "$index_cache" =~ "no-cache" ]] || [[ "$index_cache" =~ "no-store" ]]; then
            echo "‚úÖ Index.html has correct no-cache headers"
          else
            echo "‚ö†Ô∏è  Warning: Index.html should not be cached"
          fi

      - name: Test Blazor Environment Header
        run: |
          echo "Testing Blazor environment detection..."
          
          # Check for Blazor-Environment header in response
          env_header=$(curl -s -I "$PREVIEW_URL/" | grep -i "blazor-environment" || echo "")
          
          if [ -n "$env_header" ]; then
            echo "‚úÖ Blazor-Environment header found: $env_header"
          else
            echo "‚ö†Ô∏è  Warning: Blazor-Environment header not found"
          fi

      - name: Test PWA Manifest
        run: |
          echo "Testing PWA manifest..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/manifest.json")
          if [ "$response" != "200" ]; then
            echo "‚ùå manifest.json not found"
            exit 1
          fi
          echo "‚úÖ PWA manifest.json found"

      - name: Test Service Worker
        run: |
          echo "Testing service worker files..."
          
          # Check service-worker.js exists
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/service-worker.js" 2>/dev/null || echo "404")
          if [ "$response" = "200" ]; then
            echo "‚úÖ service-worker.js found"
            
            # Should have no-cache header
            sw_cache=$(curl -s -I "$PREVIEW_URL/service-worker.js" | grep -i "cache-control" || echo "")
            if [[ "$sw_cache" =~ "no-cache" ]]; then
              echo "‚úÖ Service worker has correct no-cache header"
            else
              echo "‚ö†Ô∏è  Warning: Service worker should not be cached"
            fi
          else
            echo "‚ÑπÔ∏è  Service worker not found (may not be published yet)"
          fi

      - name: Test Version Info
        run: |
          echo "Testing version.json..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/version.json")
          if [ "$response" != "200" ]; then
            echo "‚ùå version.json not found"
            exit 1
          fi
          
          # Get version info
          version_info=$(curl -s "$PREVIEW_URL/version.json")
          echo "‚úÖ Version info: $version_info"

      - name: Test Security Headers
        run: |
          echo "Testing security headers..."
          
          headers=$(curl -s -I "$PREVIEW_URL/")
          
          # Check for common security headers
          if [[ "$headers" =~ "x-content-type-options" ]]; then
            echo "‚úÖ X-Content-Type-Options header present"
          else
            echo "‚ö†Ô∏è  Warning: X-Content-Type-Options header missing"
          fi
          
          if [[ "$headers" =~ "x-frame-options" ]]; then
            echo "‚úÖ X-Frame-Options header present"
          else
            echo "‚ö†Ô∏è  Warning: X-Frame-Options header missing"
          fi

      - name: Test MIME Types
        run: |
          echo "Testing MIME types for WebAssembly..."
          
          # .wasm files should have correct MIME type
          wasm_mime=$(curl -s -I "$PREVIEW_URL/_framework/dotnet.wasm" 2>/dev/null | grep -i "content-type" || echo "not-found")
          
          if [[ "$wasm_mime" =~ "application/wasm" ]]; then
            echo "‚úÖ WASM files have correct MIME type"
          else
            echo "‚ö†Ô∏è  Warning: WASM MIME type may be incorrect: $wasm_mime"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "================================"
          echo "SWA Preview Smoke Tests Complete"
          echo "================================"
          echo "Preview URL: $PREVIEW_URL"
          echo ""
          echo "Next steps:"
          echo "1. Manually test the preview URL in your browser"
          echo "2. Verify auth flows work (if applicable)"
          echo "3. Test PWA offline functionality"
          echo "4. Check browser console for errors"

  comment-results:
    runs-on: ubuntu-latest
    needs: [wait-for-preview, smoke-tests]
    if: always()
    name: Post Results to PR
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const success = '${{ needs.smoke-tests.result }}' === 'success';
            const previewUrl = '${{ needs.wait-for-preview.outputs.preview-url }}';

            // Get PR number from the workflow run that triggered this
            const pullRequests = context.payload.workflow_run.pull_requests;
            if (!pullRequests || pullRequests.length === 0) {
              console.log('No pull requests found, skipping comment');
              return;
            }

            const prNumber = pullRequests[0].number;
            
            const icon = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'passed' : 'failed';
            
            let body = `## ${icon} SWA Preview Smoke Tests ${status}\n\n`;
            
            if (previewUrl) {
              body += `**Preview URL**: ${previewUrl}\n\n`;
            }
            
            if (success) {
              body += `### ‚úÖ All smoke tests passed!\n\n`;
              body += `**Manual Testing Checklist**:\n`;
              body += `- [ ] Test auth flows (if applicable)\n`;
              body += `- [ ] Test PWA offline mode\n`;
              body += `- [ ] Verify service worker updates\n`;
              body += `- [ ] Check browser console for errors\n`;
            } else {
              body += `### ‚ùå Some smoke tests failed\n\n`;
              body += `Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n`;
            }
            
            body += `\n---\n`;
            body += `üí° **Tip**: These automated tests validate SWA-specific behaviors (routing, caching, headers) that differ from App Service.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
