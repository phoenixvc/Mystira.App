name: Infrastructure Deploy - Production

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        type: choice
        options:
          - validate
          - preview
          - deploy
  push:
    tags:
      - 'v*.*.*'
  pull_request:
    paths:
      - 'infrastructure/**'
    branches:
      - main

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  ENVIRONMENT: 'prod'
  LOCATION: 'southafricanorth'
  RESOURCE_GROUP: 'mys-prod-mystira-rg-san'
  SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Check Required Secrets
    outputs:
      has-azure-secrets: ${{ steps.check.outputs.has-azure-secrets }}
      has-jwt-secrets: ${{ steps.check.outputs.has-jwt-secrets }}
    steps:
      - name: Check secrets availability
        id: check
        run: |
          echo "has-azure-secrets=${{ secrets.AZURE_CREDENTIALS != '' }}" >> $GITHUB_OUTPUT
          echo "has-jwt-secrets=${{ secrets.JWT_RSA_PRIVATE_KEY != '' && secrets.JWT_RSA_PUBLIC_KEY != '' }}" >> $GITHUB_OUTPUT

  validate:
    if: |
      github.event.inputs.action == 'validate' &&
      needs.check-secrets.outputs.has-azure-secrets == 'true' &&
      needs.check-secrets.outputs.has-jwt-secrets == 'true'
    runs-on: ubuntu-latest
    needs: [check-secrets]
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set Azure Subscription
      run: az account set --subscription "${{ env.SUBSCRIPTION_ID }}"

    - name: Lint Bicep Templates
      run: |
        # Build all Bicep files to check for syntax errors
        az bicep build --file './infrastructure/main.bicep'
        echo "Bicep linting passed"

    - name: Validate Bicep Templates
      run: |
        az deployment group validate \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --template-file './infrastructure/main.bicep' \
          --parameters '@./infrastructure/params.prod.json' \
          --parameters jwtRsaPrivateKey=dummy jwtRsaPublicKey=dummy \
          --output json

  preview:
    if: |
      (github.event.inputs.action == 'preview' || github.event_name == 'pull_request') &&
      needs.check-secrets.outputs.has-azure-secrets == 'true' &&
      needs.check-secrets.outputs.has-jwt-secrets == 'true'
    runs-on: ubuntu-latest
    needs: [check-secrets]
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set Azure Subscription
      run: az account set --subscription "${{ env.SUBSCRIPTION_ID }}"

    - name: Create Resource Group if not exists
      run: |
        az group create \
          --name "${{ env.RESOURCE_GROUP }}" \
          --location "${{ env.LOCATION }}" \
          --output none || true

    - name: Preview Infrastructure Changes (What-If)
      id: whatif
      run: |
        az deployment group what-if \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --template-file './infrastructure/main.bicep' \
          --parameters '@./infrastructure/params.prod.json' \
          --parameters jwtRsaPrivateKey="${{ secrets.JWT_RSA_PRIVATE_KEY }}" jwtRsaPublicKey="${{ secrets.JWT_RSA_PUBLIC_KEY }}" \
          --output json > what-if-output.json
        cat what-if-output.json

    - name: Comment PR with What-If Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const whatIfOutput = fs.readFileSync('what-if-output.json', 'utf8');
          const output = `#### Infrastructure What-If Analysis - Production

          <details><summary>Show What-If Results</summary>

          \`\`\`json
          ${whatIfOutput}
          \`\`\`

          </details>

          *Workflow: \`${{ github.workflow }}\`, Run: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  preview-skip:
    runs-on: ubuntu-latest
    needs: [check-secrets]
    name: Preview Skipped - Missing Secrets
    if: |
      ((github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'preview') ||
       github.event_name == 'pull_request') &&
      (needs.check-secrets.outputs.has-azure-secrets != 'true' ||
       needs.check-secrets.outputs.has-jwt-secrets != 'true')
    steps:
      - name: Comment PR about missing secrets
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Infrastructure What-If Analysis - Production

            **Preview skipped**: Required secrets are not configured.

            Please configure the following secrets:
            - \`AZURE_CREDENTIALS\` ${{ needs.check-secrets.outputs.has-azure-secrets == 'true' && '✅' || '❌' }}
            - \`JWT_RSA_PRIVATE_KEY\` and \`JWT_RSA_PUBLIC_KEY\` ${{ needs.check-secrets.outputs.has-jwt-secrets == 'true' && '✅' || '❌' }}

            *Workflow: \`${{ github.workflow }}\`, Run: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Log missing secrets
        run: |
          echo "::warning::Infrastructure preview skipped due to missing secrets"
          echo "Required secrets status:"
          echo "  AZURE_CREDENTIALS: ${{ needs.check-secrets.outputs.has-azure-secrets }}"
          echo "  JWT_RSA_PRIVATE_KEY + JWT_RSA_PUBLIC_KEY: ${{ needs.check-secrets.outputs.has-jwt-secrets }}"

  deploy:
    if: |
      (github.event.inputs.action == 'deploy' || startsWith(github.ref, 'refs/tags/v')) &&
      needs.check-secrets.outputs.has-azure-secrets == 'true' &&
      needs.check-secrets.outputs.has-jwt-secrets == 'true'
    runs-on: ubuntu-latest
    needs: [check-secrets]
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set Azure Subscription
      run: az account set --subscription "${{ env.SUBSCRIPTION_ID }}"

    - name: Create Resource Group if not exists
      run: |
        az group create \
          --name "${{ env.RESOURCE_GROUP }}" \
          --location "${{ env.LOCATION }}" \
          --output none || true

    - name: Deploy Infrastructure (Incremental - Safe Mode)
      id: deploy
      run: |
        # Using --mode Incremental to prevent accidental resource deletion
        # Production deployments require manual approval via GitHub environment
        az deployment group create \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --template-file './infrastructure/main.bicep' \
          --parameters '@./infrastructure/params.prod.json' \
          --parameters jwtRsaPrivateKey="${{ secrets.JWT_RSA_PRIVATE_KEY }}" jwtRsaPublicKey="${{ secrets.JWT_RSA_PUBLIC_KEY }}" \
          --mode Incremental \
          --name "mys-prod-mystira-$(date +%Y%m%d-%H%M%S)" \
          --output json

    - name: Get Deployment Outputs
      id: outputs
      run: |
        APP_SERVICE_URL=$(az deployment group show \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --name "$(az deployment group list --resource-group ${{ env.RESOURCE_GROUP }} --query '[0].name' -o tsv)" \
          --query "properties.outputs.appServiceUrl.value" -o tsv)
        echo "appServiceUrl=$APP_SERVICE_URL" >> $GITHUB_OUTPUT

    - name: Verify and Fix SSL Certificates
      run: |
        echo "Verifying SSL certificate bindings..."

        # Define the apps and their custom domains
        declare -A APPS=(
          ["mys-prod-mystira-api-san"]="api.mystira.app"
          ["mys-prod-mystira-adminapi-san"]="admin.mystira.app"
        )

        for APP_NAME in "${!APPS[@]}"; do
          CUSTOM_DOMAIN="${APPS[$APP_NAME]}"
          echo "Checking $APP_NAME for domain $CUSTOM_DOMAIN..."

          # Check if hostname binding exists with SSL
          SSL_STATE=$(az webapp config hostname list \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --webapp-name "$APP_NAME" \
            --query "[?name=='$CUSTOM_DOMAIN'].sslState" -o tsv 2>/dev/null || echo "")

          if [ "$SSL_STATE" != "SniEnabled" ]; then
            echo "SSL not enabled for $CUSTOM_DOMAIN on $APP_NAME. Fixing..."

            # Get the App Service Plan ID
            ASP_ID=$(az webapp show \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --name "$APP_NAME" \
              --query "appServicePlanId" -o tsv)

            # Check if managed certificate exists
            CERT_THUMBPRINT=$(az webapp config ssl list \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query "[?subjectName=='$CUSTOM_DOMAIN'].thumbprint" -o tsv 2>/dev/null || echo "")

            if [ -z "$CERT_THUMBPRINT" ]; then
              echo "Creating managed certificate for $CUSTOM_DOMAIN..."

              # Create managed certificate (this waits for provisioning)
              az webapp config ssl create \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --name "$APP_NAME" \
                --hostname "$CUSTOM_DOMAIN" \
                --output none

              # Get the new certificate thumbprint
              CERT_THUMBPRINT=$(az webapp config ssl list \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --query "[?subjectName=='$CUSTOM_DOMAIN'].thumbprint" -o tsv)
            fi

            if [ -n "$CERT_THUMBPRINT" ]; then
              echo "Binding certificate to $CUSTOM_DOMAIN..."
              az webapp config ssl bind \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --name "$APP_NAME" \
                --certificate-thumbprint "$CERT_THUMBPRINT" \
                --ssl-type SNI \
                --output none
              echo "SSL binding complete for $CUSTOM_DOMAIN"
            else
              echo "::warning::Failed to provision certificate for $CUSTOM_DOMAIN"
            fi
          else
            echo "SSL already enabled for $CUSTOM_DOMAIN"
          fi
        done

        echo "Certificate verification complete!"

    - name: Deployment Summary
      run: |
        echo "Infrastructure deployed successfully!"
        echo "Resource Group: ${{ env.RESOURCE_GROUP }}"
        echo "App Service URL: ${{ steps.outputs.outputs.appServiceUrl }}"
        echo ""
        echo "Custom Domains:"
        echo "  - https://api.mystira.app"
        echo "  - https://admin.mystira.app"
