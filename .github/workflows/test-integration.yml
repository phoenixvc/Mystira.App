name: "[Test] Integration"

# Infrastructure integration tests
# Layer 2 of 7-layer validation stack: Integration Tests

on:
  pull_request:
    branches: [main, dev, staging]
    types: [opened, synchronize, reopened]
    paths:
      - "src/Mystira.App.Infrastructure.*/**"
      - "tests/Mystira.App.Infrastructure.*.Tests/**"
      - ".github/workflows/test-integration.yml"
  push:
    branches: [main, dev]
    paths:
      - "src/Mystira.App.Infrastructure.*/**"
      - "tests/Mystira.App.Infrastructure.*.Tests/**"
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to test (all, Discord, Teams, WhatsApp, Payments, Data)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - Discord
          - Teams
          - WhatsApp
          - Payments
          - Data

permissions:
  contents: read
  packages: read
  pull-requests: write

concurrency:
  group: test-integration-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    name: Detect Changed Components
    outputs:
      discord: ${{ steps.changes.outputs.discord }}
      teams: ${{ steps.changes.outputs.teams }}
      whatsapp: ${{ steps.changes.outputs.whatsapp }}
      payments: ${{ steps.changes.outputs.payments }}
      data: ${{ steps.changes.outputs.data }}
      any_changes: ${{ steps.changes.outputs.any_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          # Manual override
          COMPONENT="${{ inputs.component }}"
          if [ -n "$COMPONENT" ] && [ "$COMPONENT" != "all" ]; then
            case "$COMPONENT" in
              Discord)  echo "discord=true" >> $GITHUB_OUTPUT ;;
              Teams)    echo "teams=true" >> $GITHUB_OUTPUT ;;
              WhatsApp) echo "whatsapp=true" >> $GITHUB_OUTPUT ;;
              Payments) echo "payments=true" >> $GITHUB_OUTPUT ;;
              Data)     echo "data=true" >> $GITHUB_OUTPUT ;;
            esac
            echo "any_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto-detect changes
          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before || 'HEAD~1' }}"

          # Check each infrastructure module
          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure.Discord"; then
            echo "discord=true" >> $GITHUB_OUTPUT
          else
            echo "discord=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure.Teams"; then
            echo "teams=true" >> $GITHUB_OUTPUT
          else
            echo "teams=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure.WhatsApp"; then
            echo "whatsapp=true" >> $GITHUB_OUTPUT
          else
            echo "whatsapp=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure.Payments"; then
            echo "payments=true" >> $GITHUB_OUTPUT
          else
            echo "payments=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure.Data"; then
            echo "data=true" >> $GITHUB_OUTPUT
          else
            echo "data=false" >> $GITHUB_OUTPUT
          fi

          # Check if any changes detected
          if git diff --name-only "$BASE_SHA" HEAD | grep -q "Infrastructure"; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
          fi

  integration-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changes == 'true' || inputs.component == 'all'
    name: Integration Tests - ${{ matrix.component.name }}
    env:
      GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

    strategy:
      fail-fast: false
      matrix:
        component:
          - name: "Discord"
            path: "tests/Mystira.App.Infrastructure.Discord.Tests"
            condition: "discord"
          - name: "Teams"
            path: "tests/Mystira.App.Infrastructure.Teams.Tests"
            condition: "teams"
          - name: "WhatsApp"
            path: "tests/Mystira.App.Infrastructure.WhatsApp.Tests"
            condition: "whatsapp"
          - name: "Payments"
            path: "tests/Mystira.App.Infrastructure.Payments.Tests"
            condition: "payments"
          - name: "Data"
            path: "tests/Mystira.App.Infrastructure.Data.Tests"
            condition: "data"

    steps:
      - name: Check if should run
        id: should-run
        run: |
          COMPONENT="${{ inputs.component }}"
          CONDITION="${{ matrix.component.condition }}"

          # Run all if 'all' selected or this component specifically selected
          if [ "$COMPONENT" = "all" ] || [ "$COMPONENT" = "${{ matrix.component.name }}" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check auto-detected changes
          case "$CONDITION" in
            discord)  CHANGED="${{ needs.detect-changes.outputs.discord }}" ;;
            teams)    CHANGED="${{ needs.detect-changes.outputs.teams }}" ;;
            whatsapp) CHANGED="${{ needs.detect-changes.outputs.whatsapp }}" ;;
            payments) CHANGED="${{ needs.detect-changes.outputs.payments }}" ;;
            data)     CHANGED="${{ needs.detect-changes.outputs.data }}" ;;
            *)        CHANGED="false" ;;
          esac

          echo "run=$CHANGED" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v6

      - name: Setup .NET
        if: steps.should-run.outputs.run == 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        if: steps.should-run.outputs.run == 'true'
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore dependencies
        if: steps.should-run.outputs.run == 'true'
        run: dotnet restore ${{ matrix.component.path }}

      - name: Build test project
        if: steps.should-run.outputs.run == 'true'
        run: dotnet build ${{ matrix.component.path }} --no-restore --configuration Release

      - name: Run integration tests
        if: steps.should-run.outputs.run == 'true'
        run: |
          dotnet test ${{ matrix.component.path }} \
            --no-build \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage/${{ matrix.component.name }} \
            --settings coverlet.runsettings \
            --logger "trx;LogFileName=${{ matrix.component.name }}-results.trx" \
            --verbosity normal

      - name: Upload test results
        if: always() && steps.should-run.outputs.run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: integration-results-${{ matrix.component.name }}
          path: ./coverage/${{ matrix.component.name }}/**/*.trx
          retention-days: 14

      - name: Upload coverage report
        if: steps.should-run.outputs.run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: integration-coverage-${{ matrix.component.name }}
          path: ./coverage/${{ matrix.component.name }}/**/coverage.cobertura.xml
          retention-days: 14

  summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, integration-tests]
    if: always()
    name: Integration Test Summary

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          pattern: integration-results-*
          path: ./test-results
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer 2 of 7**: Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Report component statuses
          DISCORD="${{ needs.detect-changes.outputs.discord }}"
          TEAMS="${{ needs.detect-changes.outputs.teams }}"
          WHATSAPP="${{ needs.detect-changes.outputs.whatsapp }}"
          PAYMENTS="${{ needs.detect-changes.outputs.payments }}"
          DATA="${{ needs.detect-changes.outputs.data }}"
          RESULT="${{ needs.integration-tests.result }}"

          if [ "$DISCORD" = "true" ]; then
            echo "| Discord | $RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Discord | skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TEAMS" = "true" ]; then
            echo "| Teams | $RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Teams | skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$WHATSAPP" = "true" ]; then
            echo "| WhatsApp | $RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| WhatsApp | skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PAYMENTS" = "true" ]; then
            echo "| Payments | $RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Payments | skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DATA" = "true" ]; then
            echo "| Data | $RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Data | skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure integrations tested: Discord, Teams, WhatsApp, Payments, Data" >> $GITHUB_STEP_SUMMARY
