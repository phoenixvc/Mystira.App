name: Publish Shared Packages

on:
  push:
    branches: [main]
    paths:
      - "src/Mystira.App.Domain/**"
      - "src/Mystira.App.Application/**"
      - "src/Mystira.App.Contracts/**"
      - "src/Mystira.App.Infrastructure.Azure/**"
      - "src/Mystira.App.Infrastructure.Data/**"
      - "src/Mystira.App.Infrastructure.Discord/**"
      - "src/Mystira.App.Infrastructure.StoryProtocol/**"
      - "src/Mystira.App.Shared/**"
      - ".github/workflows/publish-shared-packages.yml"
  workflow_dispatch:

concurrency:
  group: publish-shared-packages
  cancel-in-progress: false

env:
  NUGET_FEED_URL: "https://pkgs.dev.azure.com/${{ secrets.AZURE_ORG }}/${{ secrets.AZURE_PROJECT }}/_packaging/${{ secrets.NUGET_FEED }}/nuget/v3/index.json"
  NUGET_FEED_NAME: "Mystira-Internal"

jobs:
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.changes.outputs.domain }}
      application: ${{ steps.changes.outputs.application }}
      contracts: ${{ steps.changes.outputs.contracts }}
      infrastructure-azure: ${{ steps.changes.outputs.infrastructure-azure }}
      infrastructure-data: ${{ steps.changes.outputs.infrastructure-data }}
      infrastructure-discord: ${{ steps.changes.outputs.infrastructure-discord }}
      infrastructure-storyprotocol: ${{ steps.changes.outputs.infrastructure-storyprotocol }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            domain:
              - "src/Mystira.App.Domain/**"
            application:
              - "src/Mystira.App.Application/**"
            contracts:
              - "src/Mystira.App.Contracts/**"
            infrastructure-azure:
              - "src/Mystira.App.Infrastructure.Azure/**"
            infrastructure-data:
              - "src/Mystira.App.Infrastructure.Data/**"
            infrastructure-discord:
              - "src/Mystira.App.Infrastructure.Discord/**"
            infrastructure-storyprotocol:
              - "src/Mystira.App.Infrastructure.StoryProtocol/**"
            shared:
              - "src/Mystira.App.Shared/**"

  publish-domain:
    name: Publish Mystira.App.Domain
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.domain == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Domain/Mystira.App.Domain.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Domain/Mystira.App.Domain.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Domain/Mystira.App.Domain.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-application:
    name: Publish Mystira.App.Application
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.application == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Application/Mystira.App.Application.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Application/Mystira.App.Application.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Application/Mystira.App.Application.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-contracts:
    name: Publish Mystira.App.Contracts
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Contracts/Mystira.App.Contracts.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Contracts/Mystira.App.Contracts.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Contracts/Mystira.App.Contracts.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-infrastructure-azure:
    name: Publish Mystira.App.Infrastructure.Azure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-azure == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Infrastructure.Azure/Mystira.App.Infrastructure.Azure.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Infrastructure.Azure/Mystira.App.Infrastructure.Azure.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Infrastructure.Azure/Mystira.App.Infrastructure.Azure.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-infrastructure-data:
    name: Publish Mystira.App.Infrastructure.Data
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-data == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Infrastructure.Data/Mystira.App.Infrastructure.Data.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Infrastructure.Data/Mystira.App.Infrastructure.Data.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Infrastructure.Data/Mystira.App.Infrastructure.Data.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-infrastructure-discord:
    name: Publish Mystira.App.Infrastructure.Discord
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-discord == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Infrastructure.Discord/Mystira.App.Infrastructure.Discord.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Infrastructure.Discord/Mystira.App.Infrastructure.Discord.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Infrastructure.Discord/Mystira.App.Infrastructure.Discord.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-infrastructure-storyprotocol:
    name: Publish Mystira.App.Infrastructure.StoryProtocol
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-storyprotocol == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"
      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text
      - name: Restore Dependencies
        run: dotnet restore src/Mystira.App.Infrastructure.StoryProtocol/Mystira.App.Infrastructure.StoryProtocol.csproj
      - name: Build Package
        run: dotnet build src/Mystira.App.Infrastructure.StoryProtocol/Mystira.App.Infrastructure.StoryProtocol.csproj --configuration Release --no-restore
      - name: Pack Package
        run: dotnet pack src/Mystira.App.Infrastructure.StoryProtocol/Mystira.App.Infrastructure.StoryProtocol.csproj --configuration Release --no-build --output ./nupkg
      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate

  publish-shared:
    name: Publish Mystira.App.Shared
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.shared == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          nuget-version: "6.x"

      - name: Configure NuGet Feed
        run: |
          dotnet nuget add source ${{ env.NUGET_FEED_URL }} \
            --name "${{ env.NUGET_FEED_NAME }}" \
            --username "${{ secrets.AZURE_USER }}" \
            --password "${{ secrets.AZURE_PAT }}" \
            --store-password-in-clear-text

      - name: Restore Dependencies
        run: dotnet restore ${{ matrix.package.path }}

      - name: Build Package
        run: dotnet build ${{ matrix.package.path }} --configuration Release --no-restore

      - name: Pack Package
        run: dotnet pack ${{ matrix.package.path }} --configuration Release --no-build --output ./nupkg

      - name: Publish to NuGet Feed
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source "${{ env.NUGET_FEED_NAME }}" \
            --api-key "${{ secrets.AZURE_PAT }}" \
            --skip-duplicate
        continue-on-error: true

      - name: Create Git Tag (if new version)
        if: success()
        run: |
          VERSION=$(dotnet nbgv get-version -p ${{ matrix.package.path }} 2>/dev/null || grep -oP '(?<=<Version>)[^<]+' ${{ matrix.package.path }} | head -1 || echo "unknown")
          if [ "$VERSION" != "unknown" ]; then
            TAG="${{ matrix.package.name }}-v${VERSION}"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release ${{ matrix.package.name }} version ${VERSION}" || true
            git push origin "$TAG" || true
          fi

  summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, publish-packages]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Shared Packages Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Packages:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.domain }}" == "true" ]; then echo "- ✅ Mystira.App.Domain" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.application }}" == "true" ]; then echo "- ✅ Mystira.App.Application" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.contracts }}" == "true" ]; then echo "- ✅ Mystira.App.Contracts" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.infrastructure-azure }}" == "true" ]; then echo "- ✅ Mystira.App.Infrastructure.Azure" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.infrastructure-data }}" == "true" ]; then echo "- ✅ Mystira.App.Infrastructure.Data" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.infrastructure-discord }}" == "true" ]; then echo "- ✅ Mystira.App.Infrastructure.Discord" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.infrastructure-storyprotocol }}" == "true" ]; then echo "- ✅ Mystira.App.Infrastructure.StoryProtocol" >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.detect-changes.outputs.shared }}" == "true" ]; then echo "- ✅ Mystira.App.Shared" >> $GITHUB_STEP_SUMMARY; fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Publish Status:** ${{ needs.publish-packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Packages published to: ${{ env.NUGET_FEED_URL }}" >> $GITHUB_STEP_SUMMARY
